** Org Mode
:properties:
:CUSTOM_ID: org
:header-args:emacs-lisp: :tangle no :noweb-ref org-conf
:end:

å› ä¸ºè¿™éƒ¨åˆ†åˆå§‹åŒ–æ—¶ç›¸å½“è´¹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ”¾åœ¨ src_elisp{(after! ...)} ä¸­ã€‚
#+begin_src emacs-lisp :noweb no-export :tangle yes :noweb-prefix no :noweb-ref nil
(after! org
  <<org-conf>>
  )
#+end_src

*** åŠŸèƒ½å¢å¼º

#+begin_src emacs-lisp
(setq! org-use-property-inheritance t         ; it's convenient to have properties inherited
       org-log-done 'time                     ; having the time a item is done sounds convenient
       org-list-allow-alphabetical t          ; have a. A. a) A) list bullets
       ;; org-export-in-background t             ; run export processes in external emacs process
       org-catch-invisible-edits 'smart       ; try not to accidently do weird stuff in invisible regions
       org-export-with-sub-superscripts '{}   ; don't treat lone _ / ^ as sub/superscripts, require _{} / ^{}
       org-export-allow-bind-keywords t       ; Bind keywords can be handy
       org-image-actual-width '(0.9)          ; Make the in-buffer display closer to the exported result..
       )
#+end_src

I also like the src_elisp{:comments} header-argument, so letâ€™s make that a default.

#+begin_src emacs-lisp
(setq org-babel-default-header-args
      '((:session . "none")
        (:results . "replace")
        (:exports . "code")
        (:cache . "no")
        (:noweb . "no")
        (:hlines . "no")
        (:tangle . "no")
        (:comments . "link")))
#+end_src

**** é›¶å®½ç©ºæ ¼

å¶å°”åœ¨ç”¨ Org æ˜¯ä½ å¸Œæœ›å°†ä¸¤ä¸ªåˆ†å¼€çš„å—æ”¾åœ¨ä¸€èµ·ï¼Œè¿™ç‚¹æœ‰ç‚¹çƒ¦äººã€‚æ¯”å¦‚å°†åŠ â€‹*é‡*â€‹ä¸€ä¸ªå•è¯
çš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…è¯´åœ¨å†…è”æºç å—ä¹‹å‰æ”¾ä¸€äº›ç¬¦å·ã€‚æœ‰ä¸€ä¸ªå¯ä»¥è§£å†³çš„æ–¹æ³• --- é›¶å®½ç©ºæ ¼ã€‚
ç”±äºè¿™æ˜¯ Emacsï¼Œæˆ‘ä»¬å¯ä»¥ä¸º org-mode åšä¸€ä¸ªå¾ˆå°çš„æ”¹åŠ¨å°†å…¶æ·»åŠ åˆ°å¿«æ·é”®ä¸Š ğŸ™‚ã€‚

#+begin_src emacs-lisp
(map! :map org-mode-map
      :leader
      :desc "zero-width-space" "SPC" (cmd! (insert "\u200B")))
#+end_src

**** ç›®å½•ç”Ÿæˆ

ç”Ÿæˆç›®å½•çš„éœ€æ±‚å¹¶ä¸å¤§ï¼Œä½†æ˜¯åƒ =GitHub= çš„ç¯å¢ƒä¸‹ TOC å¯èƒ½æˆä¸ºå¿…è¦ï¼Œé‡‡ç”¨ ~toc-org~
æ¥ç”Ÿæˆã€‚
#+begin_src emacs-lisp :noweb-ref none :tangle no
(use-package! toc-org
  :defer t
  :after (:any org markdown)
  :config
  (toc-org-mode t)
  (add-hook! (org-mode markdown-mode) #'toc-org-mode)
  (define-key! org-mode-map "C-c C-i" #'toc-org-insert-toc)
  (define-key! markdown-mode-map "C-c M-t" #'toc-org-insert-toc))
#+end_src

=toc-org= ä¼šæ¸…ç©ºå¸¦æœ‰ ~TOC~ æ ‡ç­¾çš„ headingï¼Œå¹¶ç”Ÿæˆç›®å½•ã€‚

æˆ‘ä¸ç¡®å®šçœŸçš„éœ€è¦å®ƒå˜›ï¼Œå› æ­¤æˆ‘å°†å®ƒå…³é—­äº†ã€‚

**** åŠ å¯†å—

=org-crypt= å¯ä»¥ç”¨ =GPG= åŠ å¯† Org Mode çš„æŸäº› headingï¼Œå½“ç„¶æ˜¯å¸¦æœ‰ ~crypt~ æ ‡ç­¾çš„ã€‚
ç°åœ¨æ¥è®¾ç½®ä¸€ä¸‹ã€‚
#+begin_src emacs-lisp
(use-package! org-crypt
  :custom
  (org-crypt-key "0xA173AD0063A4E2DFAB4F9EAE65F09D172E677525")
  (org-tags-exclude-from-inheritance '("crypt")) ;; avoid repeated encryption
  :config
  (org-crypt-use-before-save-magic) ;; encrypt when writing back to the hard disk
  (map! :map org-mode-map
        :localleader
        :desc "org-encrypt" "C" nil
        :desc "encrypt current" "C e" #'org-encrypt-entry
        :desc "encrypt all" "C E" #'org-encrypt-entries
        :desc "decrypt current" "C d" #'org-decrypt-entry
        :desc "decrypt all" "C D" #'org-decrypt-entries))
#+end_src

å¦‚æœæƒ³ç”¨å…¶ä»–å¯†é’¥åŠ å¯†ï¼Œå¯ä»¥è®¾ç½® ~cryptkey~ å±æ€§ã€‚
#+begin_src fundamental
,* Totally secret :crypt:
:properties:
:cryptkey: 0x0123456789012345678901234567890123456789
:end:
#+end_src

**** åˆ—è¡¨é¡ºåº

#+begin_src emacs-lisp
(setq org-list-demote-modify-bullet '(("+" . "-") ("-" . "+") ("*" . "+") ("1." . "a.")))
#+end_src

**** å¼•ç”¨

#+begin_comment
æ¥è‡ª =:tools biblio= æ¨¡å—
#+end_comment

#+begin_src emacs-lisp
;;; (org-cite-global-bibliography '("~/library/ebooks/catalog.bib" "~/library/papers/catalog.bib"))
(after! citar
  (setq! citar-symbol-separator "  "
         citar-bibliography org-cite-global-bibliography
         citar-symbols
           `((file ,(nerd-icons-faicon "nf-fa-file_o" :face 'nerd-icons-green :v-adjust -0.1) . " ")
             (note ,(nerd-icons-octicon "nf-oct-note" :face 'nerd-icons-blue :v-adjust -0.3) . " ")
             (link ,(nerd-icons-octicon "nf-oct-link" :face 'nerd-icons-orange :v-adjust 0.01) . " ")))
  (org-cite-follow-processor 'citar)
  (org-cite-activate-processor 'citar)
  (add-to-list 'citar-major-mode-functions
               '((gfm-mode)
                 (insert-keys . citar-markdown-insert-keys)
                 (insert-citation . citar-markdown-insert-citation)
                 (insert-edit . citar-markdown-insert-edit)
                 (key-at-point . citar-markdown-key-at-point)
                 (citation-at-point . citar-markdown-citation-at-point)
                 (list-keys . citar-markdown-list-keys))))
#+end_src

ä¸»è¦ä¸ºäº†å¼•ç”¨çš„çµæ´»æ€§ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰è®¾ç½®å…¨å±€ bibï¼Œå¦‚æœæƒ³åœ¨ Org é‡Œå¼•ç”¨æŸäº› bib æ–‡ä»¶å¯
ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹æ³•ã€‚
#+begin_src fundamental
,#+bibliography: ~/library/ebooks/catalog.bib
,#+bibliography: ~/library/papers/catalog.bib
#+end_src

å½“ç„¶è¿™é…ç½®å¾ˆç®€å•ï¼Œåªä¸è¿‡åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œå…³äº =org-cite= å’Œ =citar= è¦å­¦çš„è¿˜æœ‰å¾ˆå¤šã€‚
å¯ä»¥çœ‹çœ‹ [[https://blog.tecosaur.com/tmio/2021-07-31-citations.html][è¿™ç¯‡]]ã€‚

**** lsp æ”¯æŒçš„æºç å—

é»˜è®¤æƒ…å†µä¸‹ï¼Œlsp å¹¶ä¸æ”¯æŒåº”ç”¨åœ¨ src å—ä¸­ã€‚

#+begin_src emacs-lisp
;; Enable LSP in org babel
;; need to add `:file test.xx' in the header
;; https://github.com/emacs-lsp/lsp-mode/issues/377
(cl-defmacro lsp-org-babel-enable (lang)
  "Support LANG in org source code block."
  (setq centaur-lsp 'lsp-mode)
  (cl-check-type lang string)
  (let* ((edit-pre (intern (format "org-babel-edit-prep:%s" lang)))
         (intern-pre (intern (format "lsp--%s" (symbol-name edit-pre)))))
    `(progn
       (defun ,intern-pre (info)
         (let ((file-name (->> info caddr (alist-get :file))))
           (unless file-name
             (setq file-name (make-temp-file "babel-lsp-")))
           (setq buffer-file-name file-name)
           (lsp-deferred)))
       (put ',intern-pre 'function-documentation
            (format "Enable lsp-mode in the buffer of org source block (%s)."
                    (upcase ,lang)))
       (if (fboundp ',edit-pre)
           (advice-add ',edit-pre :after ',intern-pre)
         (progn
           (defun ,edit-pre (info)
             (,intern-pre info))
           (put ',edit-pre 'function-documentation
                (format "Prepare local buffer environment for org source block (%s)."
                        (upcase ,lang))))))))
(defvar org-babel-lang-list
  '("python"))
(dolist (lang org-babel-lang-list)
  (eval `(lsp-org-babel-enable ,lang)))
#+end_src

*** Agenda

#+begin_src emacs-lisp :tangle yes :noweb-ref none
(defvar org-agenda-dir (concat org-directory "/" "agenda"))
(defvar org-agenda-todo-file (expand-file-name "todo.org" org-agenda-dir))
(defvar org-agenda-project-file (expand-file-name "project.org" org-agenda-dir))
(after! org-agenda
  ;;urgancy|soon|as soon as possible|at some point|eventually
  ;;
  (setq! org-agenda-files `(,org-agenda-todo-file
                            ,org-agenda-project-file)
         org-agenda-skip-scheduled-if-done t
         org-agenda-skip-deadline-if-done t
         org-agenda-include-deadlines t
         org-agenda-block-separator nil
         org-agenda-tags-column 100 ;; from testing this seems to be a good value
         org-agenda-compact-blocks t))
#+end_src

*** Capture

å¼€å§‹è®¾ç½® Org-capture æ¨¡æ¿å§ï¼Œå¿«é€Ÿè®°å½•ï¼

#+begin_src emacs-lisp :noweb-ref none :tangle yes
(after! org-capture
  (defun ginshio/find-project-tree(priority)
    "find or create project headline
https://www.zmonster.me/2018/02/28/org-mode-capture.html"
    (let* ((hl (let ((headlines (org-element-map (org-element-parse-buffer 'headline) 'headline
                                  (lambda (hl) (and (= (org-element-property :level hl) 1)
                                               (org-element-property :title hl))))))
                 (completing-read "Project Name: " headlines))))
      (goto-char (point-min))
      (if (re-search-forward
           (format org-complex-heading-regexp-format (regexp-quote hl)) nil t)
          (goto-char (point-at-bol))
        (progn
          (or (bolp) (insert "\n"))
          (if (/= (point) (point-min)) (org-end-of-subtree))
          (insert (format "* %s :project:%s:\n:properties:\n:homepage: %s\n:repo: \
%s\n:end:\n\n** urgancy :urgancy:\n\n** soon :soon:\n\n** as soon as\
 possible :asap:\n\n** at some point :asp:\n\n** eventually :eventually:\n"
                          hl hl (read-string "homepage: ") (read-string "repo: ")))
          (beginning-of-line 0)
          (org-up-heading-safe))))
    (re-search-forward
     (format org-complex-heading-regexp-format
             (regexp-quote priority))
     (save-excursion (org-end-of-subtree t t)) t)
    (org-end-of-subtree))
  (setq! org-capture-dir (expand-file-name "capture" org-directory)
         org-capture-snippet-file (expand-file-name "snippets.org" org-capture-dir)
         org-capture-comment-file (expand-file-name "comments.org" org-capture-dir)
         org-capture-note-file (expand-file-name "notes.org" org-capture-dir)
         org-capture-blog-file (expand-file-name "blogs.org" org-capture-dir)
         )
  ;; http://www.howardism.org/Technical/Emacs/journaling-org.html
  ;; https://www.zmonster.me/2018/02/28/org-mode-capture.html
  (setq org-capture-templates
        `(("B" "Blog TODO List" entry (file ,org-capture-blog-file)
           "* TODO [#%^{priority|D|A|B|C|E}] %^{blog_title}\n:properties:\n:categories: %^{categories}\n:tags: %^{tags}\n:title: %\\1\n:file_name: %^{file_name}\n:end:\n%?"
           :empty-lines 1)
          ("c" "Comment")
          ("cb" "Book" entry (file+weektree ,org-capture-comment-file)
           "* %^{book} :book:%\\1:\n%?" :empty-lines 1)
          ("cm" "Movie" entry (file+weektree ,org-capture-comment-file)
           "* %^{movie} :movie:%\\1:\n%?" :empty-lines 1)
          ("g" "GTD")
          ("gt" "Todo" entry (file+headline org-agenda-todo-file "Personal")
           "* TODO [#%^{priority|A|B|C|D|E}] %^{task}\n  SCHEDULED: %^T DEADLINE: %^T\n:properties:\n:end:\n%?"
           :empty-lines 1)
          ("gi" "Interview" entry (file+headline ,org-agenda-todo-file "Interview")
           "* WAIT [#%^{priority|B|A|C|D}] %^{company} - %^{position}\t:%\\2:\nSCHEDULED: %^T DEADLINE: %^T\n:properties:\n:url: %^{link}\n:end:\n%?"
           :prepend t :empty-lines 1)
          ("gd" "Daily" entry (file+headline ,org-agenda-todo-file "Daily")
           "* TODO [#%^{priority|C|A|B|D|E}] %^{task}\n SCHEDULED:  %<<%Y-%m-%d %a %H:%M ++1d>>\n:properties:\n:end:\n%?"
           :empty-lines 1)
          ("gw" "Weekly" entry (file+headline ,org-agenda-todo-file "Weekly")
           "* TODO [#%^{priority|B|A|C|D|E}] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M ++1w>>\n:properties:\n:end:\n%?"
           :empty-lines 1)
          ("gm" "Monthly" entry (file+headline ,org-agenda-todo-file "Monthly")
           "* TODO [#%^{priority|C|A|B|D|E}] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M ++1m>>\n:properties:\n:end:\n%?"
           :empty-lines 1)
          ("n" "Note")
          ("nc" "Computer" entry (file+headline ,org-capture-note-file "Computer")
           "* %^{heading} %^g\n%?\n" :empty-lines 1)
          ("ne" "Emacs" entry (file+headline ,org-capture-note-file "Emacs")
           "* %^{heading} %^g\n%?\n" :empty-lines 1)
          ("ng" "Game" entry (file+headline ,org-capture-note-file "Game")
           "* %^{heading} %^g\n%?\n" :empty-lines 1)
          ;; ("p" "Project")
          ;; ("pa" "Urgance" entry (file+function ,org-agenda-project-file
          ;;                                      (lambda () (ginshio/find-project-tree "urgancy")))
          ;;  "*** TODO [#A] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M>> DEADLINE: %^T\n    :properties:\n    :end:\n%?"
          ;;  :empty-lines 1)
          ;; ("pb" "Soon" entry (file+function ,org-agenda-project-file
          ;;                                   (lambda () (ginshio/find-project-tree "soon")))
          ;;  "*** TODO [#B] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M>> DEADLINE: %^T\n    :properties:\n    :end:\n%?"
          ;;  :empty-lines 1)
          ;; ("pc" "As Soon As Possiple" entry (file+function ,org-agenda-project-file
          ;;                                                  (lambda () (ginshio/find-project-tree "as soon as possiple")))
          ;;  "*** TODO [#C] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M>> DEADLINE: %^T\n    :properties:\n    :end:\n%?"
          ;;  :empty-lines 1)
          ;; ("pd" "At Some Point" entry (file+function ,org-agenda-project-file
          ;;                                            (lambda () (ginshio/find-project-tree "at some point")))
          ;;  "*** TODO [#D] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M>> DEADLINE: %^T\n    :properties:\n    :end:\n%?"
          ;;  :empty-lines 1)
          ;; ("pe" "Eventually" entry (file+function ,org-agenda-project-file
          ;;                                         (lambda () (ginshio/find-project-tree "eventually")))
          ;;  "*** TODO [#E] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M>> DEADLINE: %^T\n    :properties:\n    :end:\n%?"
          ;;  :empty-lines 1)
          ("s" "Code Snippet" entry (file ,org-capture-snippet-file)
           "* %^{heading} :code:%\\2:\n:properties:\n:language: %^{language}\n:end:\n\n#+begin_src %\\2\n%?\n#+end_src"
           :empty-lines 1)
          )))
#+end_src

*** è§†è§‰

**** Org Modern

ä½¿ =org-mode= buffer å°½å¯èƒ½æ¼‚äº®æ˜¯å¾ˆé‡è¦çš„ï¼ŒMinad çš„ =org-modern= åœ¨è¿™æ–¹é¢å¤§æœ‰å¸®åŠ©ã€‚

#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! org-modern)
#+end_src

#+begin_src emacs-lisp
(use-package! org-modern
  :hook
  (org-mode . org-modern-mode)
  (org-agenda-finalize . org-modern-agenda)
  :config
  (setq org-modern-star 'replace
        org-modern-replace-stars "â™‡â™†â™…â™„â™ƒâ™‚â™€â˜¿" ;;  "â—‰â—‹âœ¸âœ¿âœ¤âœœâ—†â–¶"
        org-modern-table-vertical 1
        org-modern-table-horizontal 0.2
        org-modern-list '((43 . "â¤")
                          (45 . "â€“")
                          (42 . "â€¢"))
        org-modern-todo-faces '(("TODO" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "goldenrod"))
                                ("NEXT" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "IndianRed1"))
                                ("STRT" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "OrangeRed"))
                                ("WAIT" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "coral"))
                                ("KILL" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "DarkGreen"))
                                ("PROJ" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "LimeGreen"))
                                ("HOLD" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "orange"))
                                ("DONE" . (:inherit org-verbatim :weight semi-bold :foreground "black" :background "LightGray")))
        org-modern-footnote (cons nil (cadr org-script-display))
        org-modern-block-fringe nil
        org-modern-block-name '((t . t)
                                ("src" "Â»" "Â«")
                                ("example" "Â»â€“" "â€“Â«")
                                ("quote" "â" "â")
                                ("export" "â©" "âª"))
        org-modern-progress nil
        org-modern-priority nil
        org-modern-horizontal-rule (make-string 36 ?â”€)
        org-modern-keyword '((t . t)
                             ("title" . "ğ™")
                             ("subtitle" . "ğ™©")
                             ("author" . "ğ˜¼")
                             ("email" . "ï¯")
                             ("date" . "ğ˜¿")
                             ("property" . "ó° ³")
                             ("options" . #("ó°˜µ" 0 1 (display (height 0.75))))
                             ("startup" . "â»")
                             ("macro" . "ğ“œ")
                             ("bind" . "ó°Œ·")
                             ("bibliography" . "ï…")
                             ("print_bibliography" . "ó°Œ±")
                             ("cite_export" . "ï…â®­")
                             ("print_glossary" . "ó°Œ±á´¬á¶»")
                             ("glossary_sources" . "ó°’»")
                             ("include" . "â‡¤")
                             ("setupfile" . "â‡š")
                             ("html_head" . "ğŸ…·")
                             ("html" . "ğŸ…—")
                             ("latex_class" . "ğŸ„»")
                             ("latex_class_options" . "ğŸ„»ó°’“")
                             ("latex_header" . "ğŸ…»")
                             ("latex_header_extra" . "ğŸ…»âº")
                             ("latex" . "ğŸ…›")
                             ("beamer_theme" . "ğŸ„±")
                             ("beamer_color_theme" . "ğŸ„±ó°˜")
                             ("beamer_font_theme" . "ğŸ„±ğ€")
                             ("beamer_header" . "ğŸ…±")
                             ("beamer" . "ğŸ…‘")
                             ("attr_latex" . "ğŸ„›")
                             ("attr_html" . "ğŸ„—")
                             ("attr_org" . "â’ª")
                             ("call" . "ó°œ")
                             ("name" . "â")
                             ("header" . "â€º")
                             ("caption" . "â˜°")
                             ("results" . "ğŸ ¶"))
        org-auto-align-tags nil
        org-tags-column 0
        org-catch-invisible-edits 'show-and-error
        org-special-ctrl-a/e t
        org-hide-emphasis-markers t
        org-agenda-tags-column 0
        org-agenda-block-separator ?â”€
        org-agenda-time-grid '((daily today require-timed)
                               (800 1000 1200 1400 1600 1800 2000)
                               " â”„â”„â”„â”„â”„ " "â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„")
        org-agenda-current-time-string "â­  now â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        )
  (custom-set-variables '(org-modern-statistics :inherit org-checkbox-statistics-todo)))
#+end_src

**** å¼ºè°ƒæ ‡è®°

è™½ç„¶ ~org-hide-emphasis-markers~ éå¸¸å¥½ï¼Œä½†æœ‰æ—¶å®ƒä¼šä½¿è¾¹ç•Œå¤„çš„ç¼–è¾‘å˜å¾—æ›´åŠ ç¹çã€‚
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ =org-appear= åŒ…åœ¨ä¸ç‰ºç‰²è§†è§‰ä¾¿åˆ©çš„æƒ…å†µä¸‹æ”¹å–„è¿™ç§æƒ…å†µã€‚

#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! org-appear
  :recipe (:host github :repo "awth13/org-appear"))
#+end_src

#+begin_src emacs-lisp
(use-package! org-appear
  :hook (org-mode . org-appear-mode)
  :config
  (setq! org-appear-autoemphasis t
         org-appear-autosubmarkers t
         org-appear-autolinks nil)
  ;; for proper first-time setup, `org-appear--set-elements'
  ;; needs to be run after other hooks have acted.
  (run-at-time nil nil #'org-appear--set-elements))
#+end_src

**** ç¬¦å·

æœ¬èº«ä¸ç”¨åŠ è¿™ä¸ªåŒ…çš„ï¼Œä¸è¿‡ç§»é™¤äº† doom é…ç½®é‡Œçš„ `(org +pretty)` çš„é€‰é¡¹ï¼Œåªå¥½è‡ªå·±æ‰‹
åŠ¨æ¥åšè¿™ä»¶äº‹äº†ã€‚

#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! org-fancy-priorities
  :recipe (:host github :repo "harrybournis/org-fancy-priorities"))
#+end_src

æ›´æ”¹ç”¨äºæŠ˜å é¡¹ç›®çš„å­—ç¬¦ä¹Ÿå¾ˆå¥½ (é»˜è®¤æƒ…å†µä¸‹ ~â€¦~)ï¼Œæˆ‘è®¤ä¸ºç”¨ ~â–¾~ æ›´é€‚åˆæŒ‡ç¤º ã€ŒæŠ˜å éƒ¨
åˆ†ã€ã€‚å¹¶åœ¨é»˜è®¤çš„å››ä¸ªåˆ—è¡¨ä¸­æ·»åŠ ä¸€ä¸ªé¢å¤–çš„ ~org-bullet~ ã€‚å¯¹äº†ï¼Œåˆ«å¿˜è®°ä¼˜å…ˆçº§ä¹Ÿè¦ä¿®
æ”¹ã€‚

#+begin_src emacs-lisp
(use-package! org-fancy-priorities
  :ensure t
  :hook (org-mode . org-fancy-priorities-mode)
  :custom (org-lowest-priority ?E)
  :config (setq! org-fancy-priorities-list '("âš¡" "â†‘" "â†“" "â˜•" "â“")))
(setq! org-ellipsis " â–¾ "
       org-hide-leading-stars t
       org-priority-highest ?A
       org-priority-lowest ?E
       org-priority-faces
       '((?A . 'nerd-icons-red)
         (?B . 'nerd-icons-orange)
         (?C . 'nerd-icons-yellow)
         (?D . 'nerd-icons-green)
         (?E . 'nerd-icons-blue)))
(setq! +ligatures-extra-symbols
          (list :list_property "âˆ·"
                :em_dash       "â€”"
                :ellipses      "â€¦"
                :arrow_right   "â†’"
                :arrow_left    "â†"
                :arrow_lr      "â†”"
                :properties    "âš™"
                :end           "âˆ"
                :priority_a    #("âš‘" 0 1 (face nerd-icons-red))
                :priority_b    #("â¬†" 0 1 (face nerd-icons-orange))
                :priority_c    #("â– " 0 1 (face nerd-icons-yellow))
                :priority_d    #("â¬‡" 0 1 (face nerd-icons-green))
                :priority_e    #("â“" 0 1 (face nerd-icons-blue))))

(defadvice! +org-init-appearance-h--no-ligatures-a ()
  :after #'+org-init-appearance-h
  (set-ligatures! 'org-mode nil)
  (set-ligatures! 'org-mode
    :list_property "::"
    :em_dash       "---"
    :ellipsis      "..."
    :arrow_right   "->"
    :arrow_left    "<-"
    :arrow_lr      "<->"
    :properties    ":PROPERTIES:"
    :end           ":END:"
    :priority_a    "[#A]"
    :priority_b    "[#B]"
    :priority_c    "[#C]"
    :priority_d    "[#D]"
    :priority_e    "[#E]"))
#+end_src

**** LaTeX ç‰‡æ®µ

è®©å…¬å¼ç¨ç¨å¥½çœ‹ä¸€ç‚¹ç‚¹
#+begin_src emacs-lisp
(setq! org-highlight-latex-and-related '(latex script entities))
#+end_src

ç†æƒ³æƒ…å†µä¸‹ ~org-src-font-lock-fontify-block~ ä¸ä¼šæ·»åŠ  =org-block= ï¼Œä½†æˆ‘
ä»¬å¯ä»¥é€šè¿‡æ·»åŠ å¸¦æœ‰ =:inherit default= é¢æ¥é¿å…æ•´ä¸ªåŠŸèƒ½ï¼Œè¿™å°†è¦†ç›–èƒŒæ™¯é¢œè‰²ã€‚

æ£€æŸ¥ ~org-do-latex-and-related~ æ˜¾ç¤º ="latex"= æ˜¯ä¼ é€’çš„è¯­è¨€å‚æ•°ï¼Œå› æ­¤æˆ‘ä»¬
å¯ä»¥å¦‚ä¸Šæ‰€è¿°è¦†ç›–èƒŒæ™¯ã€‚
#+begin_src emacs-lisp
(require 'org-src)
(add-to-list 'org-src-block-faces '("latex" (:inherit default :extend t)))
#+end_src

æ¯”è¯­æ³•é«˜äº®çš„ LaTeX æ›´å¥½çš„æ˜¯ /å‘ˆç°/ LaTeXã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ =org-fragtog= è‡ªåŠ¨æ‰§
è¡Œæ­¤æ“ä½œã€‚

#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! org-fragtog)
#+end_src

#+begin_src emacs-lisp
(use-package! org-fragtog :hook (org-mode . org-fragtog-mode))
#+end_src

è‡ªå®šä¹‰ LaTeX ç‰‡æ®µçš„å¤–è§‚å¾ˆèˆ’é€‚ï¼Œè¿™æ ·å®ƒä»¬å°±æ›´é€‚åˆæ–‡æœ¬äº† --- æ¯”å¦‚è¿™ä¸ª
$\sqrt{\beta^2+3}-\sum_{\phi=1}^\infty \frac{x^\phi-1}{\Gamma(a)}$â€‹ã€‚

#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
(setq! org-preview-latex-default-process 'dvisvgm
       org-preview-latex-process-alist
       '((dvipng :programs ("latex" "dvipng")
          :description "dvi --> png"
          :message "you need to install the programs: latex and dvipng."
          :image-input-type "dvi"
          :image-output-type "png"
          :image-size-adjust (1.0 . 1.0)
          :latex-compiler ("lualatex --shell-escape --output-format=dvi --interaction=nonstopmode --output-directory=%o %f")
          :image-converter ("dvipng -D %D -T tight -bg Transparent -o %O %f"))
         (dvisvgm :programs ("latex" "dvisvgm")
                  :description "dvi --> svg"
                  :message "you need to install the programs: latex and dvisvgm."
                  :use-xcolor t
                  :image-input-type "dvi"
                  :image-output-type "svg"
                  :image-size-adjust (1.7 . 1.5)
                  :latex-compiler ("lualatex --shell-escape --output-format=dvi --interaction=nonstopmode --output-directory=%o %f")
                  :image-converter ("dvisvgm %f --no-specials=bgcolor -n -b min -c %S -o %O"))
         (imagemagick :programs ("latex" "convert")
                      :description "pdf --> png"
                      :message "you need to install the programs: latex and imagemagick."
                      :use-xcolor t
                      :image-input-type "pdf"
                      :image-output-type "png"
                      :image-size-adjust (1.0 . 1.0)
                      :latex-compiler ("lualatex --shell-escape --output-format=pdf --interaction=nonstopmode --output-directory=%o %f")
                      :image-converter ("convert -density %D -trim -antialias %f -quality 100 %O"))))
(plist-put org-format-latex-options :background "Transparent")
(plist-put org-format-latex-options :zoom 0.93) ; Calibrated based on the TeX font and org-buffer font.
#+end_src

é¡ºä¾¿è®¾ç½®ä¸‹èƒŒæ™¯

#+begin_src emacs-lisp
(defun +org-refresh-latex-images-previews-h ()
  (dolist (buffer (doom-buffers-in-mode 'org-mode (buffer-list)))
    (with-current-buffer buffer
      (+org--toggle-inline-images-in-subtree (point-min) (point-max) 'refresh)
      (unless (eq org-latex-preview-default-process 'dvisvgm)
        (org-clear-latex-preview (point-min) (point-max))
        (org--latex-preview-region (point-min) (point-max))))))

(add-hook! doom-load-theme #'+org-refresh-latex-images-previews-h)
#+end_src

**** å­—ä½“åŒ–å†…è” src å—

Org ä½¿ç”¨ =#+begin_src= å—åšäº†ä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚åœ¨å¹•åä½¿ç”¨ font-lock ä½œä¸ºè¯­è¨€çš„ä¸»è¦æ¨¡
å¼å¹¶æ‹‰å‡ºè‰¯å¥½çš„å½©è‰²ç»“æœã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå†…è” =src_= å—åœ¨æŸç§ç¨‹åº¦ä¸Šè¢«å¿½ç•¥äº†ã€‚

æˆ‘ä¸æ˜¯ç¬¬ä¸€ä¸ªæœ‰è¿™ç§æ„Ÿè§‰çš„äºº, å¹¸å¥½ä»–ä»¬å·²ç»å¼€å§‹åœ¨ [[https://stackoverflow.com/questions/20309842/how-to-syntax-highlight-for-org-mode-inline-source-code-src-lang/28059832][stackexchange]] ä¸Šå¼€å§‹è®¨è®ºäº†ã€‚ æˆ‘æ‰“
ç®—ç›´æ¥ä½¿ç”¨ä»–ä»¬çš„ç»“æœï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼Œä»–ä»¬æ²¡æœ‰æ‰§è¡Œ /true/ æºä»£ç å­—ä½“åŒ–ï¼Œè€Œåªæ˜¯å°†
=org-code= åº”ç”¨åœ¨å†…å®¹ä¸Šã€‚

æˆ‘ä»¬å¯ä»¥åšå¾—æ¯”è¿™æ›´å¥½ï¼ä½¿ç”¨ ~org-src-font-lock-fontify-block~ æˆ‘ä»¬å¯ä»¥åº”ç”¨é€‚åˆè¯­
è¨€çš„è¯­æ³•é«˜äº®ã€‚ç„¶åï¼Œç»§ç»­åˆ° ={{{results(...)}}}=ï¼Œå®ƒå¯ä»¥å°† =org-block= åº”ç”¨ç›¸åº”çš„
è§„åˆ™ï¼Œç„¶åé€šè¿‡æ¨¡ä»¿ ~prettify-symbols-mode~ çš„è¡Œä¸ºéšè—å€¼åŒ…å›´ç»“æ„ã€‚

#+begin_warning
ä½†ç›®å‰åªèƒ½ä¸€è¡Œé«˜äº®ä¸€ä¸ªå†…è” src å—ã€‚æˆ‘ä¸çŸ¥é“å®ƒä¸ºä»€ä¹ˆä¼šåœæ­¢ï¼Œæˆ‘å¸Œæœ›å®ƒæ­£å¸¸ã€‚å¦‚æœæ‚¨
çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆæˆ–å¦‚ä½•è§£å†³æ­¤é—®é¢˜ /è¯·/ è”ç³»ã€‚
#+end_warning

#+begin_src emacs-lisp
(setq! org-inline-src-prettify-results '("âŸ¨" . "âŸ©"))
#+end_src

Doom ä¸»é¢˜çš„é¢å¤–å­—ä½“åŒ–é—®é¢˜å¤šäºå¸®åŠ©ã€‚
#+begin_src emacs-lisp
(setq! doom-themes-org-fontify-special-tags nil)
#+end_src


*** Babel
:properties:
:CUSTOM_ID: org_babel_generic
:header-args:emacs-lisp: :tangle no :noweb-ref org-babel-conf
:end:

æˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ªé€šå¤©çš„å·´åˆ«å¡”ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åœ¨ org-mode çš„ä»»æ„ä½ç½®ç¼–å†™ä»¥åŠè¿è¡Œä»»ä½•
ç¼–ç¨‹è¯­è¨€ï¼

#+begin_src emacs-lisp :noweb no-export :noweb-ref org-conf :tangle no
<<org-babel-conf>>
#+end_src

**** LaTeX

å¦‚æœå¯¼å‡ºåˆ°æ–‡ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨å®šåˆ¶åŒ–çš„ LaTeX å¯¼å‡ºï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ‰€æœ‰å…³äºæˆ‘ä»¬å¯¹äº org-mode
latex çš„å®šåˆ¶åŒ–è®¾ç½®ã€‚(HTML é™¤å¤–ï¼Ÿ)

#+begin_src emacs-lisp
(defadvice! org-babel-execute-latex-export-file (orig-fn body params)
  "Like `org-babel-execute:latex', support org-format-latex-header for all"
  :around #'org-babel-execute:latex
  (if (string-suffix-p ".html" (cdr (assq :file params)))
      (funcall orig-fn body params)
    (let ((expanded-body (org-babel-expand-body:latex body params))
          (latex-compiler
           (list :latex-compiler (or (cadar (org-collect-keywords '("latex_compiler"))) org-latex-compiler))))
      (if (cdr (assq :file params))
          (ginshio/org-babel-execute-latex-export-file latex-compiler expanded-body params)
        expanded-body))))

(defun ginshio/org-babel-execute-latex-export-file (latex-compiler body params)
  (let* ((out-file (cdr (assq :file params)))
         (extension (file-name-extension out-file))
         (tex-file (org-babel-temp-file "latex-" ".tex"))
         (border (cdr (assq :border params)))
         (imagemagick (cdr (assq :imagemagick params)))
         (fit (or (cdr (assq :fit params)) border))
         (headers (cdr (assq :headers params))))
    (stringp nil)
    (with-temp-file tex-file
      (require 'ox-latex)
      (insert
       (org-latex--insert-compiler latex-compiler)
       (org-latex-guess-inputenc
        (org-splice-latex-header
         org-format-latex-header
         (delq nil
               (mapcar
                (lambda (el)
                  (unless (and (listp el) (string= "hyperref" (cadr el))) el))
                org-latex-default-packages-alist))
         (append (cdr (assq :packages params)) org-latex-packages-alist)
         nil))
       (if (string= "png" extension)
           (format "%s%s%s%s"
                   (if fit "\n\\usepackage[active,tightpage]{preview}\n" "")
                   (if border (format "\\setlength{\\PreviewBorder}{%s}\n" border) "")
                   (let ((height (and fit (cdr (assq :pdfheight params)))))
                     (if height (format "\\pdfpageheight %s\n" height) ""))
                   (let ((width (and fit (cdr (assq :pdfwidth params)))))
                     (if width (format "\\pdfpageheight %s\n" width) "")))
         "")
       (if headers
           (concat "\n"
                   (if (listp headers)
                       (mapconcat #'identity headers "\n")
                     headers) "\n")
         "")
       (if (and fit (string= "png" extension))
           (concat "\n\\begin{document}\n\\begin{preview}\n" body
                   "\n\\end{preview}\n\\end{document}\n")
         (concat "\n\\begin{document}\n" body "\n\\end{document}\n"))))
    (when (file-exists-p out-file) (delete-file out-file))
    (if (string= "tex" extension)
        (rename-file tex-file out-file)
      (let* ((transient-pdf-file (org-babel-latex-tex-to-pdf tex-file)))
        (cond
         ((string= "pdf" extension)
          (rename-file transient-pdf-file out-file))
         ((and (string= "png" extension) imagemagick)
          (org-babel-latex-convert-pdf
           transient-pdf-file out-file (cdr (assq :iminoptions params)) (cdr (assq :imoutoptions params))))
         ((string= "svg" extension)
          (let* ((log-buf (get-buffer-create "*Org Babel LaTeX Output*"))
                 (err-msg "org babel latex failed")
                 (img-out (org-compile-file
                           transient-pdf-file
                           (list org-babel-latex-pdf-svg-process)
                           extension err-msg log-buf)))
            (rename-file img-out out-file)))
         (t
          (error "Can not create %s files, please specify a .svg, .png or .pdf file or try the :imagemagick header argument"
                 extension)))))))
#+end_src

*** å¯¼å‡ºé€šç”¨è®¾ç½®
:properties:
:CUSTOM_ID: org_export_generic
:header-args:emacs-lisp: :tangle no :noweb-ref org-export-conf
:end:

é»˜è®¤æƒ…å†µä¸‹ï¼ŒOrg ä»…å°†å‰ä¸‰ä¸ªçº§åˆ«çš„æ ‡é¢˜å¯¼å‡ºä¸ºæ ‡é¢˜ã€‚å½“ä½¿ç”¨ =article= æ—¶ï¼ŒLaTeX æ ‡é¢˜
ä» =\section=â€‹ã€â€‹=\subsection=â€‹ã€â€‹=\subsubsection= å’Œ =\paragraph=â€‹ã€
=\subgraph= --- /äº”/ ä¸ªçº§åˆ«ã€‚HTML5 æœ‰å…­çº§æ ‡é¢˜ (=<h1>= åˆ° =<h6>=)ï¼Œä½†ç¬¬ä¸€çº§ Org
æ ‡é¢˜è¢«å¯¼å‡ºä¸º =<h2>= å…ƒç´  --- å‰©ä¸‹ /äº”/ ä¸ªå¯ç”¨çº§åˆ«ã€‚

#+begin_src emacs-lisp :noweb no-export :noweb-ref org-conf :tangle no
(setq! org-export-headline-levels 5)
(after! ox
  <<org-export-conf>>
  )
#+end_src

æˆ‘è¿˜å°†ä½¿ç”¨ =ox-extra= ä¸­çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä»¥ä¾¿æˆ‘å¯ä»¥åœ¨æ ‡é¢˜ä¸­æ·»åŠ ä¸€ä¸ª =:ignore:= æ ‡è®°ä»¥
ä¿ç•™å†…å®¹ï¼Œä½†æ ‡é¢˜æœ¬èº«ä¼šè¢«å¿½ç•¥ï¼ˆâ€‹=:noexport:= å®ƒå¿½ç•¥äº†æ ‡é¢˜å’Œå†…å®¹ï¼‰ã€‚å½“æˆ‘æƒ³ä½¿ç”¨æ ‡é¢˜
æ¥æä¾›æœªå‡ºç°åœ¨æœ€ç»ˆæ–‡æ¡£ä¸­çš„å†™ä½œç»“æ„æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚

#+begin_src emacs-lisp
(require 'ox-extra)
(ox-extras-activate '(ignore-headlines))
#+end_src

ç”±äºæˆ‘ï¼ˆå¤§è‡´ï¼‰è·Ÿè¸ª Org ~HEAD~â€‹ï¼Œå› æ­¤åœ¨åˆ›å»ºè€…å­—ç¬¦ä¸²ä¸­åŒ…å« git ç‰ˆæœ¬æ˜¯æœ‰æ„ä¹‰çš„ã€‚
#+begin_src emacs-lisp
(setq! org-export-creator-string
       (format "Emacs %s (Org mode %sâ€“%s)" emacs-version (org-release) (org-git-version)))
#+end_src

åœ¨å¯¼å‡ºæ—¶ï¼Œæˆ‘å¹¶ä¸æƒ³è¦é›¶å®½åº¦ç©ºæ ¼ï¼ŒåŠ ä¸€ä¸ªç®€å•çš„è¿‡æ»¤å™¨å°†å…¶è¿‡æ»¤æ‰ã€‚
#+begin_src emacs-lisp
(defun +org-export-remove-zero-width-space (text _backend _info)
  "Remove zero width spaces from TEXT."
  (unless (org-export-derived-backend-p 'org)
    (replace-regexp-in-string "\u200B" "" text)))
(add-to-list 'org-export-filter-final-output-functions #'+org-export-remove-zero-width-space t)
#+end_src
