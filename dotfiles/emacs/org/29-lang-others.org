** LaTeX
:properties:
:CUSTOM_ID: LaTeX
:header-args:emacs-lisp: :tangle no :noweb-ref tex-conf
:end:

#+begin_src emacs-lisp :noweb no-export :tangle yes :noweb-ref nil
(setq! LaTeX-biblatex-use-Biber t)
(custom-set-variables '(LaTeX-section-label '(("part" . "part:")
                                              ("chapter" . "chap:")
                                              ("section" . "sec:")
                                              ("subsection" . "subsec:")
                                              ("subsubsection" . "subsubsec:")))
                      '(TeX-auto-local "auto")
                      '(TeX-command-extra-options "--shell-escape --interaction=nonstopmode"))
(after! latex
  (add-hook! latex-mode #'TeX-latex-mode)
  <<tex-conf>>
  )
#+end_src

*** ç¼–è¯‘

#+begin_src emacs-lisp
(setq! TeX-save-query nil
       TeX-show-compilation t
       LaTeX-clean-intermediate-suffixes (append TeX-clean-default-intermediate-suffixes
                                                 '("\\.acn" "\\.acr" "\\.alg" "\\.glg"
                                                   "\\.ist" "\\.listing" "\\.fdb_latexmk")))
(add-to-list 'TeX-command-list '("LatexMk (LuaLaTeX)" "LC_ALL=en_US.UTF-8 latexmk -pdf -lualatex -8bit %S%(mode) %(file-line-error) %(extraopts) %t" TeX-run-latexmk nil
                                 (plain-tex-mode latex-mode doctex-mode)
                                 :help "Run LatexMk (LuaLaTeX)"))
#+end_src

*** å¼•ç”¨

å¦‚æœ ~bib~ ä¸­æœ‰ä½ ä¸æƒ³è¦çš„æŸäº›å­—æ®µï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸‹æ–¹æ³•å»é™¤ (å¯¼è¨€åŒº)
#+begin_src latex :tangle no :noweb-ref none
\AtEveryBibitem{
  \clearfield{note}
  \ifentrytype{book}{
    \clearfield{url}
    \clearfield{isbn}
  }{}
  \ifentrytype{article}{
    \clearfield{url}
  }{}
  \ifentrytype{thesis}{
    \clearfield{url}
  }{}
}
#+end_src

*** è§†è§‰

å¢å¼ºä¸€ç‚¹ç‚¹è§†è§‰æ•ˆæœ
#+begin_src emacs-lisp
(setq TeX-fold-math-spec-list
      `(;; missing/better symbols
        ("â‰¤" ("le"))
        ("â‰¥" ("ge"))
        ("â‰ " ("ne"))
        ;; convenience shorts -- these don't work nicely ATM
        ;; ("â€¹" ("left"))
        ;; ("â€º" ("right"))
        ;; private macros
        ("â„" ("RR"))
        ("â„•" ("NN"))
        ("â„¤" ("ZZ"))
        ("â„š" ("QQ"))
        ("â„‚" ("CC"))
        ("â„™" ("PP"))
        ("â„" ("HH"))
        ("ğ”¼" ("EE"))
        ("ğ‘‘" ("dd"))
        ;; known commands
        ("" ("phantom"))
        (,(lambda (num den) (if (and (TeX-string-single-token-p num) (TeX-string-single-token-p den))
                                (concat num "ï¼" den)
                              (concat "âª" num "ï¼" den "â«"))) ("frac"))
        (,(lambda (arg) (concat "âˆš" (TeX-fold-parenthesize-as-necessary arg))) ("sqrt"))
        (,(lambda (arg) (concat "â­¡" (TeX-fold-parenthesize-as-necessary arg))) ("vec"))
        ("â€˜{1}â€™" ("text"))
        ;; private commands
        ("|{1}|" ("abs"))
        ("â€–{1}â€–" ("norm"))
        ("âŒŠ{1}âŒ‹" ("floor"))
        ("âŒˆ{1}âŒ‰" ("ceil"))
        ("âŒŠ{1}âŒ‰" ("round"))
        ("ğ‘‘{1}/ğ‘‘{2}" ("dv"))
        ("âˆ‚{1}/âˆ‚{2}" ("pdv"))
        ;; fancification
        ("{1}" ("mathrm"))
        (,(lambda (word) (string-offset-roman-chars 119743 word)) ("mathbf"))
        (,(lambda (word) (string-offset-roman-chars 119951 word)) ("mathcal"))
        (,(lambda (word) (string-offset-roman-chars 120003 word)) ("mathfrak"))
        (,(lambda (word) (string-offset-roman-chars 120055 word)) ("mathbb"))
        (,(lambda (word) (string-offset-roman-chars 120159 word)) ("mathsf"))
        (,(lambda (word) (string-offset-roman-chars 120367 word)) ("mathtt"))
        )
      TeX-fold-macro-spec-list
      '(
        ;; as the defaults
        ("[f]" ("footnote" "marginpar"))
        ("[c]" ("cite"))
        ("[l]" ("label"))
        ("[r]" ("ref" "pageref" "eqref"))
        ("[i]" ("index" "glossary"))
        ("..." ("dots"))
        ("{1}" ("emph" "textit" "textsl" "textmd" "textrm" "textsf" "texttt"
                "textbf" "textsc" "textup"))
        ;; tweaked defaults
        ("Â©" ("copyright"))
        ("Â®" ("textregistered"))
        ("â„¢"  ("texttrademark"))
        ("[1]:||â–º" ("item"))
        ("â¡â¡â€†{1}" ("part" "part*"))
        ("â¡â€†{1}" ("chapter" "chapter*"))
        ("Â§â€†{1}" ("section" "section*"))
        ("Â§Â§â€†{1}" ("subsection" "subsection*"))
        ("Â§Â§Â§â€†{1}" ("subsubsection" "subsubsection*"))
        ("Â¶â€†{1}" ("paragraph" "paragraph*"))
        ("Â¶Â¶â€†{1}" ("subparagraph" "subparagraph*"))
        ;; extra
        ("â¬–â€†{1}" ("begin"))
        ("â¬—â€†{1}" ("end"))
        ))

(defun string-offset-roman-chars (offset word)
  "Shift the codepoint of each character in WORD by OFFSET with an extra -6 shift if the letter is lowercase"
  (apply 'string
         (mapcar (lambda (c)
                   (string-offset-apply-roman-char-exceptions
                    (+ (if (>= c 97) (- c 6) c) offset)))
                 word)))

(defvar string-offset-roman-char-exceptions
  '(;; lowercase serif
    (119892 .  8462) ; â„
    ;; lowercase caligraphic
    (119994 . 8495) ; â„¯
    (119996 . 8458) ; â„Š
    (120004 . 8500) ; â„´
    ;; caligraphic
    (119965 . 8492) ; â„¬
    (119968 . 8496) ; â„°
    (119969 . 8497) ; â„±
    (119971 . 8459) ; â„‹
    (119972 . 8464) ; â„
    (119975 . 8466) ; â„’
    (119976 . 8499) ; â„³
    (119981 . 8475) ; â„›
    ;; fraktur
    (120070 . 8493) ; â„­
    (120075 . 8460) ; â„Œ
    (120076 . 8465) ; â„‘
    (120085 . 8476) ; â„œ
    (120092 . 8488) ; â„¨
    ;; blackboard
    (120122 . 8450) ; â„‚
    (120127 . 8461) ; â„
    (120133 . 8469) ; â„•
    (120135 . 8473) ; â„™
    (120136 . 8474) ; â„š
    (120137 . 8477) ; â„
    (120145 . 8484) ; â„¤
    )
  "An alist of deceptive codepoints, and then where the glyph actually resides.")

(defun string-offset-apply-roman-char-exceptions (char)
  "Sometimes the codepoint doesn't contain the char you expect.
Such special cases should be remapped to another value, as given in `string-offset-roman-char-exceptions'."
  (if (assoc char string-offset-roman-char-exceptions)
      (cdr (assoc char string-offset-roman-char-exceptions))
    char))

(defun TeX-fold-parenthesize-as-necessary (tokens &optional suppress-left suppress-right)
  "Add âª â« parenthesis as if multiple LaTeX tokens appear to be present"
  (if (TeX-string-single-token-p tokens) tokens
    (concat (if suppress-left "" "âª")
            tokens
            (if suppress-right "" "â«"))))

(defun TeX-string-single-token-p (teststring)
  "Return t if TESTSTRING appears to be a single token, nil otherwise"
  (if (string-match-p "^\\\\?\\w+$" teststring) t nil))
#+end_src

ä¸€äº› local å¿«æ·é”®ä½¿ç”Ÿæ´»æ›´è½»æ¾
#+begin_src emacs-lisp
(map!
 :map LaTeX-mode-map
 :ei [C-return] #'LaTeX-insert-item)
(setq TeX-electric-math '("\\(" . ""))
#+end_src

å½“ç„¶æ•°å­¦ç•Œå®šç¬¦ä¸éœ€è¦å¼ºè°ƒ
#+begin_src emacs-lisp
;; Making \( \) less visible
(defface unimportant-latex-face
  '((t :inherit font-lock-comment-face :weight extra-light))
  "Face used to make \\(\\), \\[\\] less visible."
  :group 'LaTeX-math)

(font-lock-add-keywords
 'latex-mode
 `(("\\\\[]()[]" 0 'unimportant-latex-face prepend))
 'end)

;; (font-lock-add-keywords
;;  'latex-mode
;;  '(("\\\\[[:word:]]+" 0 'font-lock-keyword-face prepend))
;;  'end)
#+end_src

*** CDLaTeX

é»˜è®¤æƒ…å†µä¸‹ï¼Œç¬¦å·ä¿®æ”¹éå¸¸å¥½ç”¨ï¼Œä½†å¯ä»¥å……å®æ›´å¤šç¬¦å·ã€‚è®©æˆ‘ä»¬å°†å‰ç¼€æ›´æ”¹ä¸ºåŒæ ·å¾ˆå°‘ä½¿ç”¨ä½†æ›´æ–¹ä¾¿çš„é”®ï¼Œä¾‹å¦‚ =;=â€‹ã€‚
#+begin_src emacs-lisp
(after! cdlatex
  (setq cdlatex-env-alist
        '(("bmatrix" "\\begin{bmatrix}\n?\n\\end{bmatrix}" nil)
          ("equation*" "\\begin{equation*}\n?\n\\end{equation*}" nil)))
  (setq ;; cdlatex-math-symbol-prefix ?\; ;; doesn't work at the moment :(
   cdlatex-math-symbol-alist
   '( ;; adding missing functions to 3rd level symbols
     (?_    ("\\downarrow"  ""           "\\inf"))
     (?2    ("^2"           "\\sqrt{?}"     ""     ))
     (?3    ("^3"           "\\sqrt[3]{?}"  ""     ))
     (?^    ("\\uparrow"    ""           "\\sup"))
     (?k    ("\\kappa"      ""           "\\ker"))
     (?m    ("\\mu"         ""           "\\lim"))
     (?c    (""             "\\circ"     "\\cos"))
     (?d    ("\\delta"      "\\partial"  "\\dim"))
     (?D    ("\\Delta"      "\\nabla"    "\\deg"))
     ;; no idea why \Phi isnt on 'F' in first place, \phi is on 'f'.
     (?F    ("\\Phi"))
     ;; now just convenience
     (?.    ("\\cdot" "\\dots"))
     (?:    ("\\vdots" "\\ddots"))
     (?*    ("\\times" "\\star" "\\ast")))
   cdlatex-math-modify-alist
   '( ;; my own stuff
     (?B    "\\mathbb"        nil          t    nil  nil)
     (?a    "\\abs"           nil          t    nil  nil))))
#+end_src

*** SyncTeX

#+begin_src emacs-lisp
(setq!
 ;;; %o: TeX-output-extension; %n: TeX-current-line; %b: TeX-current-file-name-master-relative
 TeX-view-program-list '(("Okular" "okular --unique %o#src:%n%(dir)./%b"))
 TeX-view-program-selection '((output-pdf "Okular") (output-dvi "Okular")))
#+end_src

** Markdown

Doom é»˜è®¤çš„ Markdown æ˜¯ ~GFM~ (GitHub Flavored Markdown)ï¼Œä¸è¿‡æœ‰äº† =Emacs= å’Œ
=Org Mode= è°è¿˜ç”¨ =Markdown= ã€‚ä½†æ˜¯ ~toc-org-mode~ ä¾ç„¶å¯ä»¥ä½¿ç”¨ã€‚

å¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ–¹å¼æ”¯æŒ Markdownã€‚
#+begin_src fundamental
# TOC         <!-- :TOC: -->
#+end_src

** C/C++

tcc ä¹Ÿæ˜¯ C++
#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist '("\\.tcc\\'" . c++-mode))
#+end_src

å¦‚æœå¼€å¯äº† format é‚£å¯ä»¥ä½¿ç”¨ clang-format è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç 
#+begin_src emacs-lisp :tangle no
(set-formatter! 'clang-format
  '("clang-format" "--Wno-error=unknown" ("-assume-filename=%S" (or buffer-file-name mode-result "")))
  :modes '(c-mode c++-mode))
#+end_src

ä½¿ç”¨ =dape= é€²è¡Œç¾ä»£åŒ–èª¿è©¦ï¼Œé…ç½®è¦‹ [[file:21-lang-lsp-dap.org][LSP/DAP é…ç½®]]â€‹ã€‚

** LLVM

å…ˆæŠŠéœ€è¦çš„åŒ…ä¸‹ä¸‹ä¾†ï¼Œè¿™äº›ä¸œè¥¿å°±åœ¨ llvm çš„ä»“åº“é‡Œã€‚

#+begin_src emacs-lisp :tangle packages.el
(package! llvm-mir-mode
  :recipe `(:local-repo ,doom-user-dir
            :files ("modules/llvm/llvm-mir-mode.el")))
(package! llvm-mode
  :recipe `(:local-repo ,doom-user-dir
            :files ("modules/llvm/llvm-mode.el")))
(package! mlir-mode
  :recipe `(:local-repo ,doom-user-dir
            :files ("modules/mlir/mlir-mode.el")))
(package! tablegen-mode
  :recipe `(:local-repo ,doom-user-dir
            :files ("modules/llvm/tablegen-mode.el")))
#+end_src

åˆ«å¿˜äº†è®© emacs å¯ä»¥è®¤è¯† LLVM çš„æ–‡ä»¶ã€‚
#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist '("\\.ll\\'" . llvm-mode))
(add-to-list 'auto-mode-alist '("\\.mlir\\'" . mlir-mode))
(add-to-list 'auto-mode-alist '("\\.lgc\\'" . llvm-mode))  ; https://github.com/GPUOpen-Drivers/llpc/tree/dev/lgc
(add-to-list 'auto-mode-alist '("\\.td\\'" . tablegen-mode))
#+end_src


** GLSL

ä¼¼ä¹è¿™ä»½é…ç½®å·²ç»æ”¯æŒ glsl äº†ï¼Œé‚£å°±æŠŠç›¸å…³æ–‡ä»¶éƒ½æ ‡è®°ä¸º glslï¼
#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist '("\\.tesc\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.tese\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.comp\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.mesh\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.task\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rgen\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rint\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rahit\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rchit\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rmiss\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rcall\\'" . glsl-mode))
#+end_src
