** LSP / DAP 現代化編程設施
:properties:
:CUSTOM_ID: lang-lsp-dap
:header-args:emacs-lisp: :tangle no :noweb-ref lsp-dap-conf
:end:

現代編輯器最重要的特性之一就是對 LSP (Language Server Protocol) 和 DAP (Debug
Adapter Protocol) 的良好支持。通過統一配置，我們可以確保所有語言獲得一致的體驗。

#+begin_src emacs-lisp :noweb no-export :tangle yes :noweb-ref nil
(after! eglot
  <<lsp-dap-conf>>
  )
#+end_src

*** Eglot 核心配置

Eglot 是 Emacs 29+ 內建的 LSP 客戶端，相比 lsp-mode 更加輕量且與 Emacs 集成更
好。我們需要平衡好性能和功能：關閉真正不需要的功能，但保留有價值的功能。

#+begin_src emacs-lisp
(setq! eglot-autoshutdown t
       eglot-code-action-indications nil
       eglot-events-buffer-size 0
       eglot-extend-to-xref nil
       eglot-stay-out-of '(yasnippet)
       ;; 性能相關:  https://github.com/joaotavora/eglot/discussions/993
       eldoc-idle-delay 0.5
       flymake-no-changes-timeout 0.5
       eglot-ignored-server-capabilities '(:colorProvider
                                           :documentFormattingProvider
                                           :documentLinkProvider
                                           :documentOnTypeFormattingProvider
                                           :documentRangeFormattingProvider
                                           ;; foldingRange: LSP 提供的代碼折疊範圍
                                           ;; (函數體、class、if/for block 等)。
                                           ;; Doom 的 fold 模組已經用 hideshow/outline
                                           ;; 實現了折疊，兩者會衝突，故忽略。
                                           :foldingRangeProvider
                                           ;; inlayHints: 在代碼行內插入類型標註、
                                           ;; 參數名等提示。信息量大但視覺噪音也大，
                                           ;; 不喜歡可以忽略；需要時用 M-x eglot-inlay-hints-mode 臨時開啓。
                                           :inlayHintProvider))
#+end_src

*** Eldoc 集成

讓 eldoc 合併來自不同源 (eglot, flymake 等) 的文檔：

#+begin_src emacs-lisp
(add-hook 'eglot-managed-mode-hook
          (lambda ()
            (setq-local eldoc-documentation-strategy #'eldoc-documentation-compose)))
;; 減少 JSON-RPC 日誌噪音
(advice-add 'jsonrpc--log-event :override #'ignore)

;; 修復 eglot hover 在渲染 markdown 代碼塊時的臨時 buffer 問題
;; 禁用會導致 "Selecting deleted buffer" 錯誤的 hooks
(defun +eglot-fix-markdown-fontify-a (orig-fn &rest args)
  "在渲染 markdown 代碼塊的臨時 buffer 中禁用有問題的 hooks。"
  (let ((c-mode-common-hook nil)
        (prog-mode-hook nil))
    (apply orig-fn args)))

(advice-add 'markdown-fontify-code-block-natively :around #'+eglot-fix-markdown-fontify-a)
#+end_src

*** Eglot Booster (可選的性能加速)

如果你安裝了 =emacs-lsp-booster= (一個 Rust 編寫的 JSON-RPC 加速器)，可以取消
以下註釋來獲得顯著的 LSP 性能提升：

#+begin_src emacs-lisp :tangle no
;; (package! eglot-booster :recipe (:host github :repo "jdtsmith/eglot-booster"))
;; (use-package! eglot-booster
;;   :after eglot
;;   :config (eglot-booster-mode))
#+end_src

*** 語言服務器配置

**** C/C++ (clangd)

#+begin_src emacs-lisp
(add-to-list 'eglot-server-programs
             `((c-mode c++-mode c-ts-mode c++-ts-mode)
               . ("clangd"
                  ,(format "-j=%d" (max 2 (/ (num-processors) 2)))
                  "--clang-tidy"
                  "--header-insertion=iwyu"
                  "--completion-style=detailed"
                  "--pch-storage=memory")))
#+end_src

**** Rust (rust-analyzer)

#+begin_src emacs-lisp
(add-to-list 'eglot-server-programs
             '((rust-mode rust-ts-mode) .
               ("rust-analyzer" :initializationOptions
                (:check (:command "clippy")
                 :cargo (:buildScripts (:enable t)
                         :features "all")
                 :procMacro (:enable t)))))
#+end_src

**** Python (pyright)

#+begin_src emacs-lisp
(add-to-list 'eglot-server-programs
             '((python-mode python-ts-mode) .
               ("pyright-langserver" "--stdio"
                :initializationOptions
                (:python (:analysis (:autoSearchPaths t
                                     :useLibraryCodeForTypes t
                                     :diagnosticMode "openFilesOnly"))))))
#+end_src

**** Zig (zls)

#+begin_src emacs-lisp
(add-to-list 'eglot-server-programs
             '((zig-mode zig-ts-mode) . ("zls")))
#+end_src

*** 自動啓動 eglot

在支持的語言模式下自動啓動 eglot：

#+begin_src emacs-lisp
(dolist (hook '(c-mode-hook c++-mode-hook
               c-ts-mode-hook c++-ts-mode-hook
               rust-mode-hook rust-ts-mode-hook
               python-mode-hook python-ts-mode-hook
               zig-mode-hook zig-ts-mode-hook))
  (add-hook hook #'eglot-ensure))
#+end_src

*** Inlay Hints (默認關閉)

Inlay hints 在代碼行內顯示類型標註、參數名等。信息量大但視覺噪音也大。
默認通過 ~eglot-ignored-server-capabilities~ 全局關閉。如果對某些語言想臨時
開啓，可以用快捷鍵切換：

#+begin_src emacs-lisp :tangle yes :noweb-ref nil
(map! :leader
      :prefix ("c" . "code")
      :desc "Toggle inlay hints" "I" #'eglot-inlay-hints-mode)
#+end_src

#+begin_quote
如果之後想對某個語言默認開啓 inlay hints，可以從
~eglot-ignored-server-capabilities~ 中移除 ~:inlayHintProvider~​，
然後在不需要的語言 hook 中調用 ~(eglot-inlay-hints-mode -1)~ 。
#+end_quote

*** DAP (Debug Adapter Protocol)

用 =dape= 來取代過時的 =gud-gdb= 和不穩定的 =dap-mode=​ 。 =dape= 直接使用
DAP 協議，不依賴 lsp-mode，且與 Emacs 內建設施集成良好。

#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! dape :recipe (:host github :repo "svaante/dape"))
#+end_src

#+begin_src emacs-lisp :tangle yes :noweb-ref nil
(use-package! dape
  :defer t
  :init
  ;; 保存所有 buffer 在開始調試前
  (add-hook 'dape-on-start-hooks (lambda () (save-some-buffers t t)))
  :config
  (setq dape-buffer-window-arrangement 'right
        dape-info-hide-mode-line nil
        dape-inlay-hints t)
  ;; 調試結束後關閉自動打開的 buffer
  (add-hook 'dape-on-stopped-hooks 'dape-info)
  (add-hook 'dape-on-stopped-hooks 'dape-repl)
  ;; 快捷鍵
  (map! :leader
        :prefix ("d" . "debug")
        :desc "dape"              "d" #'dape
        :desc "dape next"         "n" #'dape-next
        :desc "dape step in"      "i" #'dape-step-in
        :desc "dape step out"     "o" #'dape-step-out
        :desc "dape continue"     "c" #'dape-continue
        :desc "dape restart"      "r" #'dape-restart
        :desc "dape pause"        "p" #'dape-pause
        :desc "dape breakpoint toggle" "b" #'dape-breakpoint-toggle
        :desc "dape breakpoint remove all" "B" #'dape-breakpoint-remove-all
        :desc "dape eval"         "e" #'dape-evaluate-expression
        :desc "dape watch"        "w" #'dape-watch-dwim
        :desc "dape info"         "?" #'dape-info
        :desc "dape repl"         "R" #'dape-repl
        :desc "dape disconnect"   "q" #'dape-disconnect-quit))
#+end_src

**** 預設調試配置

=dape= 內建了常見 debug adapter 的配置 (codelldb, debugpy, dlv 等)，只需確保
安裝了對應的 debug adapter 即可。以下是各語言推薦的 debug adapter：

- *C/C++*: =codelldb= (推薦) 或 =cppdbg= (MS 提供)
  #+begin_src shell :tangle no
  # 安裝 codelldb (VS Code 擴展中提取，或從 GitHub Release 下載)
  # https://github.com/vadimcn/codelldb/releases
  #+end_src
- *Python*: =debugpy=
  #+begin_src shell :tangle no
  pip install debugpy
  #+end_src
- *Rust*: =codelldb= (同 C/C++)

*** 格式化

不要讓 LSP 污染格式化！使用專門的格式化工具 (如 clang-format, black, rustfmt)。

#+begin_src emacs-lisp :tangle yes :noweb-ref nil
(setq +format-with-lsp nil)
#+end_src

*** Flymake 增強

Flymake 是 Emacs 內建的語法檢查框架，eglot 直接使用它。讓它更好用：

#+begin_src emacs-lisp :tangle yes :noweb-ref nil
(after! flymake
  (map! :leader
        :prefix ("c" . "code")
        :desc "Flymake diagnostics" "x" #'flymake-show-buffer-diagnostics
        :desc "Flymake project diagnostics" "X" #'flymake-show-project-diagnostics))
#+end_src

*** Xref 增強

#+begin_src emacs-lisp :tangle yes :noweb-ref nil
(after! xref
  (setq xref-show-definitions-function #'xref-show-definitions-completing-read
        xref-show-xrefs-function #'xref-show-definitions-completing-read))
#+end_src

** Tree-sitter 增強
   :PROPERTIES:
   :header-args:emacs-lisp: :tangle no :noweb-ref tree-sitter-conf
   :END:

Doom 的 =:tools tree-sitter= 模塊提供了基礎的 tree-sitter 支持（語法高亮、
major-mode 重映射等）。這裏在此基礎上增強 *結構化導航* 和 *結構化編輯* 能力。

*** 結構化導航

Tree-sitter 內建的結構化導航默認已可用 (透過 ~treesit-beginning-of-defun~ 等)。
我們補充更直觀的語法節點導航快捷鍵：

#+begin_src emacs-lisp :tangle yes :noweb-ref nil
(after! treesit
  ;; 讓 treesit 的 defun 導航更精確
  (setq treesit-defun-tactic 'top-level)
  
  ;; 為所有 tree-sitter 模式添加結構化導航快捷鍵
  (defun +treesit-setup-navigation-keys ()
    "為當前 buffer 設置 tree-sitter 結構化導航快捷鍵。"
    (when (treesit-parser-list)
      (local-set-key (kbd "C-M-a") #'treesit-beginning-of-defun)
      (local-set-key (kbd "C-M-e") #'treesit-end-of-defun)))
  
  ;; 在所有使用 tree-sitter 的模式中啟用
  (dolist (mode '(c-ts-mode-hook c++-ts-mode-hook
                  rust-ts-mode-hook python-ts-mode-hook
                  zig-ts-mode-hook js-ts-mode-hook
                  typescript-ts-mode-hook json-ts-mode-hook
                  yaml-ts-mode-hook toml-ts-mode-hook))
    (add-hook mode #'+treesit-setup-navigation-keys)))
#+end_src

*** 結構化編輯 (Combobulate)

[[https://github.com/mickeynp/combobulate][Combobulate]] 是基於 tree-sitter 的結構化編輯工具。
核心功能：

- *語法感知導航*: 按 AST 節點跳轉，比按字符/行高效
- *逐層展選*: 從光標位置逐層擴展選擇到父節點
- *節點拖拽*: 上下移動整個語法節點 (如函數、參數)
- *Envelope*: 快速將選中代碼包裹在 if/for/try 等結構中

#+begin_quote
如果用了一段時間覺得不需要，把下面的代碼塊設為 ~:tangle no~ 即可關閉。
#+end_quote

#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! combobulate :recipe (:host github :repo "mickeynp/combobulate"))
#+end_src

#+begin_src emacs-lisp :tangle yes :noweb-ref nil
(use-package! combobulate
  :after treesit
  :demand t  ; 立即加載，不延遲
  :hook ((python-ts-mode . combobulate-mode)
         (c-ts-mode . combobulate-mode)
         (c++-ts-mode . combobulate-mode)
         (rust-ts-mode . combobulate-mode)
         (js-ts-mode . combobulate-mode)
         (typescript-ts-mode . combobulate-mode)
         (json-ts-mode . combobulate-mode)
         (yaml-ts-mode . combobulate-mode)
         (toml-ts-mode . combobulate-mode))
  :init
  ;; 確保 combobulate 在 tree-sitter 模式啟動時被加載
  (defun +combobulate-setup-h ()
    "確保 combobulate 已加載並啟用。"
    (when (and (treesit-parser-list)
               (fboundp 'combobulate-mode))
      (combobulate-mode 1)))
  
  (dolist (hook '(c-ts-mode-hook c++-ts-mode-hook
                  python-ts-mode-hook rust-ts-mode-hook
                  js-ts-mode-hook typescript-ts-mode-hook
                  json-ts-mode-hook yaml-ts-mode-hook
                  toml-ts-mode-hook))
    (add-hook hook #'+combobulate-setup-h))
  :config
  ;; 基本操作:
  ;; C-c o n / C-c o p  — 同級節點跳轉
  ;; C-c o u / C-c o d  — 上/下層節點
  ;; C-c o U / C-c o D  — 拖拽節點上/下移
  ;; C-c o t            — 用 avy 在可見語法節點間跳轉
  ;; C-c o h            — 逐層擴展選擇
  ;; C-c o e            — envelope（包裹代碼在結構中）
  ;; M-a / M-e          — 按語法導航
  (setq combobulate-flash-node nil)) ;; 不閃爍高亮當前節點
#+end_src

** LSP + Tree-sitter 協同優化
   :PROPERTIES:
   :header-args:emacs-lisp: :tangle yes :noweb-ref nil
   :END:

確保 LSP (語義分析) 和 tree-sitter (語法分析) 協同工作，提供極致開發體驗。

*** 優先使用 tree-sitter 模式

Emacs 30+ 支持 tree-sitter 原生模式 (如 ~c-ts-mode~)。我們確保在支持的情況下
優先使用 tree-sitter 模式，以獲得更好的語法高亮和結構化編輯能力：

#+begin_src emacs-lisp
(after! treesit
  ;; 自動使用 tree-sitter 模式 (如果對應語法庫已安裝)
  (setq major-mode-remap-alist
        '((c-mode          . c-ts-mode)
          (c++-mode        . c++-ts-mode)
          (python-mode     . python-ts-mode)
          (rust-mode       . rust-ts-mode)
          (javascript-mode . js-ts-mode)
          (typescript-mode . typescript-ts-mode)
          (json-mode       . json-ts-mode)
          (yaml-mode       . yaml-ts-mode)
          (toml-mode       . toml-ts-mode))))
#+end_src

*** 性能監控 (可選)

如果想監控 LSP 和 tree-sitter 的性能，可以臨時啟用：

#+begin_src emacs-lisp :tangle no
;; 查看 eglot 與 LSP server 的通信
;; (setq eglot-events-buffer-size 2000000)  ; 啟用事件日志
;; M-x eglot-events-buffer  ; 查看 LSP 通信

;; 查看 tree-sitter 解析性能
;; (setq treesit-font-lock-level 4)  ; 最高語法高亮級別
#+end_src

*** 快捷鍵總結

整合後的常用快捷鍵：

**** LSP (eglot)
- ~SPC c a~ — 代碼操作 (code actions)
- ~SPC c d~ — 查看定義
- ~SPC c D~ — 查看聲明
- ~SPC c r~ — 查找引用
- ~SPC c R~ — 重命名符號
- ~SPC c I~ — 切換 inlay hints
- ~SPC c x~ — 當前 buffer 診斷
- ~SPC c X~ — 整個項目診斷

**** Tree-sitter + Combobulate
- ~C-M-a / C-M-e~ — 跳轉到函數開始/結束
- ~C-c o n / p~ — 跳轉到同級節點
- ~C-c o u / d~ — 跳轉到上/下層節點
- ~C-c o U / D~ — 拖拽節點上/下移
- ~C-c o h~ — 逐層擴展選擇 (很實用！)
- ~C-c o e~ — 包裹代碼在結構中
- ~C-c o t~ — 使用 avy 跳轉到可見節點

**** DAP (dape)
- ~SPC d d~ — 開始調試
- ~SPC d b~ — 切換斷點
- ~SPC d n / i / o~ — 下一步 / 步入 / 步出
- ~SPC d c~ — 繼續執行
- ~SPC d e~ — 計算表達式

*** 最佳實踐建議

1. **項目配置**：在項目根目錄創建 ~compile_commands.json~ (C/C++) 或對應的
   項目配置文件，讓 LSP 能正確理解項目結構

2. **性能調優**：
   - 大型項目：減少 ~-j~ 參數值 (clangd 並行度)
   - 內存受限：使用 ~--pch-storage=disk~ 代替 ~memory~
   - 減少不必要的診斷：調整 LSP server 配置

3. **漸進式采用**：
   - 先熟悉基本的 LSP 功能 (跳轉、補全、診斷)
   - 再學習 tree-sitter 結構化編輯 (逐層選擇、拖拽)
   - 最後掌握 DAP 調試工作流

4. **語言特定優化**：
   - C/C++：確保有 ~compile_commands.json~
   - Rust：使用 ~rust-analyzer~ 的 clippy 檢查
   - Python：配置 ~pyright~ 或 ~pylsp~ 的 type checking 級別
