# SPDX-FileCopyrightText:
# SPDX-License-Identifier: MIT
# Title: Doom Emacs é…ç½®æ–‡ä»¶
#+title: Doom Emacs Configuration
#+html_head: <link rel='shortcut icon' type='image/png' href='https://www.gnu.org/software/emacs/favicon.png'>
#+property: header-args:emacs-lisp :tangle yes :comments link
#+property: header-args:elisp :exports code
#+property: header-args :tangle "no" :results silent :eval no
#+options: coverpage:yes
#+startup: fold
#+latex_compiler: lualatex
#+latex_header: \usepackage{ctex}

#+begin_quote
è®©æˆ‘ä»¬æ”¹å˜å¯¹ç¨‹åºæ„å»ºçš„ä¼ ç»Ÿæ€åº¦ï¼š
ä¸å…¶æƒ³è±¡æˆ‘ä»¬çš„ä¸»è¦ä»»åŠ¡æ˜¯æŒ‡å¯¼è®¡ç®—æœºåšä»€ä¹ˆï¼Œ
ä¸å¦‚ä¸“æ³¨äºå‘äººä»¬è§£é‡Šæˆ‘ä»¬æƒ³è®©è®¡ç®—æœºåšä»€ä¹ˆã€‚
@@latex:\mbox{@@--- é«˜å¾·çº³@@latex:}@@
#+end_quote



* åŸºç¡€é…ç½®

åˆ›å»ºè¯æ³•ç»‘å®šå¯ä»¥ (ç¨å¾®) åŠ é€Ÿé…ç½®æ–‡ä»¶çš„è¿è¡Œã€‚ (æ›´å¤šå†…å®¹å¯ä»¥æŸ¥çœ‹ [[https://nullprogram.com/blog/2016/12/22/][è¿™ç¯‡åšå®¢]])

#+begin_src emacs-lisp :comments no
;;; config.el -*- lexical-binding: t; -*-
#+end_src

#+begin_src shell :exports none :comments no :tangle-mode (identity #o755) :tangle no
#!/usr/bin/env bash
source /etc/os-release
#+end_src

é…ç½®æœ‰ç”¨ä¸”åŸºç¡€çš„ä¸ªäººä¿¡æ¯
#+begin_src emacs-lisp
(setq user-full-name "GinShio"
      user-mail-address "ginshio78@gmail.com"
      org-directory "~/cyberlive"
      )
#+end_src
æ˜¾ç„¶è¿™å¯ä»¥è¢« GPG æˆ–å…¶ä»–ç¨‹åºä½¿ç”¨ã€‚

** è®¾ç½®é»˜è®¤å€¼

å°è¯•ä¸€ä¸‹åˆ«äººçš„é»˜è®¤å€¼ï¼Œæ¯”å¦‚ [[https://github.com/angrybacon/dotemacs/blob/master/dotemacs.org#use-better-defaults][angrybacon/dotemacs]]
#+begin_src emacs-lisp
(setq-default
 delete-by-moving-to-trash t        ; å°†æ–‡ä»¶åˆ é™¤åˆ°å›æ”¶ç«™
 window-combination-resize t        ; ä»å…¶ä»–çª—å£è·å–æ–°çª—å£çš„å¤§å°
 x-stretch-cursor t                 ; å°†å…‰æ ‡æ‹‰ä¼¸åˆ°å­—å½¢å®½åº¦
 )

(setq! undo-limit 104857600         ; é‡ç½®æ’¤é”€é™åˆ¶åˆ° 100 MiB
       auto-save-default t          ; æ²¡æœ‰äººå–œæ¬¢ä¸¢å¤±å·¥ä½œï¼Œæˆ‘ä¹Ÿæ˜¯å¦‚æ­¤
       truncate-string-ellipsis "â€¦" ; Unicode çœç•¥å·ç›¸æ¯” ascii æ›´å¥½
                                    ; åŒæ—¶èŠ‚çœ /å®è´µçš„/ ç©ºé—´
       password-cache-expiry nil    ; æˆ‘èƒ½ä¿¡ä»»æˆ‘çš„ç”µè„‘ ... æˆ–ä¸èƒ½?
       ; scroll-preserve-screen-position 'always
                                    ; ä¸è¦è®© `ç‚¹' (å…‰æ ‡) è·³æ¥è·³å»
       scroll-margin 2              ; é€‚å½“ä¿æŒä¸€ç‚¹ç‚¹è¾¹è·
       gc-cons-threshold 1073741824
       read-process-output-max 1048576
       which-func-unknown ""
       auth-sources `(,(expand-file-name "git/.authinfo" (getenv "XDG_CONFIG_HOME")))
       )

(remove-hook! text-mode #'visual-line-mode)
(add-hook! text-mode #'auto-fill-mode)
(add-hook! window-setup #'toggle-frame-maximized)
                                    ; è®¾ç½®æœ€å¤§åŒ–å¯åŠ¨
(global-subword-mode 1)             ; è¯†åˆ«é©¼å³°ï¼Œè€Œä¸æ˜¯å‚»ç“œå‰è¿›
(global-unset-key (kbd "C-z"))      ; å…³é—­ "C-z" æœ€å°åŒ–
(global-unset-key (kbd "C-s"))      ; å…³é—­ "C-s" æœç´¢åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½ç”± "C-c s s" æ›¿ä»£

(when IS-WINDOWS
  (setq-default buffer-file-coding-system 'utf-8-unix)
  (set-default-coding-systems 'utf-8-unix)
  (prefer-coding-system 'utf-8-unix))
                                    ; å°† Windows ä¸Šçš„ç¼–ç æ”¹ä¸º UTF-8 Unix æ¢è¡Œ

(custom-set-variables '(delete-selection-mode t) ;; delete when you select region and modify
                      '(delete-by-moving-to-trash t) ;; delete && move to transh
                      '(inhibit-compacting-font-caches t) ;; donâ€™t compact font caches during GC.
                      '(gc-cons-percentage 1))

(add-hook! prog-mode (lambda () (setq show-trailing-whitespace 1)))
                                    ; ç¼–ç¨‹æ¨¡å¼ä¸‹è®©ç»“å°¾çš„ç©ºç™½ç¬¦äº®èµ·
(add-hook! prog-mode #'which-function-mode)
#+end_src

å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„ key leaderï¼Œæˆ–è®¸æ²¡ä»€ä¹ˆç”¨
#+begin_src emacs-lisp
(after! general
  (general-create-definer ginshio/leader :prefix "s-y"))
#+end_src

é»˜è®¤æƒ…å†µä¸‹é€šè¿‡è‡ªå®šä¹‰ç•Œé¢æ‰€åšçš„ä¿®æ”¹ä¼šè¢«æ·»åŠ åˆ° =init.el= ä¸­ã€‚
ä¸è¿‡æ­£å¸¸çš„æ–¹æ³•æ˜¯å°†å®ƒä»¬æ”¾åœ¨ =.custom.el= ä¸­ã€‚
#+begin_src emacs-lisp
(setq-default custom-file (expand-file-name ".custom.el" doom-user-dir))
(when (file-exists-p custom-file) (load custom-file))
#+end_src

** Doom é…ç½®

æ‹‰å– doom-emacs ä»“åº“çš„åˆ†æ”¯
  - emacs-version: *29.1*
  - git commit: *03d692f*

*** æ¨¡ç»„
:properties:
:header-args:emacs-lisp: :tangle no
:end:

#+name: init.el
#+attr_html: :collapsed t
#+begin_src emacs-lisp :tangle "init.el" :noweb no-export :comments no
;;; init.el -*- lexical-binding: t; -*-

;; This file controls what Doom modules are enabled and what order they load
;; in. Remember to run 'doom sync' after modifying it!

;; NOTE Press 'SPC h d h' (or 'C-h d h' for non-vim users) to access Doom's
;;      documentation. There you'll find a link to Doom's Module Index where all
;;      of our modules are listed, including what flags they support.

;; NOTE Move your cursor over a module's name (or its flags) and press 'K' (or
;;      'C-c c k' for non-vim users) to view its documentation. This works on
;;      flags as well (those symbols that start with a plus).
;;
;;      Alternatively, press 'gd' (or 'C-c c d') on a module to browse its
;;      directory (for easy access to its source code).

(doom! :input
       <<doom-input>>

       :completion
       <<doom-completion>>

       :ui
       <<doom-ui>>

       :editor
       <<doom-editor>>

       :emacs
       <<doom-emacs>>

       :term
       <<doom-term>>

       :checkers
       <<doom-checkers>>

       :tools
       <<doom-tools>>

       :os
       <<doom-os>>

       :lang
       <<doom-lang>>

       :email
       <<doom-email>>

       :app
       <<doom-app>>

       :config
       <<doom-config>>
       )
#+end_src

**** ç»“æ„

è¿™æ˜¯ä¸€ç¯‡æ–‡å­¦ç¼–ç¨‹ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ Doom Emacs çš„é…ç½®æ–‡ä»¶ã€‚Doom å¯¹å…¶æ”¯æŒè‰¯å¥½ï¼Œæ›´å¤šè¯¦æƒ…
å¯ä»¥é€šè¿‡ ~literate~ (æ–‡å­¦) æ¨¡å—äº†è§£ã€‚

#+name: doom-config
#+begin_src emacs-lisp
literate
(default +bindings +smartparens)
#+end_src

**** æ¥å£

å¯ä»¥åšå¾ˆå¤šäº‹æ¥å¢å¼º Emacs çš„åŠŸèƒ½ï¼Œã€‚

- è¾“å…¥ ::
  ä¸­æ—¥æ–‡è¾“å…¥ä¸é”®ç›˜å¸ƒå±€
  #+name: doom-input
  #+begin_src emacs-lisp
;;bidi              ; (tfel ot) thgir etirw uoy gnipleh
;;chinese
;;japanese
;;layout            ; auie,ctsrnm is the superior home row
  #+end_src

- è¡¥å…¨ ::
  æˆ–è®¸å«è¡¥å…¨æœ‰ç‚¹ä¸åˆé€‚ï¼Œä¸è¿‡ä¹Ÿå°±è¿™æ ·äº†ã€‚å¦å¤–è¯´ä¸€ä¸‹ï¼Œ ~helm~ ã€ ~ido~ ã€ ~ivy~ ä»¥
  åŠ ~vertico~ æ˜¯åŠŸèƒ½ä¸€è‡´çš„ï¼Œç”Ÿæ€ä¸åŒçš„å››ä¸ªåŒ…ã€‚
  #+name: doom-completion
  #+begin_src emacs-lisp
;;(company          ; the ultimate code completion backend
;; +childframe)
(corfu              ; complete with cap(f), cape and a flying feather!
 +icons
 +orderless)
;;helm              ; the *other* search engine for love and life
;;ido               ; the other *other* search engine...
;;(ivy              ; a search engine for love and life
;; +icons           ; ... icons are nice
;; +prescient)      ; ... I know what I want(ed)
(vertico +icons)    ; the search engine of the future
  #+end_src

- UI :: å¥½ä¸å¥½çœ‹å°±çœ‹ä½ è¿™ä¹ˆé…ç½®äº†
  #+name: doom-ui
  #+begin_src emacs-lisp
;;deft              ; notational velocity for Emacs
doom                ; what makes DOOM look the way it does
doom-dashboard      ; a nifty splash screen for Emacs
;;doom-quit         ; DOOM quit-message prompts when you quit Emacs
;;(emoji
;; +unicode +github); ğŸ™‚
hl-todo             ; highlight TODO/FIXME/NOTE/DEPRECATED/HACK/REVIEW
;;indent-guides     ; highlighted indent columns
;;(ligatures +extra); ligatures and symbols to make your code pretty again
;;minimap           ; show a map of the code on the side
modeline            ; snazzy, Atom-inspired modeline, plus API
;;nav-flash         ; blink cursor line after big motions
;;neotree           ; a project drawer, like NERDTree for vim
ophints             ; highlight the region an operation acts on
;;(popup            ; tame sudden yet inevitable temporary windows
;; +all             ; catch all popups that start with an asterix
;; +defaults)       ; default popup rules
;;tabs              ; a tab bar for Emacs
;;treemacs          ; a project drawer, like neotree but cooler
;;unicode           ; extended unicode support for various languages
(vc-gutter +pretty) ; vcs diff in the fringe
vi-tilde-fringe     ; fringe tildes to mark beyond EOB
(window-select      ; visually switch windows
 +numbers)          ; Enable numbered windows and window selection
workspaces          ; tab emulation, persistence & separate workspaces
;; zen              ; distraction-free coding or writing
  #+end_src

- ç¼–è¾‘å™¨ :: *VI VI VI Editor of the Beast*
  #+name: doom-editor
  #+begin_src emacs-lisp
;;(evil +everywhere); come to the dark side, we have cookies
file-templates      ; auto-snippets for empty files
fold                ; (nigh) universal code folding
format              ; automated prettiness
;;god               ; run Emacs commands without modifier keys
;;lispy             ; vim for lisp, for people who don't like vim
multiple-cursors    ; editing in many places at once
;;objed             ; text object editing for the innocent
;;parinfer          ; turn lisp into python, sort of
;;rotate-text       ; cycle region at point between text candidates
snippets            ; my elves. They type so I don't have to
;;word-wrap         ; soft wrapping with language-aware indent
  #+end_src

- Emacs :: å¢å¼ºä¸€ä¸‹å§ï¼Œä¸ç„¶çœŸçš„æ˜¯ç¬”è®°æœ¬äº† (å…¶å®ä¸æ˜¯
  #+name: doom-emacs
  #+begin_src emacs-lisp
(dired              ; making dired pretty [functional]
 +icons)
electric            ; smarter, keyword-based electric-indent
;;eww               ; the internet is gross
(ibuffer +icons)    ; interactive buffer management
undo                ; persistent, smarter undo for your inevitable mistakes
vc                  ; version-control and Emacs, sitting in a tree
  #+end_src

- ç»ˆç«¯ :: ä¹Ÿè®¸æˆ‘åº”è¯¥å¸è½½æ‰æˆ‘çš„ =Konsole=
  #+name: doom-term
  #+begin_src emacs-lisp
;;eshell            ; the elisp shell that works everywhere
;;shell             ; simple shell REPL for Emacs
;;term              ; basic terminal emulator for Emacs
vterm               ; the best terminal emulation in Emacs
  #+end_src

- æ£€æµ‹ :: å¯ä»¥å‘Šè¯‰æˆ‘å“ªé‡Œä¸å¯¹ï¼Œä½†æˆ‘è§‰å¾—æˆ‘åº”è¯¥å…ˆå¥½å¥½èƒŒèƒŒå•è¯æˆ–è€…çœ‹çœ‹ PEP8
  #+name: doom-checkers
  #+begin_src emacs-lisp
syntax              ; tasing you for every semicolon you forget
;;(spell +flyspell) ; tasing you for misspelling mispelling
;;grammar           ; tasing grammar mistake every you make
  #+end_src

- å·¥å…· :: Workflow in Emacs!
  #+name: doom-tools
  #+begin_src emacs-lisp
;;ansible
biblio              ; Writes a PhD for you (citation needed)
;;collab            ; buffers with friends
;;(debugger +lsp)   ; FIXME stepping through code, to help you add bugs
;;direnv
;;docker
editorconfig        ; let someone else argue about tabs vs spaces
;;ein               ; tame Jupyter notebooks with emacs
(eval +overlay)     ; run code, run (also, repls)
;;llm               ; when I said you needed friends, I didn't mean...
lookup              ; helps you navigate your code and documentation
(lsp +eglot)        ; M-x vscode
(magit              ; a git porcelain for Emacs
 +forge)            ; interface with git forges
make                ; run make tasks from Emacs
;;pass              ; password manager for nerds
;;pdf               ; pdf enhancements
;;terraform         ; infrastructure as code
;;tmux              ; an API for interacting with tmux
tree-sitter         ; syntax and parsing, sitting in a tree...
;;upload            ; map local to remote projects via ssh/ftp
  #+end_src

- OS :: æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä¼šç”¨ MAC å—
  #+name: doom-os
  #+begin_src emacs-lisp
(:if (featurep :system 'macos) macos)  ; improve compatibility with macOS
tty                 ; improve the terminal Emacs experience
  #+end_src

**** ç¼–ç¨‹è¯­è¨€æ”¯æŒ

æœ€çˆ½çš„äº‹æƒ…å°±æ˜¯ï¼Œæˆ‘å¯ä»¥åœ¨ Emacs ä¸­ç¼–å†™ä»»ä½•è¯­è¨€ (çš„ ~Hello World~)

#+name: doom-lang
#+begin_src emacs-lisp
;;agda                ; types of types of types of types...
;;beancount           ; mind the GAAP
(cc                   ; C > C++ == 1
 +lsp                 ; smart C but still memory leak
 +tree-sitter)
;;clojure             ; java with a lisp
;;common-lisp         ; if you've seen one lisp, you've seen them all
;;coq                 ; proofs-as-programs
;;crystal             ; ruby at the speed of c
;;csharp              ; unity, .NET, and mono shenanigans
data                  ; config/data formats
;;(dart +flutter)     ; paint ui and not much else
;;dhall
;;elixir              ; erlang done right
;;elm                 ; care for a cup of TEA?
emacs-lisp            ; drown in parentheses
;;erlang              ; an elegant language for a more civilized age
;;ess                 ; emacs speaks statistics
;;factor
;;faust               ; dsp, but you get to keep your soul
;;fortran             ; in FORTRAN, GOD is REAL (unless declared INTEGER)
;;fsharp              ; ML stands for Microsoft's Language
;;fstar               ; (dependent) types and (monadic) effects and Z3
;;gdscript            ; the language you waited for
;;(go +lsp)           ; the hipster dialect
;;(graphql +lsp)      ; Give queries a REST
;;(haskell +lsp)      ; a language that's lazier than I am
;;hy                  ; readability of scheme w/ speed of python
;;idris               ; a language you can depend on
;;json                ; At least it ain't XML
;;janet               ; Fun fact: Janet is me!
;;(java +lsp)         ; the poster child for carpal tunnel syndrome
;;(javascript +lsp)   ; all(hope(abandon(ye(who(enter(here))))))
;;julia               ; a better, faster MATLAB
;;kotlin              ; a better, slicker Java(Script)
(latex                ; writing papers in Emacs has never been so fun
 +cdlatex             ; quick maths symbols
 +fold)               ; fold the clutter away nicities
;;lean                ; for folks with too much to prove
;;ledger              ; be audit you can be
;;lua                 ; one-based indices? one-based indices
markdown              ; writing docs for people to ignore
;;nim                 ; python + lisp at the speed of c
;;nix                 ; I hereby declare "nix geht mehr!"
;;ocaml               ; an objective camel
(org                  ; organize your plain life in plain text
 +crypt               ;
 +dragndrop           ; drag & drop files/images into org buffers
 +hugo                ; use Emacs for hugo blogging
 +pandoc)             ; export-with-pandoc support
;;php                 ; perl's insecure younger brother
;;plantuml            ; diagrams for confusing people more
;;purescript          ; javascript, but functional
(python               ; beautiful is better than ugly
 +cython
 +lsp
 +pyenv
 +pyright
 +tree-sitter)
;;qt                  ; the 'cutest' gui framework ever
;;racket              ; a DSL for DSLs
;;raku                ; the artist formerly known as perl6
;;rest                ; Emacs as a REST client
;;rst                 ; ReST in peace
;;(ruby +tree-sitter) ; 1.step {|i| p "Ruby is #{i.even? ? 'love' : 'life'}"}
(rust                 ; Fe2O3.unwrap().unwrap().unwrap().unwrap()
 +lsp
 +tree-sitter)
;;scala               ; java, but good
(scheme +guile)       ; a fully conniving family of lisps
sh                    ; she sells {ba,z,fi}sh shells on the C xor
;;sml
;;solidity            ; do you need a blockchain? No.
;;swift               ; who asked for emoji variables?
;;terra               ; Earth and Moon in alignment for performance.
;;web                 ; the tubes
;;yaml                ; JSON, but readable
(zig                ; C, but simpler
 +lsp
 +tree-sitter)
#+end_src

**** Everything in Emacs

*leave* Emacs

- é‚®ä»¶ :: è¯´å®è¯ï¼Œæˆ‘æƒ³ç”¨ =Thunderbird=
  #+name: doom-email
  #+begin_src emacs-lisp
;;(mu4e +org +gmail)
;;notmuch
;;(wanderlust +gmail)
  #+end_src

- åº”ç”¨ :: å¯ä»¥åœ¨ Emacs ä¸­ä¸Šç½‘çœ‹æ–°é—»ã€‚æˆ–è®¸æˆ‘å¯ä»¥ç”¨ irc èŠå¤©
  #+name: doom-app
  #+begin_src emacs-lisp
;;calendar
;;emms
;;everywhere        ; *leave* Emacs!? You must be joking
;;irc               ; how neckbeards socialize
;;(rss +org)        ; emacs as an RSS reader
  #+end_src

*** è§†è§‰è®¾ç½®

**** å­—ä½“è®¾ç½®

'Source Code Pro' å’Œ 'Fira Code' çš„æ•ˆæœéƒ½å¾ˆä¸é”™ï¼Œ'JetBrains Mono' å’Œ 'IBM Plex Mono'
æˆ–è®¸ä¹Ÿä¸é”™ã€‚è¿˜æ˜¯æ¯”è¾ƒæ¨è Mono å­—ä½“ï¼Œç­‰å®½çœ‹ä»£ç èˆ’æœã€‚


Unicode å­—ä½“ä¸ºä»€ä¹ˆä¸è¯•è¯• 'JuliaMono' å‘¢ï¼Ÿ

#+begin_src emacs-lisp
(setq doom-font (font-spec :family "Source Code Pro" :size 15)
      doom-big-font (font-spec :family "Source Code Pro" :size 30)
      doom-variable-pitch-font (font-spec :family "SourceCodeVF" :size 15)
      doom-unicode-font (font-spec :family "JuliaMono")
      doom-serif-font (font-spec :family "Source Serif 4")
      )
#+end_src

ä¸è¿‡è¿™éƒ½æ˜¯è¥¿æ–‡å­—ä½“ï¼Œæ²¡æœ‰è€ƒè™‘è¿‡ CJK ç”¨æˆ·çš„æ„Ÿå—å—ï¼ï¼åœ¨åé¢çš„
[[æ‚é¡¹][æ‚é¡¹]] ä¸­ï¼Œå°†è¯¦ç»†è¯´ä¸€ä¸‹ CJK å­—ä½“çš„é…ç½®ã€‚

é™¤äº†è¿™äº›å­—ä½“å¤–ï¼Œå­—ä½“ [[https://github.com/SorkinType/Merriweather/][Merriweather]] è¿˜è¢«ç”¨äº =nov.el= ä¸­ï¼Œå­—ä½“ [[https://github.com/huertatipografica/Alegreya][Alegreya]] ä½œä¸ºè¡¬çº¿æ¯”
ä¾‹å­—ä½“è¢«ç”¨äº Org æ–‡ä»¶çš„ =writeroom-mode= ä¸­çš„ =mixed-pitch-mode=â€‹ã€‚

**** ä¸»é¢˜å’Œ modeline

~doom-one~ æ˜¯ Doom è‡ªå¸¦çš„å¤§è€Œå…¨çš„ä¸»é¢˜ï¼Œé‡Œé¢å®åœ¨å¤ªå¤šå¥½çœ‹çš„ä¸»é¢˜äº†ï¼Œå¹²å˜›è¿˜è¦è‡ªå·±æ‰¾ã€‚
è¿™é‡Œæˆ‘æƒ³åœ¨ä¼—å¤šæˆ‘å–œæ¬¢çš„ä¸»é¢˜ä¸­ï¼Œå¯åŠ¨æ—¶éšæœºé€‰å–ä¸€æ¬¾ã€‚

#+begin_src emacs-lisp :tangle no
(setq doom-theme (let ((themes '(doom-vibrant
                                 doom-fairy-floss
                                 doom-dracula
                                 doom-Iosvkem
                                 doom-moonlight
                                 doom-monokai-pro
                                 doom-tokyo-night)))
                   (elt themes (random (length themes)))))
#+end_src

å½“ç„¶ä½ ä¸å–œæ¬¢è¿™æ ·ï¼Œå¯ä»¥ç›´æ¥æŒ‡å®šä¸€æ¬¾ã€‚å¦å¤–ï¼Œä½ å¯ä»¥é‡‡ç”¨å¿«æ·é”® =C-h t= æ¥é¢„è§ˆå¹¶é€‰æ‹©
å„ä¸ªä¸»é¢˜ï¼ˆå½“ç„¶æ˜¯ä¸€æ¬¡æ€§çš„ï¼‰ã€‚
#+begin_src emacs-lisp :tangle no
(setq doom-theme 'doom-vibrant)
#+end_src

Timothy æœ‰ä¸€ä¸ªç›¸å½“æœ‰è¶£çš„åšæ³•ï¼Œæ ¹æ®ç³»ç»Ÿä¸»é¢˜é€‰æ‹©å¯¹åº”çš„ä¸»é¢˜ã€‚å½“ç„¶ï¼Œä»ç¯å¢ƒå˜é‡ =DOOM_THEME= ä¸­å»è¯»ä¹Ÿæ˜¯ç›¸å½“æ£’çš„ã€‚

è®¾ç½®ä¸€ä¸‹ modelineï¼Œæ¯”å¦‚è¯´å›¾æ ‡ã€æ–‡ä»¶åç§°ä»¥åŠå½©è™¹çŒ« (Nyan cat)ï¼
#+begin_src emacs-lisp
(after! doom-modeline
  (custom-set-variables '(doom-modeline-buffer-file-name-style 'relative-to-project)
                        '(doom-modeline-major-mode-icon t)
                        '(doom-modeline-modal-icon nil))
  (nyan-mode t))
#+end_src

**** æ‚é¡¹

ç›¸å¯¹è¡Œå·å¯ä»¥å¾ˆå¥½çš„çŸ¥é“è·ç¦»ç›®æ ‡è¡Œæœ‰å¤šè¿œï¼Œç„¶åç”¨å¿«æ·é”® =C-u num <UP>= æˆ–
=ESC num <UP>= åˆ°è¾¾ä½ æƒ³å»çš„è¡Œã€‚
#+begin_src emacs-lisp
(setq display-line-numbers-type 'relative)
#+end_src

æˆ‘æƒ³è®¾ç½®ä¸€ä¸‹æ›´å¥½çœ‹çš„é»˜è®¤ç¼“å†²åŒºåç§°
#+begin_src emacs-lisp
(setq doom-fallback-buffer-name "â–º Doom"
      +doom-dashboard-name "â–º Doom")
#+end_src

å†æ¥è¯´è¯´åˆå§‹åŒ– doom æ—¶ï¼ŒUI ä¸Šå…¶å®è¿˜æœ‰å¾ˆå¤šèƒ½åšçš„ï¼Œæ¯”å¦‚è¯´å…³é—­ä¸‘çš„ä¸è¡Œçš„ ~menu-bar~â€‹ï¼Œ
è®¾ç½®å…‰æ ‡æ¨¡å¼ï¼Œä»¥åŠ CJK å­—ä½“ç­‰ã€‚

éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œå­—ä½“åœ¨ GUI ä¸‹æ˜¯æœ‰æ•ˆçš„ï¼ŒTUI ä¸‹ä½¿ç”¨çš„åº”è¯¥æ˜¯ç»ˆç«¯è®¾ç½®ã€‚å¦å¤–ï¼Œä½¿ç”¨ mono
å­—ä½“æ—¶ï¼ŒCJK ä¸€èˆ¬æ˜¯è¥¿æ–‡å­—å·çš„ =1.2= å€ï¼Œè¿™æ ·ä¸€ä¸ª CJK ç¬¦å·å°†æ˜¯è¥¿æ–‡ç¬¦å·çš„ =2= å€ã€‚
æ¯”è¾ƒå»ºè®®è¥¿æ–‡å­—ä½“è®¾ç½®ä¸º =5= çš„å€æ•°ï¼Œè¿™æ ·å¾—åˆ°çš„ CJK å­—ç¬¦éƒ½èƒ½æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ã€‚

#+begin_src emacs-lisp :tangle yes :noweb no-export :comments no
(defun ginshio/doom-init-ui-misc()
  (menu-bar-mode -1)               ;; disable menu-bar
  (tab-bar-mode -1)                ;; disable tab-bar
  (setq-default cursor-type 'box)  ;; set box style cursor
  (blink-cursor-mode -1)           ;; cursor not blink
  <<doom-dashboard-layout>>
  (if (display-graphic-p)
      (progn
        ;; NOTE: ONLY GUI
        ;; set font
        (dolist (charset '(kana han bopomofo))
          (set-fontset-font (frame-parameter nil 'font) charset
                            (font-spec :family "Source Han Mono SC")))
        (appendq! face-font-rescale-alist
                  '(("Source Han Mono SC" . 1.2)))
        <<doom-image-banner>>
        ;; random banner image from bing.com, NOTE: https://emacs-china.org/t/topic/264/33
        )
    (progn
      ;; NOTE: ONLY TUI
      <<doom-ascii-banner>>
      )))
(add-hook! doom-init-ui #'ginshio/doom-init-ui-misc)
#+end_src

*** è¾…åŠ©å®
è¿™äº›æ˜¯ doom æ·»åŠ çš„ä¸€äº›éå¸¸æœ‰ç”¨çš„å®
- ~load!~ å¯ä»¥ç›¸å¯¹äºæœ¬æ–‡ä»¶è¿›è¡Œå¤–éƒ¨ ~.el~ æ–‡ä»¶çš„åŠ è½½
- ~use-package!~ ç”¨äºé…ç½®åŒ…
- ~add-load-path!~ å°†æŒ‡å®šç›®å½•æ·»åŠ åˆ° ~load-path~ ä¸­ï¼Œå¯ä»¥è®© Emacs åœ¨ä½¿ç”¨
  ~require~ å’Œ ~use-package~ æ—¶åœ¨ ~load-path~ ä¸­è¿›è¡ŒæŸ¥æ‰¾
- ~map!~ ç”¨äºç»‘å®šæ–°çš„å¿«æ·é”®

*** å…è®¸ CLI è¿è¡Œ org-babel ç¨‹åº

åœ¨ Org ä¸­æœ‰æ—¶ä¼šå†™ä¸€ç‚¹ä»£ç ï¼Œ[[https://orgmode.org/worg/org-contrib/babel][Org-Babel]] å°±æ˜¯å„ä¸ªè¯­è¨€åœ¨ Org-mode ä¸­çš„å·´åˆ«å¡”ã€‚å¤§å®¶éƒ½
å¯ä»¥é€šè¿‡å®ƒæ¥ç›´æ¥è¿è¡Œã€‚

ä½†æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¹Ÿä¼šæœ‰ä¸€äº›ä»£ç ï¼Œå¦‚æœåœ¨ CLI ä¸­æ‰§è¡Œ =doom sync= ä¹‹ç±»çš„æ“ä½œï¼Œå¤§é‡çš„
ä»£ç å—è¾“å‡ºä¼šç›´æ¥æ±¡æŸ“è¾“å‡ºã€‚è¿™ä¸èƒ½å¿ï¼

å¥½åœ¨ DOOM æä¾›äº†æ¯æ¬¡è¿è¡Œ CLI å‰è¯»å– =$DOOMDIR/cli.el= çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å†æ‰‹åŠ¨
ç¡®è®¤æ˜¯å¦è¿è¡ŒæŸä¸ªä»£ç å— (~org-confirm-babel-evaluate~)ï¼Œå¹¶ä¸”ç”¨
~org-babel-execute-src-block~ æ¥æ²‰é»˜è¿™äº›ä»£ç å—ï¼Œé¿å…æ±¡æŸ“è¾“å‡ºã€‚

#+begin_src emacs-lisp :tangle cli.el :comments no
;;; cli.el -*- lexical-binding: t; -*-
(setq! org-confirm-babel-evaluate nil)
(advice-add 'org-babel-execute-src-block
            :around #'(lambda (orig-fn &rest args)
                        (quiet! (apply orig-fn args))))
#+end_src

*** dashboard

Dashboard æ˜¯æ‰“å¼€ Emacs çš„ä¸»é¡µï¼Œå±•ç¤ºå‘½ä»¤å¹¶ä¸æ˜¯å¾ˆæœ‰ç”¨ï¼Œç§»é™¤æ‰å®ƒä»¬ï¼
#+name: doom-dashboard-layout
#+begin_src emacs-lisp :tangle no
(remove-hook! '+doom-dashboard-functions #'doom-dashboard-widget-shortmenu)
(add-hook! +doom-dashboard-mode (hide-mode-line-mode 1) (hl-line-mode 1))
#+end_src

** å…¶ä»–è®¾ç½®

*** çª—å£æ ‡é¢˜

æˆ‘æ›´å–œæ¬¢çª—å£å±•ç¤ºç¼“å†²åŒºçš„åå­—ï¼Œç„¶åæ˜¯é¡¹ç›®æ–‡ä»¶å¤¹ (å¦‚æœå¯ç”¨)ã€‚
#+begin_src emacs-lisp
(setq! frame-title-format
      '("%b â€“ Doom Emacs"
        (:eval
         (let ((project-name (projectile-project-name)))
           (unless (string= "-" project-name)
             (format "  -  [%s]" project-name))))))
#+end_src

*** å¯åŠ¨ç•Œé¢

[[https://github.com/tecosaur][tecosaur]] åšäº†ä¸€ä¸ªç›¸å½“æ£’çš„å¯åŠ¨ç”»é¢ï¼Œå¿ƒåŠ¨ï¼ä½†æ˜¯å¤ªå¤æ‚äº†ã€‚æˆ‘åªæ˜¯æƒ³ç®€å•çš„åœ¨æ¯æ¬¡é‡å¯æ—¶
æ›´æ¢ bannerï¼Œä»…æ­¤è€Œå·²ã€‚

#+name: doom-image-banner
#+begin_src emacs-lisp :tangle no
(setq! fancy-splash-image
       (let ((banners (directory-files (expand-file-name "banners" doom-user-dir)
                                       'full (rx ".png" eos))))
         (elt banners (random (length banners)))))
#+end_src

å½“ç„¶ï¼Œä¸è¦å¿˜è®° ASCII banner
#+name: doom-ascii-banner
#+begin_src emacs-lisp :tangle no
(setq! ginshio/+doom-dashbord-ascii-banner
       (split-string (with-output-to-string
                       (call-process "cat" nil standard-output nil
                                     (let ((banners (directory-files (expand-file-name "banners" doom-user-dir)
                                                                     'full (rx ".txt" eos))))
                                       (elt banners (random (length banners))))))
                     "\n" t))
(setq! +doom-dashboard-ascii-banner-fn
       #'(lambda ()
           (mapc (lambda (line)
                   (insert (propertize (+doom-dashboard--center +doom-dashboard--width line)
                                       'face 'doom-dashboard-banner) " ")
                   (insert "\n"))
                 ginshio/+doom-dashbord-ascii-banner)))
#+end_src

*** ä»¥å­—ç¬¦ä¸²å½¢å¼æŠ“å–æºä»£ç å—å†…å®¹

åœ¨æ­¤é…ç½®ä¸­ï¼Œæœ‰å‡ å¤„éœ€è¦ä»¥å­—ç¬¦ä¸²å½¢å¼æŠ“å–æºä»£ç å—çš„å†…å®¹çš„å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨
noweb =<<replacement>>= è¡¨å•ï¼Œä½†è¯¥è¡¨å•æ— æ³•ä½¿ç”¨å­—ç¬¦ä¸²è½¬ä¹‰ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ noweb æ‰§è¡Œæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ç¼–å†™ä¸€ä¸ªåä¸ºï¼ˆæœªå¯¼å‡ºçš„ï¼‰ babel ä»£ç å—ï¼Œ
ä»¥å­—ç¬¦ä¸²å½¢å¼æŠ“å–å¦ä¸€ä¸ªå‘½åæºä»£ç å—çš„å†…å®¹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•ç›®å‰ä¸èƒ½æ‰©å±•
åµŒå¥—çš„ noweb å¼•ç”¨ã€‚

#+name: grab
#+begin_src emacs-lisp :var name="" :noweb-ref none
;; (if-let ((block-pos (org-babel-find-named-block name))
;;          (block (org-element-at-point block-pos)))
;;     (format "%S" (string-trim (org-element-property :value block)))
;;   ;; look for :noweb-ref matches
;;   (let (block-contents)
;;     (org-element-cache-map
;;      (lambda (src)
;;        (when (and (not (org-in-commented-heading-p nil src))
;;                   (not (org-in-archived-heading-p nil src))
;;                   (let* ((lang (org-element-property :language src))
;;                          (params
;;                           (apply
;;                            #'org-babel-merge-params
;;                            (append
;;                             (org-with-point-at (org-element-property :begin src)
;;                               (org-babel-params-from-properties lang t))
;;                             (mapcar
;;                              (lambda (h)
;;                                (org-babel-parse-header-arguments h t))
;;                              (cons (org-element-property :parameters src)
;;                                    (org-element-property :header src))))))
;;                          (ref (alist-get :noweb-ref params)))
;;                     (equal ref name)))
;;          (push (org-babel--normalize-body src)
;;                block-contents)))
;;      :granularity 'element
;;      :restrict-elements '(src-block))
;;     (and block-contents
;;          (format "%S"
;;                  (mapconcat
;;                   #'identity
;;                   (nreverse block-contents)
;;                   "\n\n")))))
#+end_src

There we go, that's all it takes! This can be used via the form =<<grab("block-name")>>=.



* åŒ…

** åŠ è½½ç»“æ„
:properties:
:header-args:emacs-lisp: :tangle no
:end:

Doom é€šè¿‡ =packages.el= æ¥å®‰è£…åŒ…ï¼Œéå¸¸ç®€å•ï¼Œåªéœ€è¦ ~package!~ å°±å¯ä»¥å®‰è£…ã€‚
éœ€è¦æ³¨æ„ï¼Œä¸åº”è¯¥å°†è¯¥æ–‡ä»¶ç¼–è¯‘ä¸ºå­—èŠ‚ç ã€‚
#+begin_src emacs-lisp :tangle "packages.el" :comments no
;; -*- no-byte-compile: t; -*-
;;; $DOOMDIR/packages.el
#+end_src

*è­¦å‘Š*: ä¸è¦ç¦ç”¨ =~/.emacs.d/core/packages.el= ä¸­åˆ—å‡ºçš„åŒ…ã€‚Doom ä¾èµ–è¿™äº›ï¼Œç¦ç”¨å®ƒä»¬
å¯èƒ½å‡ºç°ä¸¥é‡é—®é¢˜ã€‚

- ä»å®˜æ–¹çš„æº [[https://melpa.org/][MELPA]] / [[http://elpa.gnu.org/][GNU ELPA]] / [[https://emacsmirror.net/][emacsmirror]] å®‰è£…
  #+begin_src emacs-lisp
(package! some-package)
  #+end_src
- å…³é—­æŸäº›åŒ…
  #+begin_src emacs-lisp
(package! some-package :disable t)
  #+end_src
- ä» Git Repo å®‰è£…
  #+begin_src emacs-lisp
;; github
(package! github-package :recipe (:host github :repo "username/repo"))
;; gitlab
(package! gitlab-package :recipe (:host gitlab :repo "username/repo"))
;; other
(package! other-package :recipe (:host nil :repo "https://example.com/repo"))
  #+end_src
  å¦‚æœ repo ä»…ä¸­åªæœ‰æŸä¸ª / æŸäº›æ–‡ä»¶æ˜¯ä½ éœ€è¦çš„
  #+begin_src emacs-lisp
(package! some-package
  :recipe (:host github :repo "username/repo"
           :files ("some-file.el" "src/elisp/*.el")))
  #+end_src
  å¦‚æœéœ€è¦æŒ‡å®šæŸä¸ª =commit= æˆ–æŸä¸ª =branch=
  #+begin_src emacs-lisp
;; commit
(package! some-package :pin "abcdefghijk")
;; branch
(package! some-package :recipe (:branch "stable"))
  #+end_src
- ä½¿ç”¨æœ¬åœ°çš„ repo
  #+begin_src emacs-lisp
(package! some-package :recipe (:local-repo "/path/to/repo"))
  #+end_src

** å·¥å…·

*** Which-key

#+begin_comment
æ¥è‡ª =:core packages= æ¨¡å—
#+end_comment

è®©å¿«æ·é”®æç¤ºå˜å¾—æ›´å¿«ï¼
#+begin_src emacs-lisp
(setq which-key-idle-delay 0.5)
#+end_src

*** Input

**** String Inflection

+å˜å½¢æ±½è½¦äººï¼+ å˜å½¢å­—ç¬¦ä¸²ï¼
#+begin_src emacs-lisp :tangle packages.el
(package! string-inflection)
#+end_src

#+begin_src emacs-lisp
(use-package! string-inflection
  :defer t
  :init
  (map! :leader :prefix ("cS" . "naming convention")
        :desc "cycle" "~" #'string-inflection-all-cycle
        :desc "toggle" "t" #'string-inflection-toggle
        :desc "CamelCase" "c" #'string-inflection-camelcase
        :desc "downCase" "d" #'string-inflection-lower-camelcase
        :desc "kebab-case" "k" #'string-inflection-kebab-case
        :desc "under_score" "u" #'string-inflection-underscore
        :desc "Upper_Score" "_" #'string-inflection-capital-underscore
        :desc "UP_CASE" "U" #'string-inflection-upcase))
#+end_src

*** hungry delete

ä¸€æ¬¡ ~backspace~ åƒæ‰æ‰€æœ‰ç©ºç™½ç¬¦ (å½“å‰å…‰æ ‡é™å®š)
#+begin_src emacs-lisp :tangle packages.el
(package! hungry-delete :recipe (:host github :repo "nflath/hungry-delete"))
#+end_src

åªè®©å®ƒåº”ç”¨åœ¨ç¼–ç¨‹æ¨¡å¼æ˜¯æœ€å¥½çš„
#+begin_src emacs-lisp
(use-package! hungry-delete
  :config
  (setq-default hungry-delete-chars-to-skip " \t\v")
  (add-hook! prog-mode #'hungry-delete-mode))
#+end_src

*** Dired

#+begin_comment
æ¥è‡ª =:emacs dired= æ¨¡å—
#+end_comment

emacs è‡ªå¸¦çš„å¼ºå¤§æ–‡ä»¶ç®¡ç†å™¨ï¼Œå’Œä¹‹åæåˆ°çš„ [[Magit]]ã€[[TRAMP]] éƒ½æ˜¯ Emacs çš„æ€æ‰‹çº§åº”ç”¨ã€‚
è¿˜å‡ºç°äº†å¾ˆå¤šå¢å¼ºæ€§çš„åŒ…æ¥å¢åŠ å…¶èƒ½åŠ›ï¼Œä¸è¿‡å¯¹æˆ‘æ¥è¯´ï¼Œç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä¹Ÿå°±å¤Ÿäº†ã€‚

#+begin_src emacs-lisp
(after! dired
  (require 'dired-async)
  (define-key! dired-mode-map "RET" #'dired-find-alternate-file)
  (define-key! dired-mode-map "C" #'dired-async-do-copy)
  (define-key! dired-mode-map "H" #'dired-async-do-hardlink)
  (define-key! dired-mode-map "R" #'dired-async-do-rename)
  (define-key! dired-mode-map "S" #'dired-async-do-symlink)
  (define-key! dired-mode-map "n" #'dired-next-marked-file)
  (define-key! dired-mode-map "p" #'dired-prev-marked-file)
  (define-key! dired-mode-map "=" #'ginshio/dired-ediff-files)
  (define-key! dired-mode-map "<mouse-2>" #'dired-mouse-find-file)
  (defun ginshio/dired-ediff-files ()
    "Mark files and ediff in dired mode, you can mark 1, 2 or 3 files and diff.
see: https://oremacs.com/2017/03/18/dired-ediff/"
    (let ((files (dired-get-marked-files)))
      (cond ((= (length files) 0))
            ((= (length files) 1)
             (let ((file1 (nth 0 files))
                   (file2 (read-file-name "file: " (dired-dwim-target-directory))))
               (ediff-files file1 file2)))
            ((= (length files) 2)
             (let ((file1 (nth 0 files)) (file2 (nth 1 files)))
               (ediff-files file1 file2)))
            ((= (length files) 3)
             (let ((file1 (car files)) (file2 (nth 1 files)) (file3 (nth 2 files)))
               (ediff-files3 file1 file2 file3)))
            (t (error "no more than 3 files should be marked")))))
  (define-advice dired-do-print (:override (&optional _))
    "show/hide dotfiles in current dired
see: https://www.emacswiki.org/emacs/DiredOmitMode"
    (cond ((or (not (boundp 'dired-dotfiles-show-p)) dired-dotfiles-show-p)
           (setq-local dired-dotfiles-show-p nil)
           (dired-mark-files-regexp "^\\.")
           (dired-do-kill-lines))
          (t (revert-buffer)
             (setq-local dired-dotfiles-show-p t))))
  (define-advice dired-up-directory (:override (&optional _))
    "goto up directory in this buffer"
    (find-alternate-file ".."))
  (define-advice dired-do-compress-to (:override (&optional _))
    "Compress selected files and directories to an archive."
    (let* ((output (read-file-name "Compress to: "))
           (command-assoc (assoc output dired-compress-files-alist 'string-match))
           (files-str (mapconcat 'identity (dired-get-marked-files t) " ")))
      (when (and command-assoc (not (string= "" files-str)))
        (let ((command (format-spec (cdr command-assoc)
                                    `((?o . ,output)
                                      (?i . ,files-str)))))
          (async-start (lambda () (shell-command command)) nil))))))
#+end_src

*** Magit
:properties:
:header-args:emacs-lisp: :tangle no :noweb-ref magit-tweaks
:end:

#+begin_comment
æ¥è‡ª =:tools magit= æ¨¡å—
#+end_comment

[[https://xkcd.com/1597][xkcd:1597]]

è¿™åº”è¯¥æ˜¯ Emacs çš„æ€æ‰‹åº”ç”¨ä¹‹ä¸€äº†ï¼Œæ„Ÿè°¢ [[https://github.com/tarsius][Jonas]] åŠå…¶ä»–è´¡çŒ®è€…ã€‚

#+begin_src emacs-lisp :noweb no-export :tangle yes :noweb-prefix no :noweb-ref nil
(after! magit
  <<magit-tweaks>>
  )
#+end_src

**** Delta

[[https://github.com/dandavison/delta/][Delta]] æ˜¯ç”¨ rust å®ç°çš„ git diff è¯­æ³•é«˜äº®çš„å·¥å…·ã€‚è¯¥ä½œè€…è¿˜å°†å…¶æŒ‚æ¥åˆ°äº† magit çš„
diff è§†å›¾ä¸Š (é»˜è®¤ä¸ä¼šæœ‰è¯­æ³•é«˜äº®)ã€‚ä¸è¿‡è¿™éœ€è¦ =delta= äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåœ¨ cargo å®‰è£…
æ˜¾å¾—ç®€å•äº›ï¼Œä¸è¿‡ä½ ä¹Ÿå¯ä»¥é€‰æ‹© [[https://github.com/dandavison/delta/releases/latest][GitHub Release]]ã€‚å½“ç„¶ï¼Œæˆ‘åœ¨ç”¨ openSUSE tumbleweedï¼Œ
å¯ä»¥ä»è½¯ä»¶æºä¸­ä¸‹è½½

#+begin_src shell :tangle no
cargo install git-delta
sudo zypper install git-delta
#+end_src

ç®€å•åœ°é…ç½®å®ƒå°±è¡Œ
#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! magit-delta :recipe (:host github :repo "dandavison/magit-delta"))
#+end_src

#+begin_src emacs-lisp
(use-package! magit-delta
  :after magit
  :hook (magit-mode . magit-delta-mode))
#+end_src

**** Code Review

Github / Gitlab ä¸Šå»è¿˜æ˜¯æœ‰ç‚¹éº»çƒ¦äº†ï¼Œåœ¨æœ¬åœ°ç›´æ¥è®¿é—®ã€æ“ä½œè¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚Magit æä¾›
äº† forge æ¥å®ç°åœ¨ emacs ä¸­ code reviewï¼

#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! forge :recipe (:host github :repo "magit/forge"))
#+end_src

#+begin_src emacs-lisp
(use-package! forge
  :after magit)
#+end_src

**** å†²çª

åœ¨ Emacs ä¸­å¤„ç†å†²çªä¹Ÿæ˜¯ä¸é”™çš„ä½“éªŒï¼Œæˆ–è®¸å¯ä»¥å°è¯•è‡ªå·±åˆ¶é€ ä¸€ç‚¹ã€‚å½“ç„¶ï¼Œediff ç›¸å½“å¥½
ç”¨ã€‚
emmm... ä¹‹å‰ä¸ºä»€ä¹ˆè¦ç”¨ smerge æ¥ç€ã€‚åº”è¯¥æ˜¯ä¸æƒ³ç¦»å¼€ emacs ç¯å¢ƒã€‚

#+begin_src emacs-lisp :tangle no
(defun smerge-repeatedly ()
  "Perform smerge actions again and again"
  (interactive)
  (smerge-mode 1)
  (smerge-transient))
(after! transient
  (transient-define-prefix smerge-transient ()
    [["Move"
      ("n" "next" (lambda () (interactive) (ignore-errors (smerge-next)) (smerge-repeatedly)))
      ("p" "previous" (lambda () (interactive) (ignore-errors (smerge-prev)) (smerge-repeatedly)))]
     ["Keep"
      ("b" "base" (lambda () (interactive) (ignore-errors (smerge-keep-base)) (smerge-repeatedly)))
      ("u" "upper" (lambda () (interactive) (ignore-errors (smerge-keep-upper)) (smerge-repeatedly)))
      ("l" "lower" (lambda () (interactive) (ignore-errors (smerge-keep-lower)) (smerge-repeatedly)))
      ("a" "all" (lambda () (interactive) (ignore-errors (smerge-keep-all)) (smerge-repeatedly)))
      ("RET" "current" (lambda () (interactive) (ignore-errors (smerge-keep-current)) (smerge-repeatedly)))]
     ["Diff"
      ("<" "upper/base" (lambda () (interactive) (ignore-errors (smerge-diff-base-upper)) (smerge-repeatedly)))
      ("=" "upper/lower" (lambda () (interactive) (ignore-errors (smerge-diff-upper-lower)) (smerge-repeatedly)))
      (">" "base/lower" (lambda () (interactive) (ignore-errors (smerge-diff-base-lower)) (smerge-repeatedly)))
      ("R" "refine" (lambda () (interactive) (ignore-errors (smerge-refine)) (smerge-repeatedly)))
      ("E" "ediff" (lambda () (interactive) (ignore-errors (smerge-ediff)) (smerge-repeatedly)))]
     ["Other"
      ("c" "combine" (lambda () (interactive) (ignore-errors (smerge-combine-with-next)) (smerge-repeatedly)))
      ("r" "resolve" (lambda () (interactive) (ignore-errors (smerge-resolve)) (smerge-repeatedly)))
      ("k" "kill current" (lambda () (interactive) (ignore-errors (smerge-kill-current)) (smerge-repeatedly)))
      ("q" "quit" (lambda () (interactive) (smerge-auto-leave)))]]))
#+end_src

*** Completion

#+begin_comment
æ¥è‡ª =:completion corfu= æ¨¡å—
#+end_comment

æ²¡æœ‰è¡¥å…¨æ€ä¹ˆå†™ä»£ç ï¼Œå°¤å…¶æ˜¯ =Java=â€‹ï¼ï¼ï¼
#+begin_src emacs-lisp
(after! corfu
 (corfu-history-mode t)
 (corfu-indexed-mode t)
 )
#+end_src

*** Vertico

#+begin_comment
æ¥è‡ª =:completion vertico= æ¨¡å—
#+end_comment

#+begin_src emacs-lisp
(after! consult
  (set-face-attribute 'consult-file nil :inherit 'consult-buffer)
  (setf (plist-get (alist-get 'perl consult-async-split-styles-alist) :initial) ";"))
#+end_src

*** LSP

#+begin_comment
æ¥è‡ª =:tools lsp= æ¨¡å—
#+end_comment

è¿™ä¸æ˜¯è€è‰²æ‰¹ï¼è‡ªä» lsp æ™®åŠå¼€å§‹ï¼Œæ— è®ºé…ç½®ä»€ä¹ˆç¼–è¾‘å™¨éƒ½ä¸å†å¤æ‚äº†ã€‚çœ‹äº†ä¸€åœˆ
[[https://emacs-lsp.github.io/lsp-mode/tutorials/][lsp-mode tutorial]] ç”šè‡³è§‰å¾—ä¸éœ€è¦é…ç½®ä»€ä¹ˆï¼Œä¼°è®¡ doom ä¹Ÿæœ‰ç›¸åº”çš„é…ç½®ã€‚é—®é¢˜å°±æ˜¯ï¼Œç†Ÿ
æ‚‰é…ç½®ã€æ“ä½œçš„é—®é¢˜ã€‚

#+begin_src emacs-lisp
(use-package! eglot
  :init
  (setq! eglot-code-action-indications nil
         eglot-autoshutdown t
         ; Performance issue: https://github.com/joaotavora/eglot/discussions/993
         eldoc-idle-delay 0.75
         company-idle-delay 0.75
         flymake-no-changes-timeout 0.5
         ; Copy from https://andreyor.st/posts/2023-09-09-migrating-from-lsp-mode-to-eglot/
         eglot-ignored-server-capabilities '(:colorProvider
                                             :documentFormattingProvider
                                             :documentLinkProvider
                                             :documentOnTypeFormattingProvider
                                             :documentRangeFormattingProvider
                                             :foldingRangeProvider
                                             :inlayHintProvider)
         eglot-stay-out-of '(yasnippet)
         eglot-events-buffer-size 0
         eglot-extend-to-xref nil)
  :config
  (add-hook 'eglot-managed-mode-hook (lambda () (setq-local eldoc-documentation-strategy
                                                            #'eldoc-documentation-compose)))
  (advice-add 'jsonrpc--log-event :override #'ignore)
  (add-to-list 'eglot-server-programs
               '((cc-mode c++-mode c-mode) . ("clangd" "-j=2" "--clang-tidy" "--header-insertion=iwyu")))
  :hook
  ((cc-mode c++-mode c-mode) . eglot-ensure))
#+end_src

*** Tree sitter

#+begin_comment
æ¥è‡ª =:tools tree-sitter= æ¨¡å—
#+end_comment

ç»“æ„åŒ–ç¼–è¾‘ä¼¼ä¹æˆä¸ºäº†ä¸»æµï¼Œä¸è¿‡ combobulate æ”¯æŒçš„å¤ªå°‘äº†ã€‚æš‚ä¸è€ƒè™‘ã€‚

#+begin_src emacs-lisp :tangle no
(package! combobulate :recipe (:host github :repo "mickeynp/combobulate"))
#+end_src

*** æ ¼å¼åŒ–

#+begin_comment
æ¥è‡ª =:tools format= æ¨¡å—
#+end_comment

æ ¼å¼åŒ–ä»£ç æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„äº‹æƒ…ï¼Œä½†æ˜¯ï¼Œæˆ‘å¸Œæœ›è¿˜æ˜¯ä¸è¦å†ä¿å­˜çš„æ—¶å€™æ ¼å¼åŒ–äº†ï¼è¿™ä¼šè®©ä»£
ç å˜å¾—å¥‡æ€ªï¼Œå°¤å…¶æ˜¯åˆä½œçš„é¡¹ç›®ä¸Šã€‚å½“ç„¶ä½ å¯ä»¥æ‰‹åŠ¨ç”¨ ~+format/buffer~ åœ¨éœ€è¦çš„æ—¶å€™æ ¼å¼
åŒ–ä»£ç ã€‚ä½†æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™æ²¡ä»€ä¹ˆç”¨ã€‚

#+begin_src emacs-lisp :tangle no
(appendq! +format-on-save-disabled-modes
          '(c-mode
            c++-mode
            python-mode))
#+end_src

å¦å¤–ï¼Œä¸è¦è®© lsp æ±¡æŸ“ formatï¼
#+begin_src emacs-lisp
(setq +format-with-lsp nil)
#+end_src

*** TRAMP

å…³äºå…¶ä»–å¾ˆæœ‰ç”¨çš„åŠŸèƒ½ï¼ŒTRAMP ç®—ä¸€ä¸ªï¼Œå®ƒæ˜¯å¤šåè®®é€æ˜è¿œç¨‹è®¿é—® (/Transparent Remote
Access, Multiple Protocol/) å·¥å…·ã€‚ç®€å•è¯´è¿™æ˜¯ç®€å•è®¿é—®å…¶ä»–ä¸»æœºæ–‡ä»¶ç³»ç»Ÿçš„æ–¹æ³•ã€‚

å¦‚æœä½ æƒ³ä½¿ç”¨ =ssh-key=â€‹ï¼Œå»ºè®®å¼€å§‹ä½¿ç”¨ ~ssh config~â€‹ï¼Œå¹¶ç”¨ ~sshx:~ è¿›è¡Œ tramp è¿æ¥ã€‚

ä¸å¹¸çš„æ˜¯ï¼ŒTRAMP å¯¹è¿œç¨‹è¿æ¥æ—¶ SHELL çš„æç¤ºæ ¼å¼å¾ˆæŒ‘å‰”ï¼Œå°è¯•ä½¿ç”¨ bash å¹¶æ”¾å®½æ¾æç¤º
åŒºåŸŸçš„è¯†åˆ«ã€‚

#+begin_src emacs-lisp
(after! tramp
  (setenv "SHELL" "/bin/bash")
  (setq tramp-shell-prompt-pattern
        "\\(?:^\\|
\\)[^]#$%>\n]*#?[]#$%>î‚°] *\\(\\[[0-9;]*[a-zA-Z] *\\)*"))  ;; default + î‚°
#+end_src

*** VTerm

#+begin_quote
As good as terminal emulation gets in Emacs
#+end_quote

VTerm çš„å®‰è£…ç›¸å¯¹éº»çƒ¦ä¸€äº›ï¼Œéœ€è¦ç¼–è¯‘ä¸€äº›ä¾èµ–ã€‚å½“ç„¶å¯¹äº Unix ç”¨æˆ·ï¼Œç”¨ç³»ç»Ÿåº“æ›´åŠ æ–¹ä¾¿ï¼
#+begin_src emacs-lisp
(setq! vterm-module-cmake-args "-DUSE_SYSTEM_LIBVTERM=yes")
#+end_src

*** YASnippet

#+begin_comment
æ¥è‡ª =:editor snippets= æ¨¡å—
#+end_comment

snippets å¥—å¨ƒè°ç”¨è°çŸ¥é“ï¼
#+begin_src emacs-lisp
(setq yas-triggers-in-field t)
#+end_src

*** Screenshot

#+begin_notes
screenshot ä¾èµ–äº [[https://imagemagick.org/index.php][ImageMagick]]
#+end_notes

è®©æˆªå›¾å˜å¾—è½»è€Œæ˜“ä¸¾ï¼
#+begin_src emacs-lisp :tangle packages.el
(package! screenshot
  :recipe (:host github :repo "tecosaur/screenshot")
  )
#+end_src

#+begin_src emacs-lisp
(use-package! screenshot
  :defer t
  :config (setq screenshot-upload-fn "upload %s 2>/dev/null"))
#+end_src

ä½œè€…å¹¶æ²¡æœ‰æ‰“ç®—æ·»åŠ  TUI æ”¯æŒã€‚

** UI

*** Nyan

é¦–å…ˆæ·»åŠ ä¸€ä¸‹å½©è™¹çŒ«ï¼Œè¿™ä¸èƒ½å¿˜ï¼
#+begin_src emacs-lisp :tangle "packages.el"
(package! nyan-mode :recipe (:host github :repo "TeMPOraL/nyan-mode"))
#+end_src

#+begin_src emacs-lisp
(use-package! nyan-mode
  :config
  (setq nyan-animate-nyancat t
        nyan-wavy-trail t
        nyan-cat-face-number 4
        nyan-bar-length 16
        nyan-minimum-window-width 64)
  (add-hook! doom-modeline #'nyan-mode))
#+end_src

*** Eros

#+begin_comment
æ¥è‡ª =:tools eval= æ¨¡å—
#+end_comment

è¿™ä¸ªåŒ…å¯ä»¥ä¿®æ”¹ emacs lisp å†…è”æ‰§è¡Œçš„è§†è§‰æ•ˆæœï¼Œè®©è¿™ä¸ªç»“æœçš„å‰ç¼€æ›´å¥½çœ‹ä¸€ç‚¹ã€‚
#+begin_src emacs-lisp
(setq eros-eval-result-prefix "âŸ¹ ") ; default =>
#+end_src

ä½ å¯ä»¥ç”¨ =C-x C-e= æ¥å¯¹æ¯”ä¸€ä¸‹å‰åå˜åŒ–
#+begin_src emacs-lisp :tangle no :results vaule replace
(+ 1 1 (* 2 2) 1)
#+end_src

#+RESULTS:
: 7

#+begin_src python :tangle no :results vaule replace
return 2 ** 4
#+end_src

#+RESULTS:
: 16

*** Theme Magic

éå¸¸ç¥å¥‡çš„æ˜¯ä½ å¯ä»¥åœ¨ Emacs ä¸­ç”¨ç°æœ‰çš„ Themeï¼Œæ”¹å˜ç»ˆç«¯çš„ Themeï¼Œä¸” GUI å’Œ TUI éƒ½
å¯ç”¨ï¼ä½œè€…è¯´ Linux å’Œ Mac å¯ç”¨ï¼Œâ€‹=Windows Terminal= + =WSL= åŒæ ·é€‚ç”¨ï¼Œå‹åŠ›æ¥åˆ°äº†
çº¯ Windows ä¸‹çš„ Emacsã€‚

#+begin_src emacs-lisp :tangle packages.el
(package! theme-magic)
#+end_src

è¿™ä¸ªæ“ä½œä½¿ç”¨ =pywal=â€‹ï¼Œä½ å¯ä»¥é€šè¿‡ä»“åº“å®‰è£…å®ƒï¼Œä¸è¿‡æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ =pip=â€‹ã€‚

#+begin_src shell :tangle no
sudo python3 -m pip install pywal
#+end_src

Theme Magic æä¾›äº†ä¸€ä¸ªæ•°å­—ç•Œé¢ï¼Œå°è¯•ä»é¥±å’Œåº¦ã€è‰²å½©å·®å¼‚æ¥æœ‰æ•ˆçš„é€‰å–å…«ä¸ªé¢œè‰²ã€‚ç„¶è€Œï¼Œå®ƒ
å¯èƒ½ä¼šä¸º light é€‰æ‹©ç›¸åŒçš„é¢œè‰²ï¼Œå¹¶ä¸æ€»èƒ½å¤Ÿé€‰å–æœ€ä½³é¢œè‰²ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ Doom themes
æä¾›çš„è‰²å½©å·¥å…·æ¥è½»æ¾è·å–åˆç†çš„é…è‰²æ¥ç”Ÿæˆ light ç‰ˆæœ¬ --- ç°åœ¨å°±å¼€å§‹ï¼

#+begin_src emacs-lisp
(use-package! theme-magic
  :defer t
  :after +doom-dashboard
  :config
  (defadvice! theme-magic--auto-extract-16-doom-colors ()
    :override #'theme-magic--auto-extract-16-colors
    (list
     (face-attribute 'default :background)
     (doom-color 'error)
     (doom-color 'success)
     (doom-color 'type)
     (doom-color 'keywords)
     (doom-color 'constants)
     (doom-color 'functions)
     (face-attribute 'default :foreground)
     (face-attribute 'shadow :foreground)
     (doom-blend 'base8 'error 0.1)
     (doom-blend 'base8 'success 0.1)
     (doom-blend 'base8 'type 0.1)
     (doom-blend 'base8 'keywords 0.1)
     (doom-blend 'base8 'constants 0.1)
     (doom-blend 'base8 'functions 0.1)
     (face-attribute 'default :foreground))))
#+end_src

*** Info ç€è‰²

è®© info å˜å¾—æ›´åŠ ç»šä¸½å¤ºç›®ã€‚

#+begin_src emacs-lisp :tangle packages.el
(package! info-colors)
#+end_src

#+begin_src emacs-lisp
(use-package! info-colors
  :after info
  :commands (info-colors-fontify-node)
  :hook (Info-selection . info-colors-fontify-node))
#+end_src

*** Tabs

#+begin_comment
æ¥è‡ª =:ui tabs= æ¨¡å—
#+end_comment

å¦‚æœä½ æƒ³åƒç°ä»£ç¼–è¾‘å™¨ä¸€æ ·æ‹¥æœ‰ tabsï¼Œæˆ–è®¸ä½ å¯ä»¥è€ƒè™‘ä¸€ä¸‹ã€‚å¦‚æœæƒ³è¦ tabs åº•ä¸‹æ˜¾ç¤º
=bar=â€‹ï¼Œéœ€è¦å¼€å¯ ~x-underline-at-descent-line~
#+begin_src emacs-lisp :tangle no
(after! centaur-tabs
  (setq! centaur-tabs-style "bar"
         centaur-tabs-set-icons t
         centaur-tabs-plain-icons nil
         centaur-tabs-set-modified-marker t
         centaur-tabs-show-navigation-buttons nil
         centaur-tabs-gray-out-icons 'buffer
         centaur-tabs-set-bar 'under
         x-underline-at-descent-line t
         centaur-tabs-label-fixed-length 9)
  (defun centaur-tabs-hide-tab (x)
    "Do no to show buffer X in tabs."
    (let ((name (format "%s" x)))
      (or
       ;; Current window is not dedicated window.
       (window-dedicated-p (selected-window))
       ;; Buffer name not match below blacklist.
       (string-prefix-p "*epc" name)
       (string-prefix-p "*helm" name)
       (string-prefix-p "*Helm" name)
       (string-prefix-p "*Compile-Log*" name)
       (string-prefix-p "*lsp" name)
       (string-prefix-p "*company" name)
       (string-prefix-p "*Flycheck" name)
       (string-prefix-p "*tramp" name)
       (string-prefix-p " *Mini" name)
       (string-prefix-p "*help" name)
       (string-prefix-p "*straight" name)
       (string-prefix-p " *temp" name)
       (string-prefix-p "*Help" name)
       (string-prefix-p "*mybuf" name)
       (string-prefix-p "â–º Doom" name)
       ;; Is not magit buffer.
       (and (string-prefix-p "magit" name)
            (not (file-name-extension name)))
       )))
  (centaur-tabs-group-by-projectile-project)
  (centaur-tabs-mode t))
#+end_src

ä½†æ˜¯åˆ«å¿˜äº†ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶[[æ¥å£]]ä¸­å¼€å¯ =tabs= é€‰é¡¹ã€‚è¿˜ä¸èƒ½å¿˜è®°æ·»åŠ å¿«æ·é”®
#+begin_src emacs-lisp :tangle no
(map! :map ctl-x-map
      :prefix ("t" . "Tab and Treemacs")
      "a"   #'centaur-tabs-select-beg-tab
      "e"   #'centaur-tabs-select-end-tab
      "f"   #'centaur-tabs-forward-tab
      "F"   #'centaur-tabs-forward-group
      "b"   #'centaur-tabs-backward-tab
      "B"   #'centaur-tabs-backward-group
      "g"   #'centaur-tabs-switch-group
      "G"   #'centaur-tabs-toggle-groups
      "l"   #'centaur-tabs-move-current-tab-to-left
      "r"   #'centaur-tabs-move-current-tab-to-right
      "k"   #'centaur-tabs-kill-other-buffers-in-current-group
      "K"   #'centaur-tabs-kill-unmodified-buffers-in-current-group
      "C-5" #'centaur-tabs-extract-window-to-new-frame
      "C-o" #'centaur-tabs-open-in-external-application
      "C-d" #'centaur-tabs-open-directory-in-external-application
      )
#+end_src

*** Nerd Icons

#+begin_comment
æ¥è‡ª =:core packages= æ¨¡å—
#+end_comment

ç°åœ¨ Doom emacs ä½¿ç”¨ =nerd-icons=â€‹ã€‚

#+begin_src emacs-lisp :tangle no
(after! nerd-icons
  (when-let ((matlab-icon (assoc "matlab" nerd-icons-extension-icon-alist)))
    (setcdr (assoc "m" nerd-icons-extension-icon-alist)
            (cdr matlab-icon))))
#+end_src

*** hl todo

#+begin_comment
æ¥è‡ª =:ui hl-todo= æ¨¡å—
#+end_comment

~hl-todo~ å…è®¸ä½ è®¾ç½®ä¸€äº›å…³é”®å­—ï¼Œè¿™äº›å…³é”®å­—å°†é«˜äº®å¹¶ä¸”ä¾¿äºæŸ¥æ‰¾ã€‚å¾€å¾€ç”¨äºä»£ç æ³¨é‡Šä¸­
å¼ºè°ƒæŸäº›å†…å®¹ã€‚
#+begin_src emacs-lisp
(custom-set-variables
 '(hl-todo-keyword-faces '(("NOTE" font-lock-builtin-face bold) ;; needs discussion or further investigation.
                           ("REVIEW" font-lock-keyword-face bold) ;; review was conducted.
                           ("HACK" font-lock-variable-name-face bold) ;; workaround a known problem.
                           ("DEPRECATED" region bold) ;; why it was deprecated and to suggest an alternative.
                           ("XXX+" font-lock-constant-face bold) ;; warn other programmers of problematic or misguiding code.
                           ("TODO" font-lock-function-name-face bold) ;; tasks/features to be done.
                           ("FIXME" font-lock-warning-face bold) ;; problematic or ugly code needing refactoring or cleanup.
                           ("KLUDGE" font-lock-preprocessor-face bold )
                           ("BUG" error bold) ;; a known bug that should be corrected.
                           )))
#+end_src



* ç¼–ç¨‹è¯­è¨€é…ç½®

** æ–‡ä»¶æ¨¡æ¿

Snippet å¯ä»¥å¾ˆå¥½çš„å¸®åŠ©æˆ‘ä»¬åˆå§‹åŒ–ä¸€äº›æ–‡ä»¶ã€‚

#+begin_src emacs-lisp
;;(set-file-template! "\\.org$" :trigger "__" :mode 'org-mode)
(set-file-template! "/LICEN[CS]E$" :trigger '+file-templates/insert-license)
#+end_src

** çº¯æ–‡æœ¬

æˆ‘ä¸ä»‹æ„å·¦ä¾§æ²¡æœ‰ä»»ä½•è¾¹è·çš„ bufferï¼Œä½†æ˜¯ä¸€æ—¦å‰¥ç¦»è¡Œå·ï¼Œbuffer å°±ä¼šæ„Ÿè§‰æœ‰ç‚¹ä¸å¯¹åŠ²ã€‚

#+begin_src emacs-lisp
(defvar +text-mode-left-margin-width 1
  "The `left-margin-width' to be used in `text-mode' buffers.")

(defun +setup-text-mode-left-margin ()
  (when (and (derived-mode-p 'text-mode)
             (eq (current-buffer) ; Check current buffer is active.
                 (window-buffer (frame-selected-window))))
    (setq left-margin-width (if display-line-numbers
                                0 +text-mode-left-margin-width))
    (set-window-buffer (get-buffer-window (current-buffer))
                       (current-buffer))))
#+end_src

ç°åœ¨æˆ‘ä»¬åªéœ€è¦å°†å®ƒè¿æ¥åˆ°æ‰€æœ‰å¯èƒ½è¡¨æ˜æ¡ä»¶å‘ç”Ÿå˜åŒ–æˆ–éœ€è¦é‡æ–°åº”ç”¨è®¾ç½®çš„äº‹ä»¶ã€‚

#+begin_src emacs-lisp
(add-hook! (window-configuration-change display-line-numbers-mode)
           #'+setup-text-mode-left-margin)
(add-hook! text-mode #'+setup-text-mode-left-margin)
#+end_src

Doom æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œå› ä¸º ~doom/toggle-line-numbers~ ä¸è¿è¡Œ ~display-line-numbers-mode-hook~â€‹ï¼Œæ‰€ä»¥éœ€è¦ä¸€äº›è®¾ç½®ã€‚

#+begin_src emacs-lisp
(defadvice! +doom/toggle-line-numbers--call-hook-a ()
  :after #'doom/toggle-line-numbers
  (run-hooks 'display-line-numbers-mode-hook))
#+end_src

æœ€åï¼Œæˆ‘æƒ³æˆ‘çœŸçš„å¾ˆå–œæ¬¢è¿™ä¸ªï¼Œæˆ‘ä¼šç»§ç»­åœ¨æ–‡æœ¬æ¨¡å¼ä¸‹åˆ é™¤è¡Œå·ã€‚

#+begin_src emacs-lisp
(remove-hook! text-mode #'display-line-numbers-mode)
#+end_src

** Org Mode
:properties:
:CUSTOM_ID: org
:header-args:emacs-lisp: :tangle no :noweb-ref org-conf
:end:

å› ä¸ºè¿™éƒ¨åˆ†åˆå§‹åŒ–æ—¶ç›¸å½“è´¹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ”¾åœ¨ src_elisp{(after! ...)} ä¸­ã€‚
#+begin_src emacs-lisp :noweb no-export :tangle yes :noweb-prefix no :noweb-ref nil
(after! org
  <<org-conf>>
  )
#+end_src

*** åŠŸèƒ½å¢å¼º

#+begin_src emacs-lisp
(setq! org-use-property-inheritance t         ; it's convenient to have properties inherited
       org-log-done 'time                     ; having the time a item is done sounds convenient
       org-list-allow-alphabetical t          ; have a. A. a) A) list bullets
       ;; org-export-in-background t             ; run export processes in external emacs process
       org-catch-invisible-edits 'smart       ; try not to accidently do weird stuff in invisible regions
       org-export-with-sub-superscripts '{}   ; don't treat lone _ / ^ as sub/superscripts, require _{} / ^{}
       org-export-allow-bind-keywords t       ; Bind keywords can be handy
       org-image-actual-width '(0.9)          ; Make the in-buffer display closer to the exported result..
       )
#+end_src

I also like the src_elisp{:comments} header-argument, so letâ€™s make that a default.

#+begin_src emacs-lisp
(setq org-babel-default-header-args
      '((:session . "none")
        (:results . "replace")
        (:exports . "code")
        (:cache . "no")
        (:noweb . "no")
        (:hlines . "no")
        (:tangle . "no")
        (:comments . "link")))
#+end_src

**** é›¶å®½ç©ºæ ¼

å¶å°”åœ¨ç”¨ Org æ˜¯ä½ å¸Œæœ›å°†ä¸¤ä¸ªåˆ†å¼€çš„å—æ”¾åœ¨ä¸€èµ·ï¼Œè¿™ç‚¹æœ‰ç‚¹çƒ¦äººã€‚æ¯”å¦‚å°†åŠ â€‹*é‡*â€‹ä¸€ä¸ªå•è¯
çš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…è¯´åœ¨å†…è”æºç å—ä¹‹å‰æ”¾ä¸€äº›ç¬¦å·ã€‚æœ‰ä¸€ä¸ªå¯ä»¥è§£å†³çš„æ–¹æ³• --- é›¶å®½ç©ºæ ¼ã€‚
ç”±äºè¿™æ˜¯ Emacsï¼Œæˆ‘ä»¬å¯ä»¥ä¸º org-mode åšä¸€ä¸ªå¾ˆå°çš„æ”¹åŠ¨å°†å…¶æ·»åŠ åˆ°å¿«æ·é”®ä¸Š ğŸ™‚ã€‚

#+begin_src emacs-lisp
(map! :map org-mode-map
      :leader
      :desc "zero-width-space" "SPC" (cmd! (insert "\u200B")))
#+end_src

**** ç›®å½•ç”Ÿæˆ

ç”Ÿæˆç›®å½•çš„éœ€æ±‚å¹¶ä¸å¤§ï¼Œä½†æ˜¯åƒ =GitHub= çš„ç¯å¢ƒä¸‹ TOC å¯èƒ½æˆä¸ºå¿…è¦ï¼Œé‡‡ç”¨ ~toc-org~
æ¥ç”Ÿæˆã€‚
#+begin_src emacs-lisp :noweb-ref none :tangle no
(use-package! toc-org
  :defer t
  :after (:any org markdown)
  :config
  (toc-org-mode t)
  (add-hook! (org-mode markdown-mode) #'toc-org-mode)
  (define-key! org-mode-map "C-c C-i" #'toc-org-insert-toc)
  (define-key! markdown-mode-map "C-c M-t" #'toc-org-insert-toc))
#+end_src

=toc-org= ä¼šæ¸…ç©ºå¸¦æœ‰ ~TOC~ æ ‡ç­¾çš„ headingï¼Œå¹¶ç”Ÿæˆç›®å½•ã€‚

æˆ‘ä¸ç¡®å®šçœŸçš„éœ€è¦å®ƒå˜›ï¼Œå› æ­¤æˆ‘å°†å®ƒå…³é—­äº†ã€‚

**** åŠ å¯†å—

=org-crypt= å¯ä»¥ç”¨ =GPG= åŠ å¯† Org Mode çš„æŸäº› headingï¼Œå½“ç„¶æ˜¯å¸¦æœ‰ ~crypt~ æ ‡ç­¾çš„ã€‚
ç°åœ¨æ¥è®¾ç½®ä¸€ä¸‹ã€‚
#+begin_src emacs-lisp
(use-package! org-crypt
  :custom
  (org-crypt-key "0xA173AD0063A4E2DFAB4F9EAE65F09D172E677525")
  (org-tags-exclude-from-inheritance '("crypt")) ;; avoid repeated encryption
  :config
  (org-crypt-use-before-save-magic) ;; encrypt when writing back to the hard disk
  (map! :map org-mode-map
        :localleader
        :desc "org-encrypt" "C" nil
        :desc "encrypt current" "C e" #'org-encrypt-entry
        :desc "encrypt all" "C E" #'org-encrypt-entries
        :desc "decrypt current" "C d" #'org-decrypt-entry
        :desc "decrypt all" "C D" #'org-decrypt-entries))
#+end_src

å¦‚æœæƒ³ç”¨å…¶ä»–å¯†é’¥åŠ å¯†ï¼Œå¯ä»¥è®¾ç½® ~cryptkey~ å±æ€§ã€‚
#+begin_src fundamental
,* Totally secret :crypt:
:properties:
:cryptkey: 0x0123456789012345678901234567890123456789
:end:
#+end_src

**** åˆ—è¡¨é¡ºåº

#+begin_src emacs-lisp
(setq org-list-demote-modify-bullet '(("+" . "-") ("-" . "+") ("*" . "+") ("1." . "a.")))
#+end_src

**** å¼•ç”¨

#+begin_comment
æ¥è‡ª =:tools biblio= æ¨¡å—
#+end_comment

#+begin_src emacs-lisp
;;; (org-cite-global-bibliography '("~/library/ebooks/catalog.bib" "~/library/papers/catalog.bib"))
(after! citar
  (setq! citar-symbol-separator "  "
         citar-bibliography org-cite-global-bibliography
         citar-symbols
           `((file ,(nerd-icons-faicon "nf-fa-file_o" :face 'nerd-icons-green :v-adjust -0.1) . " ")
             (note ,(nerd-icons-octicon "nf-oct-note" :face 'nerd-icons-blue :v-adjust -0.3) . " ")
             (link ,(nerd-icons-octicon "nf-oct-link" :face 'nerd-icons-orange :v-adjust 0.01) . " ")))
  (org-cite-follow-processor 'citar)
  (org-cite-activate-processor 'citar)
  (add-to-list 'citar-major-mode-functions
               '((gfm-mode)
                 (insert-keys . citar-markdown-insert-keys)
                 (insert-citation . citar-markdown-insert-citation)
                 (insert-edit . citar-markdown-insert-edit)
                 (key-at-point . citar-markdown-key-at-point)
                 (citation-at-point . citar-markdown-citation-at-point)
                 (list-keys . citar-markdown-list-keys))))
#+end_src

ä¸»è¦ä¸ºäº†å¼•ç”¨çš„çµæ´»æ€§ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰è®¾ç½®å…¨å±€ bibï¼Œå¦‚æœæƒ³åœ¨ Org é‡Œå¼•ç”¨æŸäº› bib æ–‡ä»¶å¯
ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹æ³•ã€‚
#+begin_src fundamental
,#+bibliography: ~/library/ebooks/catalog.bib
,#+bibliography: ~/library/papers/catalog.bib
#+end_src

å½“ç„¶è¿™é…ç½®å¾ˆç®€å•ï¼Œåªä¸è¿‡åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œå…³äº =org-cite= å’Œ =citar= è¦å­¦çš„è¿˜æœ‰å¾ˆå¤šã€‚
å¯ä»¥çœ‹çœ‹ [[https://blog.tecosaur.com/tmio/2021-07-31-citations.html][è¿™ç¯‡]]ã€‚

**** lsp æ”¯æŒçš„æºç å—

é»˜è®¤æƒ…å†µä¸‹ï¼Œlsp å¹¶ä¸æ”¯æŒåº”ç”¨åœ¨ src å—ä¸­ã€‚

#+begin_src emacs-lisp
;; Enable LSP in org babel
;; need to add `:file test.xx' in the header
;; https://github.com/emacs-lsp/lsp-mode/issues/377
(cl-defmacro lsp-org-babel-enable (lang)
  "Support LANG in org source code block."
  (setq centaur-lsp 'lsp-mode)
  (cl-check-type lang string)
  (let* ((edit-pre (intern (format "org-babel-edit-prep:%s" lang)))
         (intern-pre (intern (format "lsp--%s" (symbol-name edit-pre)))))
    `(progn
       (defun ,intern-pre (info)
         (let ((file-name (->> info caddr (alist-get :file))))
           (unless file-name
             (setq file-name (make-temp-file "babel-lsp-")))
           (setq buffer-file-name file-name)
           (lsp-deferred)))
       (put ',intern-pre 'function-documentation
            (format "Enable lsp-mode in the buffer of org source block (%s)."
                    (upcase ,lang)))
       (if (fboundp ',edit-pre)
           (advice-add ',edit-pre :after ',intern-pre)
         (progn
           (defun ,edit-pre (info)
             (,intern-pre info))
           (put ',edit-pre 'function-documentation
                (format "Prepare local buffer environment for org source block (%s)."
                        (upcase ,lang))))))))
(defvar org-babel-lang-list
  '("python"))
(dolist (lang org-babel-lang-list)
  (eval `(lsp-org-babel-enable ,lang)))
#+end_src

*** Agenda

#+begin_src emacs-lisp :tangle yes :noweb-ref none
(defvar org-agenda-dir (concat org-directory "/" "agenda"))
(defvar org-agenda-todo-file (expand-file-name "todo.org" org-agenda-dir))
(defvar org-agenda-project-file (expand-file-name "project.org" org-agenda-dir))
(after! org-agenda
  ;;urgancy|soon|as soon as possible|at some point|eventually
  ;;
  (setq! org-agenda-files `(,org-agenda-todo-file
                            ,org-agenda-project-file)
         org-agenda-skip-scheduled-if-done t
         org-agenda-skip-deadline-if-done t
         org-agenda-include-deadlines t
         org-agenda-block-separator nil
         org-agenda-tags-column 100 ;; from testing this seems to be a good value
         org-agenda-compact-blocks t))
#+end_src

*** Capture

å¼€å§‹è®¾ç½® Org-capture æ¨¡æ¿å§ï¼Œå¿«é€Ÿè®°å½•ï¼

#+begin_src emacs-lisp :noweb-ref none :tangle yes
(after! org-capture
  (defun ginshio/find-project-tree(priority)
    "find or create project headline
https://www.zmonster.me/2018/02/28/org-mode-capture.html"
    (let* ((hl (let ((headlines (org-element-map (org-element-parse-buffer 'headline) 'headline
                                  (lambda (hl) (and (= (org-element-property :level hl) 1)
                                               (org-element-property :title hl))))))
                 (completing-read "Project Name: " headlines))))
      (goto-char (point-min))
      (if (re-search-forward
           (format org-complex-heading-regexp-format (regexp-quote hl)) nil t)
          (goto-char (point-at-bol))
        (progn
          (or (bolp) (insert "\n"))
          (if (/= (point) (point-min)) (org-end-of-subtree))
          (insert (format "* %s :project:%s:\n:properties:\n:homepage: %s\n:repo: \
%s\n:end:\n\n** urgancy :urgancy:\n\n** soon :soon:\n\n** as soon as\
 possible :asap:\n\n** at some point :asp:\n\n** eventually :eventually:\n"
                          hl hl (read-string "homepage: ") (read-string "repo: ")))
          (beginning-of-line 0)
          (org-up-heading-safe))))
    (re-search-forward
     (format org-complex-heading-regexp-format
             (regexp-quote priority))
     (save-excursion (org-end-of-subtree t t)) t)
    (org-end-of-subtree))
  (setq! org-capture-dir (expand-file-name "capture" org-directory)
         org-capture-snippet-file (expand-file-name "snippets.org" org-capture-dir)
         org-capture-comment-file (expand-file-name "comments.org" org-capture-dir)
         org-capture-note-file (expand-file-name "notes.org" org-capture-dir)
         org-capture-blog-file (expand-file-name "blogs.org" org-capture-dir)
         )
  ;; http://www.howardism.org/Technical/Emacs/journaling-org.html
  ;; https://www.zmonster.me/2018/02/28/org-mode-capture.html
  (setq org-capture-templates
        `(("B" "Blog TODO List" entry (file ,org-capture-blog-file)
           "* TODO [#%^{priority|D|A|B|C|E}] %^{blog_title}\n:properties:\n:categories: %^{categories}\n:tags: %^{tags}\n:title: %\\1\n:file_name: %^{file_name}\n:end:\n%?"
           :empty-lines 1)
          ("c" "Comment")
          ("cb" "Book" entry (file+weektree ,org-capture-comment-file)
           "* %^{book} :book:%\\1:\n%?" :empty-lines 1)
          ("cm" "Movie" entry (file+weektree ,org-capture-comment-file)
           "* %^{movie} :movie:%\\1:\n%?" :empty-lines 1)
          ("g" "GTD")
          ("gt" "Todo" entry (file+headline org-agenda-todo-file "Personal")
           "* TODO [#%^{priority|A|B|C|D|E}] %^{task}\n  SCHEDULED: %^T DEADLINE: %^T\n:properties:\n:end:\n%?"
           :empty-lines 1)
          ("gi" "Interview" entry (file+headline ,org-agenda-todo-file "Interview")
           "* WAIT [#%^{priority|B|A|C|D}] %^{company} - %^{position}\t:%\\2:\nSCHEDULED: %^T DEADLINE: %^T\n:properties:\n:url: %^{link}\n:end:\n%?"
           :prepend t :empty-lines 1)
          ("gd" "Daily" entry (file+headline ,org-agenda-todo-file "Daily")
           "* TODO [#%^{priority|C|A|B|D|E}] %^{task}\n SCHEDULED:  %<<%Y-%m-%d %a %H:%M ++1d>>\n:properties:\n:end:\n%?"
           :empty-lines 1)
          ("gw" "Weekly" entry (file+headline ,org-agenda-todo-file "Weekly")
           "* TODO [#%^{priority|B|A|C|D|E}] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M ++1w>>\n:properties:\n:end:\n%?"
           :empty-lines 1)
          ("gm" "Monthly" entry (file+headline ,org-agenda-todo-file "Monthly")
           "* TODO [#%^{priority|C|A|B|D|E}] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M ++1m>>\n:properties:\n:end:\n%?"
           :empty-lines 1)
          ("n" "Note")
          ("nc" "Computer" entry (file+headline ,org-capture-note-file "Computer")
           "* %^{heading} %^g\n%?\n" :empty-lines 1)
          ("ne" "Emacs" entry (file+headline ,org-capture-note-file "Emacs")
           "* %^{heading} %^g\n%?\n" :empty-lines 1)
          ("ng" "Game" entry (file+headline ,org-capture-note-file "Game")
           "* %^{heading} %^g\n%?\n" :empty-lines 1)
          ;; ("p" "Project")
          ;; ("pa" "Urgance" entry (file+function ,org-agenda-project-file
          ;;                                      (lambda () (ginshio/find-project-tree "urgancy")))
          ;;  "*** TODO [#A] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M>> DEADLINE: %^T\n    :properties:\n    :end:\n%?"
          ;;  :empty-lines 1)
          ;; ("pb" "Soon" entry (file+function ,org-agenda-project-file
          ;;                                   (lambda () (ginshio/find-project-tree "soon")))
          ;;  "*** TODO [#B] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M>> DEADLINE: %^T\n    :properties:\n    :end:\n%?"
          ;;  :empty-lines 1)
          ;; ("pc" "As Soon As Possiple" entry (file+function ,org-agenda-project-file
          ;;                                                  (lambda () (ginshio/find-project-tree "as soon as possiple")))
          ;;  "*** TODO [#C] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M>> DEADLINE: %^T\n    :properties:\n    :end:\n%?"
          ;;  :empty-lines 1)
          ;; ("pd" "At Some Point" entry (file+function ,org-agenda-project-file
          ;;                                            (lambda () (ginshio/find-project-tree "at some point")))
          ;;  "*** TODO [#D] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M>> DEADLINE: %^T\n    :properties:\n    :end:\n%?"
          ;;  :empty-lines 1)
          ;; ("pe" "Eventually" entry (file+function ,org-agenda-project-file
          ;;                                         (lambda () (ginshio/find-project-tree "eventually")))
          ;;  "*** TODO [#E] %^{task}\n SCHEDULED: %<<%Y-%m-%d %a %H:%M>> DEADLINE: %^T\n    :properties:\n    :end:\n%?"
          ;;  :empty-lines 1)
          ("s" "Code Snippet" entry (file ,org-capture-snippet-file)
           "* %^{heading} :code:%\\2:\n:properties:\n:language: %^{language}\n:end:\n\n#+begin_src %\\2\n%?\n#+end_src"
           :empty-lines 1)
          )))
#+end_src

*** è§†è§‰

**** Org Modern

ä½¿ =org-mode= buffer å°½å¯èƒ½æ¼‚äº®æ˜¯å¾ˆé‡è¦çš„ï¼ŒMinad çš„ =org-modern= åœ¨è¿™æ–¹é¢å¤§æœ‰å¸®åŠ©ã€‚

#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! org-modern)
#+end_src

#+begin_src emacs-lisp
(use-package! org-modern
  :hook
  (org-mode . org-modern-mode)
  (org-agenda-finalize . org-modern-agenda)
  :config
  (setq org-modern-star 'replace
        org-modern-replace-stars "â™‡â™†â™…â™„â™ƒâ™‚â™€â˜¿" ;;  "â—‰â—‹âœ¸âœ¿âœ¤âœœâ—†â–¶"
        org-modern-table-vertical 1
        org-modern-table-horizontal 0.2
        org-modern-list '((43 . "â¤")
                          (45 . "â€“")
                          (42 . "â€¢"))
        org-modern-todo-faces '(("TODO" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "goldenrod"))
                                ("NEXT" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "IndianRed1"))
                                ("STRT" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "OrangeRed"))
                                ("WAIT" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "coral"))
                                ("KILL" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "DarkGreen"))
                                ("PROJ" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "LimeGreen"))
                                ("HOLD" . (:inherit org-verbatim :weight semi-bold :foreground "white" :background "orange"))
                                ("DONE" . (:inherit org-verbatim :weight semi-bold :foreground "black" :background "LightGray")))
        org-modern-footnote (cons nil (cadr org-script-display))
        org-modern-block-fringe nil
        org-modern-block-name '((t . t)
                                ("src" "Â»" "Â«")
                                ("example" "Â»â€“" "â€“Â«")
                                ("quote" "â" "â")
                                ("export" "â©" "âª"))
        org-modern-progress nil
        org-modern-priority nil
        org-modern-horizontal-rule (make-string 36 ?â”€)
        org-modern-keyword '((t . t)
                             ("title" . "ğ™")
                             ("subtitle" . "ğ™©")
                             ("author" . "ğ˜¼")
                             ("email" . "ï¯")
                             ("date" . "ğ˜¿")
                             ("property" . "ó° ³")
                             ("options" . #("ó°˜µ" 0 1 (display (height 0.75))))
                             ("startup" . "â»")
                             ("macro" . "ğ“œ")
                             ("bind" . "ó°Œ·")
                             ("bibliography" . "ï…")
                             ("print_bibliography" . "ó°Œ±")
                             ("cite_export" . "ï…â®­")
                             ("print_glossary" . "ó°Œ±á´¬á¶»")
                             ("glossary_sources" . "ó°’»")
                             ("include" . "â‡¤")
                             ("setupfile" . "â‡š")
                             ("html_head" . "ğŸ…·")
                             ("html" . "ğŸ…—")
                             ("latex_class" . "ğŸ„»")
                             ("latex_class_options" . "ğŸ„»ó°’“")
                             ("latex_header" . "ğŸ…»")
                             ("latex_header_extra" . "ğŸ…»âº")
                             ("latex" . "ğŸ…›")
                             ("beamer_theme" . "ğŸ„±")
                             ("beamer_color_theme" . "ğŸ„±ó°˜")
                             ("beamer_font_theme" . "ğŸ„±ğ€")
                             ("beamer_header" . "ğŸ…±")
                             ("beamer" . "ğŸ…‘")
                             ("attr_latex" . "ğŸ„›")
                             ("attr_html" . "ğŸ„—")
                             ("attr_org" . "â’ª")
                             ("call" . "ó°œ")
                             ("name" . "â")
                             ("header" . "â€º")
                             ("caption" . "â˜°")
                             ("results" . "ğŸ ¶"))
        org-auto-align-tags nil
        org-tags-column 0
        org-catch-invisible-edits 'show-and-error
        org-special-ctrl-a/e t
        org-hide-emphasis-markers t
        org-agenda-tags-column 0
        org-agenda-block-separator ?â”€
        org-agenda-time-grid '((daily today require-timed)
                               (800 1000 1200 1400 1600 1800 2000)
                               " â”„â”„â”„â”„â”„ " "â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„")
        org-agenda-current-time-string "â­  now â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        )
  (custom-set-variables '(org-modern-statistics :inherit org-checkbox-statistics-todo)))
#+end_src

**** å¼ºè°ƒæ ‡è®°

è™½ç„¶ ~org-hide-emphasis-markers~ éå¸¸å¥½ï¼Œä½†æœ‰æ—¶å®ƒä¼šä½¿è¾¹ç•Œå¤„çš„ç¼–è¾‘å˜å¾—æ›´åŠ ç¹çã€‚
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ =org-appear= åŒ…åœ¨ä¸ç‰ºç‰²è§†è§‰ä¾¿åˆ©çš„æƒ…å†µä¸‹æ”¹å–„è¿™ç§æƒ…å†µã€‚

#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! org-appear
  :recipe (:host github :repo "awth13/org-appear"))
#+end_src

#+begin_src emacs-lisp
(use-package! org-appear
  :hook (org-mode . org-appear-mode)
  :config
  (setq! org-appear-autoemphasis t
         org-appear-autosubmarkers t
         org-appear-autolinks nil)
  ;; for proper first-time setup, `org-appear--set-elements'
  ;; needs to be run after other hooks have acted.
  (run-at-time nil nil #'org-appear--set-elements))
#+end_src

**** ç¬¦å·

æœ¬èº«ä¸ç”¨åŠ è¿™ä¸ªåŒ…çš„ï¼Œä¸è¿‡ç§»é™¤äº† doom é…ç½®é‡Œçš„ `(org +pretty)` çš„é€‰é¡¹ï¼Œåªå¥½è‡ªå·±æ‰‹
åŠ¨æ¥åšè¿™ä»¶äº‹äº†ã€‚

#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! org-fancy-priorities
  :recipe (:host github :repo "harrybournis/org-fancy-priorities"))
#+end_src

æ›´æ”¹ç”¨äºæŠ˜å é¡¹ç›®çš„å­—ç¬¦ä¹Ÿå¾ˆå¥½ (é»˜è®¤æƒ…å†µä¸‹ ~â€¦~)ï¼Œæˆ‘è®¤ä¸ºç”¨ ~â–¾~ æ›´é€‚åˆæŒ‡ç¤º ã€ŒæŠ˜å éƒ¨
åˆ†ã€ã€‚å¹¶åœ¨é»˜è®¤çš„å››ä¸ªåˆ—è¡¨ä¸­æ·»åŠ ä¸€ä¸ªé¢å¤–çš„ ~org-bullet~ ã€‚å¯¹äº†ï¼Œåˆ«å¿˜è®°ä¼˜å…ˆçº§ä¹Ÿè¦ä¿®
æ”¹ã€‚

#+begin_src emacs-lisp
(use-package! org-fancy-priorities
  :ensure t
  :hook (org-mode . org-fancy-priorities-mode)
  :custom (org-lowest-priority ?E)
  :config (setq! org-fancy-priorities-list '("âš¡" "â†‘" "â†“" "â˜•" "â“")))
(setq! org-ellipsis " â–¾ "
       org-hide-leading-stars t
       org-priority-highest ?A
       org-priority-lowest ?E
       org-priority-faces
       '((?A . 'nerd-icons-red)
         (?B . 'nerd-icons-orange)
         (?C . 'nerd-icons-yellow)
         (?D . 'nerd-icons-green)
         (?E . 'nerd-icons-blue)))
(setq! +ligatures-extra-symbols
          (list :list_property "âˆ·"
                :em_dash       "â€”"
                :ellipses      "â€¦"
                :arrow_right   "â†’"
                :arrow_left    "â†"
                :arrow_lr      "â†”"
                :properties    "âš™"
                :end           "âˆ"
                :priority_a    #("âš‘" 0 1 (face nerd-icons-red))
                :priority_b    #("â¬†" 0 1 (face nerd-icons-orange))
                :priority_c    #("â– " 0 1 (face nerd-icons-yellow))
                :priority_d    #("â¬‡" 0 1 (face nerd-icons-green))
                :priority_e    #("â“" 0 1 (face nerd-icons-blue))))

(defadvice! +org-init-appearance-h--no-ligatures-a ()
  :after #'+org-init-appearance-h
  (set-ligatures! 'org-mode nil)
  (set-ligatures! 'org-mode
    :list_property "::"
    :em_dash       "---"
    :ellipsis      "..."
    :arrow_right   "->"
    :arrow_left    "<-"
    :arrow_lr      "<->"
    :properties    ":PROPERTIES:"
    :end           ":END:"
    :priority_a    "[#A]"
    :priority_b    "[#B]"
    :priority_c    "[#C]"
    :priority_d    "[#D]"
    :priority_e    "[#E]"))
#+end_src

**** LaTeX ç‰‡æ®µ

è®©å…¬å¼ç¨ç¨å¥½çœ‹ä¸€ç‚¹ç‚¹
#+begin_src emacs-lisp
(setq! org-highlight-latex-and-related '(latex script entities))
#+end_src

ç†æƒ³æƒ…å†µä¸‹ ~org-src-font-lock-fontify-block~ ä¸ä¼šæ·»åŠ  =org-block= ï¼Œä½†æˆ‘
ä»¬å¯ä»¥é€šè¿‡æ·»åŠ å¸¦æœ‰ =:inherit default= é¢æ¥é¿å…æ•´ä¸ªåŠŸèƒ½ï¼Œè¿™å°†è¦†ç›–èƒŒæ™¯é¢œè‰²ã€‚

æ£€æŸ¥ ~org-do-latex-and-related~ æ˜¾ç¤º ="latex"= æ˜¯ä¼ é€’çš„è¯­è¨€å‚æ•°ï¼Œå› æ­¤æˆ‘ä»¬
å¯ä»¥å¦‚ä¸Šæ‰€è¿°è¦†ç›–èƒŒæ™¯ã€‚
#+begin_src emacs-lisp
(require 'org-src)
(add-to-list 'org-src-block-faces '("latex" (:inherit default :extend t)))
#+end_src

æ¯”è¯­æ³•é«˜äº®çš„ LaTeX æ›´å¥½çš„æ˜¯ /å‘ˆç°/ LaTeXã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ =org-fragtog= è‡ªåŠ¨æ‰§
è¡Œæ­¤æ“ä½œã€‚

#+begin_src emacs-lisp :noweb-ref none :tangle packages.el
(package! org-fragtog)
#+end_src

#+begin_src emacs-lisp
(use-package! org-fragtog :hook (org-mode . org-fragtog-mode))
#+end_src

è‡ªå®šä¹‰ LaTeX ç‰‡æ®µçš„å¤–è§‚å¾ˆèˆ’é€‚ï¼Œè¿™æ ·å®ƒä»¬å°±æ›´é€‚åˆæ–‡æœ¬äº† --- æ¯”å¦‚è¿™ä¸ª
$\sqrt{\beta^2+3}-\sum_{\phi=1}^\infty \frac{x^\phi-1}{\Gamma(a)}$â€‹ã€‚

#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
(setq! org-preview-latex-default-process 'dvisvgm
       org-preview-latex-process-alist
       '((dvipng :programs ("latex" "dvipng")
          :description "dvi --> png"
          :message "you need to install the programs: latex and dvipng."
          :image-input-type "dvi"
          :image-output-type "png"
          :image-size-adjust (1.0 . 1.0)
          :latex-compiler ("lualatex --shell-escape --output-format=dvi --interaction=nonstopmode --output-directory=%o %f")
          :image-converter ("dvipng -D %D -T tight -bg Transparent -o %O %f"))
         (dvisvgm :programs ("latex" "dvisvgm")
                  :description "dvi --> svg"
                  :message "you need to install the programs: latex and dvisvgm."
                  :use-xcolor t
                  :image-input-type "dvi"
                  :image-output-type "svg"
                  :image-size-adjust (1.7 . 1.5)
                  :latex-compiler ("lualatex --shell-escape --output-format=dvi --interaction=nonstopmode --output-directory=%o %f")
                  :image-converter ("dvisvgm %f --no-specials=bgcolor -n -b min -c %S -o %O"))
         (imagemagick :programs ("latex" "convert")
                      :description "pdf --> png"
                      :message "you need to install the programs: latex and imagemagick."
                      :use-xcolor t
                      :image-input-type "pdf"
                      :image-output-type "png"
                      :image-size-adjust (1.0 . 1.0)
                      :latex-compiler ("lualatex --shell-escape --output-format=pdf --interaction=nonstopmode --output-directory=%o %f")
                      :image-converter ("convert -density %D -trim -antialias %f -quality 100 %O")))
       org-format-latex-header "
\\documentclass{standalone}
[DEFAULT-PACKAGES]
[PACKAGES]
% Custom font
\\usepackage{arev}

<<latex-maths-conveniences>>
")
(plist-put org-format-latex-options :background "Transparent")
(plist-put org-format-latex-options :zoom 0.93) ; Calibrated based on the TeX font and org-buffer font.
#+end_src

é¡ºä¾¿è®¾ç½®ä¸‹èƒŒæ™¯

#+begin_src emacs-lisp
(defun +org-refresh-latex-images-previews-h ()
  (dolist (buffer (doom-buffers-in-mode 'org-mode (buffer-list)))
    (with-current-buffer buffer
      (+org--toggle-inline-images-in-subtree (point-min) (point-max) 'refresh)
      (unless (eq org-latex-preview-default-process 'dvisvgm)
        (org-clear-latex-preview (point-min) (point-max))
        (org--latex-preview-region (point-min) (point-max))))))

(add-hook! doom-load-theme #'+org-refresh-latex-images-previews-h)
#+end_src

**** å­—ä½“åŒ–å†…è” src å—

Org ä½¿ç”¨ =#+begin_src= å—åšäº†ä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚åœ¨å¹•åä½¿ç”¨ font-lock ä½œä¸ºè¯­è¨€çš„ä¸»è¦æ¨¡
å¼å¹¶æ‹‰å‡ºè‰¯å¥½çš„å½©è‰²ç»“æœã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå†…è” =src_= å—åœ¨æŸç§ç¨‹åº¦ä¸Šè¢«å¿½ç•¥äº†ã€‚

æˆ‘ä¸æ˜¯ç¬¬ä¸€ä¸ªæœ‰è¿™ç§æ„Ÿè§‰çš„äºº, å¹¸å¥½ä»–ä»¬å·²ç»å¼€å§‹åœ¨ [[https://stackoverflow.com/questions/20309842/how-to-syntax-highlight-for-org-mode-inline-source-code-src-lang/28059832][stackexchange]] ä¸Šå¼€å§‹è®¨è®ºäº†ã€‚ æˆ‘æ‰“
ç®—ç›´æ¥ä½¿ç”¨ä»–ä»¬çš„ç»“æœï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼Œä»–ä»¬æ²¡æœ‰æ‰§è¡Œ /true/ æºä»£ç å­—ä½“åŒ–ï¼Œè€Œåªæ˜¯å°†
=org-code= åº”ç”¨åœ¨å†…å®¹ä¸Šã€‚

æˆ‘ä»¬å¯ä»¥åšå¾—æ¯”è¿™æ›´å¥½ï¼ä½¿ç”¨ ~org-src-font-lock-fontify-block~ æˆ‘ä»¬å¯ä»¥åº”ç”¨é€‚åˆè¯­
è¨€çš„è¯­æ³•é«˜äº®ã€‚ç„¶åï¼Œç»§ç»­åˆ° ={{{results(...)}}}=ï¼Œå®ƒå¯ä»¥å°† =org-block= åº”ç”¨ç›¸åº”çš„
è§„åˆ™ï¼Œç„¶åé€šè¿‡æ¨¡ä»¿ ~prettify-symbols-mode~ çš„è¡Œä¸ºéšè—å€¼åŒ…å›´ç»“æ„ã€‚

#+begin_warning
ä½†ç›®å‰åªèƒ½ä¸€è¡Œé«˜äº®ä¸€ä¸ªå†…è” src å—ã€‚æˆ‘ä¸çŸ¥é“å®ƒä¸ºä»€ä¹ˆä¼šåœæ­¢ï¼Œæˆ‘å¸Œæœ›å®ƒæ­£å¸¸ã€‚å¦‚æœæ‚¨
çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆæˆ–å¦‚ä½•è§£å†³æ­¤é—®é¢˜ /è¯·/ è”ç³»ã€‚
#+end_warning

#+begin_src emacs-lisp
(setq! org-inline-src-prettify-results '("âŸ¨" . "âŸ©"))
#+end_src

Doom ä¸»é¢˜çš„é¢å¤–å­—ä½“åŒ–é—®é¢˜å¤šäºå¸®åŠ©ã€‚
#+begin_src emacs-lisp
(setq! doom-themes-org-fontify-special-tags nil)
#+end_src


*** Babel
:properties:
:CUSTOM_ID: org_babel_generic
:header-args:emacs-lisp: :tangle no :noweb-ref org-babel-conf
:end:

æˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ªé€šå¤©çš„å·´åˆ«å¡”ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åœ¨ org-mode çš„ä»»æ„ä½ç½®ç¼–å†™ä»¥åŠè¿è¡Œä»»ä½•
ç¼–ç¨‹è¯­è¨€ï¼

#+begin_src emacs-lisp :noweb no-export :noweb-ref org-conf :tangle no
<<org-babel-conf>>
#+end_src

**** LaTeX

å¦‚æœå¯¼å‡ºåˆ°æ–‡ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨å®šåˆ¶åŒ–çš„ LaTeX å¯¼å‡ºï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ‰€æœ‰å…³äºæˆ‘ä»¬å¯¹äº org-mode
latex çš„å®šåˆ¶åŒ–è®¾ç½®ã€‚(HTML é™¤å¤–ï¼Ÿ)

#+begin_src emacs-lisp
(defadvice! org-babel-execute-latex-export-file (orig-fn body params)
  "Like `org-babel-execute:latex', support org-format-latex-header for all"
  :around #'org-babel-execute:latex
  (if (string-suffix-p ".html" (cdr (assq :file params)))
      (funcall orig-fn body params)
    (let ((expanded-body (org-babel-expand-body:latex body params))
          (latex-compiler
           (list :latex-compiler (or (cadar (org-collect-keywords '("latex_compiler"))) org-latex-compiler))))
      (if (cdr (assq :file params))
          (ginshio/org-babel-execute-latex-export-file latex-compiler expanded-body params)
        expanded-body))))

(defun ginshio/org-babel-execute-latex-export-file (latex-compiler body params)
  (let* ((out-file (cdr (assq :file params)))
         (extension (file-name-extension out-file))
         (tex-file (org-babel-temp-file "latex-" ".tex"))
         (border (cdr (assq :border params)))
         (imagemagick (cdr (assq :imagemagick params)))
         (fit (or (cdr (assq :fit params)) border))
         (headers (cdr (assq :headers params))))
    (stringp nil)
    (with-temp-file tex-file
      (require 'ox-latex)
      (insert
       (org-latex--insert-compiler latex-compiler)
       (org-latex-guess-inputenc
        (org-splice-latex-header
         org-format-latex-header
         (delq nil
               (mapcar
                (lambda (el)
                  (unless (and (listp el) (string= "hyperref" (cadr el))) el))
                org-latex-default-packages-alist))
         (append (cdr (assq :packages params)) org-latex-packages-alist)
         nil))
       (if (string= "png" extension)
           (format "%s%s%s%s"
                   (if fit "\n\\usepackage[active,tightpage]{preview}\n" "")
                   (if border (format "\\setlength{\\PreviewBorder}{%s}\n" border) "")
                   (let ((height (and fit (cdr (assq :pdfheight params)))))
                     (if height (format "\\pdfpageheight %s\n" height) ""))
                   (let ((width (and fit (cdr (assq :pdfwidth params)))))
                     (if width (format "\\pdfpageheight %s\n" width) "")))
         "")
       (if headers
           (concat "\n"
                   (if (listp headers)
                       (mapconcat #'identity headers "\n")
                     headers) "\n")
         "")
       (if (and fit (string= "png" extension))
           (concat "\n\\begin{document}\n\\begin{preview}\n" body
                   "\n\\end{preview}\n\\end{document}\n")
         (concat "\n\\begin{document}\n" body "\n\\end{document}\n"))))
    (when (file-exists-p out-file) (delete-file out-file))
    (if (string= "tex" extension)
        (rename-file tex-file out-file)
      (let* ((transient-pdf-file (org-babel-latex-tex-to-pdf tex-file)))
        (cond
         ((string= "pdf" extension)
          (rename-file transient-pdf-file out-file))
         ((and (string= "png" extension) imagemagick)
          (org-babel-latex-convert-pdf
           transient-pdf-file out-file (cdr (assq :iminoptions params)) (cdr (assq :imoutoptions params))))
         ((string= "svg" extension)
          (let* ((log-buf (get-buffer-create "*Org Babel LaTeX Output*"))
                 (err-msg "org babel latex failed")
                 (img-out (org-compile-file
                           transient-pdf-file
                           (list org-babel-latex-pdf-svg-process)
                           extension err-msg log-buf)))
            (rename-file img-out out-file)))
         (t
          (error "Can not create %s files, please specify a .svg, .png or .pdf file or try the :imagemagick header argument"
                 extension)))))))
#+end_src

*** å¯¼å‡ºé€šç”¨è®¾ç½®
:properties:
:CUSTOM_ID: org_export_generic
:header-args:emacs-lisp: :tangle no :noweb-ref org-export-conf
:end:

é»˜è®¤æƒ…å†µä¸‹ï¼ŒOrg ä»…å°†å‰ä¸‰ä¸ªçº§åˆ«çš„æ ‡é¢˜å¯¼å‡ºä¸ºæ ‡é¢˜ã€‚å½“ä½¿ç”¨ =article= æ—¶ï¼ŒLaTeX æ ‡é¢˜
ä» =\section=â€‹ã€â€‹=\subsection=â€‹ã€â€‹=\subsubsection= å’Œ =\paragraph=â€‹ã€
=\subgraph= --- /äº”/ ä¸ªçº§åˆ«ã€‚HTML5 æœ‰å…­çº§æ ‡é¢˜ (=<h1>= åˆ° =<h6>=)ï¼Œä½†ç¬¬ä¸€çº§ Org
æ ‡é¢˜è¢«å¯¼å‡ºä¸º =<h2>= å…ƒç´  --- å‰©ä¸‹ /äº”/ ä¸ªå¯ç”¨çº§åˆ«ã€‚

#+begin_src emacs-lisp :noweb no-export :noweb-ref org-conf :tangle no
(setq! org-export-headline-levels 5)
(after! ox
  <<org-export-conf>>
  )
#+end_src

æˆ‘è¿˜å°†ä½¿ç”¨ =ox-extra= ä¸­çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä»¥ä¾¿æˆ‘å¯ä»¥åœ¨æ ‡é¢˜ä¸­æ·»åŠ ä¸€ä¸ª =:ignore:= æ ‡è®°ä»¥
ä¿ç•™å†…å®¹ï¼Œä½†æ ‡é¢˜æœ¬èº«ä¼šè¢«å¿½ç•¥ï¼ˆâ€‹=:noexport:= å®ƒå¿½ç•¥äº†æ ‡é¢˜å’Œå†…å®¹ï¼‰ã€‚å½“æˆ‘æƒ³ä½¿ç”¨æ ‡é¢˜
æ¥æä¾›æœªå‡ºç°åœ¨æœ€ç»ˆæ–‡æ¡£ä¸­çš„å†™ä½œç»“æ„æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚

#+begin_src emacs-lisp
(require 'ox-extra)
(ox-extras-activate '(ignore-headlines))
#+end_src

ç”±äºæˆ‘ï¼ˆå¤§è‡´ï¼‰è·Ÿè¸ª Org ~HEAD~â€‹ï¼Œå› æ­¤åœ¨åˆ›å»ºè€…å­—ç¬¦ä¸²ä¸­åŒ…å« git ç‰ˆæœ¬æ˜¯æœ‰æ„ä¹‰çš„ã€‚
#+begin_src emacs-lisp
(setq! org-export-creator-string
       (format "Emacs %s (Org mode %sâ€“%s)" emacs-version (org-release) (org-git-version)))
#+end_src

åœ¨å¯¼å‡ºæ—¶ï¼Œæˆ‘å¹¶ä¸æƒ³è¦é›¶å®½åº¦ç©ºæ ¼ï¼ŒåŠ ä¸€ä¸ªç®€å•çš„è¿‡æ»¤å™¨å°†å…¶è¿‡æ»¤æ‰ã€‚
#+begin_src emacs-lisp
(defun +org-export-remove-zero-width-space (text _backend _info)
  "Remove zero width spaces from TEXT."
  (unless (org-export-derived-backend-p 'org)
    (replace-regexp-in-string "\u200B" "" text)))
(add-to-list 'org-export-filter-final-output-functions #'+org-export-remove-zero-width-space t)
#+end_src

*** HTML å¯¼å‡º
:properties:
:CUSTOM_ID: org_export_html
:header-args:emacs-lisp: :tangle no :noweb-ref ox-html-conf
:end:

#+begin_src emacs-lisp :noweb no-export :noweb-ref org-export-conf :tangle no
(setq! org-html-style-plain org-html-style-default
       org-html-htmlize-output-type 'css
       org-html-doctype "html5"
       org-html-html5-fancy t)
(after! ox-html
  <<ox-html-conf>>
  )
#+end_src

#+begin_src emacs-lisp
(define-minor-mode org-fancy-html-export-mode
  "Toggle my fabulous org export tweaks. While this mode itself does a little bit,
the vast majority of the change in behaviour comes from switch statements in:
 - `org-html-template-fancier'
 - `org-html--build-meta-info-extended'
 - `org-html-src-block-collapsable'
 - `org-html-block-collapsable'
 - `org-html-table-wrapped'
 - `org-html--format-toc-headline-colapseable'
 - `org-html--toc-text-stripped-leaves'
 - `org-export-html-headline-anchor'"
  :global t
  :init-value t
  (if org-fancy-html-export-mode
      (setq org-html-style-default org-html-style-fancy
            org-html-meta-tags #'org-html-meta-tags-fancy
            org-html-checkbox-type 'html-span)
    (setq org-html-style-default org-html-style-plain
          org-html-meta-tags #'org-html-meta-tags-default
          org-html-checkbox-type 'html)))
#+end_src

**** é¢å¤–çš„ head

åœ¨ä¸»ä½“çš„å¼€å¤´æ·»åŠ æ›´å¤šä¿¡æ¯ï¼Œåœ¨é¡µçœ‰ä¸­æ·»åŠ æ—¥æœŸå’Œä½œè€…ï¼Œå®ç°ä»… CSS çš„äº®/æš—ä¸»é¢˜åˆ‡æ¢ï¼Œä»¥åŠä¸€äº›
[[https://ogp.me/][Open Graph]] å…ƒæ•°æ®ã€‚

#+begin_src emacs-lisp
(defadvice! org-html-template-fancier (orig-fn contents info)
  "Return complete document string after HTML conversion.
CONTENTS is the transcoded contents string.  INFO is a plist
holding export options. Adds a few extra things to the body
compared to the default implementation."
  :around #'org-html-template
  (if (or (not org-fancy-html-export-mode) (bound-and-true-p org-msg-export-in-progress))
      (funcall orig-fn contents info)
    (concat
     (when (and (not (org-html-html5-p info)) (org-html-xhtml-p info))
       (let* ((xml-declaration (plist-get info :html-xml-declaration))
              (decl (or (and (stringp xml-declaration) xml-declaration)
                        (cdr (assoc (plist-get info :html-extension)
                                    xml-declaration))
                        (cdr (assoc "html" xml-declaration))
                        "")))
         (when (not (or (not decl) (string= "" decl)))
           (format "%s\n"
                   (format decl
                           (or (and org-html-coding-system
                                    (fboundp 'coding-system-get)
                                    (coding-system-get org-html-coding-system 'mime-charset))
                               "iso-8859-1"))))))
     (org-html-doctype info)
     "\n"
     (concat "<html"
             (cond ((org-html-xhtml-p info)
                    (format
                     " xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"%s\" xml:lang=\"%s\""
                     (plist-get info :language) (plist-get info :language)))
                   ((org-html-html5-p info)
                    (format " lang=\"%s\"" (plist-get info :language))))
             ">\n")
     "<head>\n"
     (org-html--build-meta-info info)
     (org-html--build-head info)
     (org-html--build-mathjax-config info)
     "</head>\n"
     "<body>\n<input type='checkbox' id='theme-switch'><div id='page'><label id='switch-label' for='theme-switch'></label>"
     (let ((link-up (org-trim (plist-get info :html-link-up)))
           (link-home (org-trim (plist-get info :html-link-home))))
       (unless (and (string= link-up "") (string= link-home ""))
         (format (plist-get info :html-home/up-format)
                 (or link-up link-home)
                 (or link-home link-up))))
     ;; Preamble.
     (org-html--build-pre/postamble 'preamble info)
     ;; Document contents.
     (let ((div (assq 'content (plist-get info :html-divs))))
       (format "<%s id=\"%s\">\n" (nth 1 div) (nth 2 div)))
     ;; Document title.
     (when (plist-get info :with-title)
       (let ((title (and (plist-get info :with-title)
                         (plist-get info :title)))
             (subtitle (plist-get info :subtitle))
             (html5-fancy (org-html--html5-fancy-p info)))
         (when title
           (format
            (if html5-fancy
                "<header class=\"page-header\">%s\n<h1 class=\"title\">%s</h1>\n%s</header>"
              "<h1 class=\"title\">%s%s</h1>\n")
            (if (or (plist-get info :with-date)
                    (plist-get info :with-author))
                (concat "<div class=\"page-meta\">"
                        (when (plist-get info :with-date)
                          (org-export-data (plist-get info :date) info))
                        (when (and (plist-get info :with-date) (plist-get info :with-author)) ", ")
                        (when (plist-get info :with-author)
                          (org-export-data (plist-get info :author) info))
                        "</div>\n")
              "")
            (org-export-data title info)
            (if subtitle
                (format
                 (if html5-fancy
                     "<p class=\"subtitle\" role=\"doc-subtitle\">%s</p>\n"
                   (concat "\n" (org-html-close-tag "br" nil info) "\n"
                           "<span class=\"subtitle\">%s</span>\n"))
                 (org-export-data subtitle info))
              "")))))
     contents
     (format "</%s>\n" (nth 1 (assq 'content (plist-get info :html-divs))))
     ;; Postamble.
     (org-html--build-pre/postamble 'postamble info)
     ;; Possibly use the Klipse library live code blocks.
     (when (plist-get info :html-klipsify-src)
       (concat "<script>" (plist-get info :html-klipse-selection-script)
               "</script><script src=\""
               org-html-klipse-js
               "\"></script><link rel=\"stylesheet\" type=\"text/css\" href=\""
               org-html-klipse-css "\"/>"))
     ;; Closing document.
     "</div>\n</body>\n</html>")))
#+end_src

**** è‡ªå®šä¹‰ CSS/JS

[[https://lepisma.xyz][lepisma.xyz]] æ‰€åšçš„å¯¼å‡ºé£æ ¼éå¸¸è®¨å–œã€‚

#+begin_src html :tangle misc/org-export-header.html :comments no :mkdirp yes
<link rel="icon" href="https://tecosaur.com/resources/org/nib.ico" type="image/ico" />
<link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="https://tecosaur.com/resources/org/etbookot-roman-webfont.woff2">
<link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="https://tecosaur.com/resources/org/etbookot-italic-webfont.woff2">
<link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="https://tecosaur.com/resources/org/Merriweather-TextRegular.woff2">
<link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="https://tecosaur.com/resources/org/Merriweather-TextItalic.woff2">
<link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="https://tecosaur.com/resources/org/Merriweather-TextBold.woff2">
#+end_src

#+begin_src emacs-lisp


(defun org-html-reload-fancy-style ()
  (interactive)
  (setq org-html-style-fancy
        (with-temp-buffer
          (insert-file-contents (expand-file-name "misc/org-export-header.html" doom-user-dir))
          (goto-char (point-max))
          (insert "<script>\n")
          (insert-file-contents (expand-file-name "misc/org-css/main.js" doom-user-dir))
          (goto-char (point-max))
          (insert "</script>\n<style>\n")
          (insert-file-contents (expand-file-name "misc/org-css/main.min.css" doom-user-dir))
          (goto-char (point-max))
          (insert "</style>")
          (buffer-string)))
  (when org-fancy-html-export-mode
    (setq org-html-style-default org-html-style-fancy)))
(org-html-reload-fancy-style)
#+end_src

**** å¯æŠ˜å çš„ src å’Œç¤ºä¾‹å—

é€šè¿‡å°† ~<pre>~ å…ƒç´ åŒ…è£…åœ¨ ~<details>~ å—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ²¡æœ‰ CSS çš„å¯æŠ˜å å—ï¼Œ
å°½ç®¡æˆ‘ä»¬ä¼šç¨å¾®æŠ˜è…¾ä¸€ä¸‹ï¼Œè®©è¿™çœ‹èµ·æ¥æœ‰ç‚¹æ¼‚äº®ã€‚

ç”±äºé»˜è®¤æƒ…å†µä¸‹å¯¹æŸäº›ä»£ç å—å¯ç”¨å¯æŠ˜å æ€§ä¼¼ä¹å¾ˆæœ‰ç”¨ï¼Œå› æ­¤å¦‚æœæ‚¨å¯ä»¥ä½¿ç”¨
=#+attr_html: :collapsed t= è®¾ç½®å®ƒä¼šæ›´å¥½ã€‚

å¦‚æœæœ‰ä¸€ä¸ªç›¸åº”çš„å…¨å±€/ä¼šè¯æœ¬åœ°æ–¹å¼æ¥è®¾ç½®å®ƒä¼šå¾ˆå¥½ï¼Œä½†æˆ‘è¿˜æ²¡èƒ½è®©å®ƒæ­£å¸¸å·¥ä½œã€‚

#+begin_src emacs-lisp
(defvar org-html-export-collapsed nil)
(eval '(cl-pushnew '(:collapsed "COLLAPSED" "collapsed" org-html-export-collapsed t)
                   (org-export-backend-options (org-export-get-backend 'html))))
(add-to-list 'org-default-properties "EXPORT_COLLAPSED")
#+end_src

æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ä¿®æ”¹ src å—ï¼Œå¹¶åœ¨ src å—çš„ä¸€ä¾§æ·»åŠ ä¸€ä¸ªå—ï¼Œå…¶ä¸­åŒ…å«å¼•ç”¨å½“å‰å—çš„é”šç‚¹å’Œ
å¤åˆ¶å—å†…å®¹çš„æŒ‰é’®ã€‚

#+begin_src emacs-lisp
(defadvice! org-html-src-block-collapsable (orig-fn src-block contents info)
  "Wrap the usual <pre> block in a <details>"
  :around #'org-html-src-block
  (if (or (not org-fancy-html-export-mode) (bound-and-true-p org-msg-export-in-progress))
      (funcall orig-fn src-block contents info)
    (let* ((properties (cadr src-block))
           (lang (mode-name-to-lang-name
                  (plist-get properties :language)))
           (name (plist-get properties :name))
           (ref (org-export-get-reference src-block info))
           (collapsed-p (member (or (org-export-read-attribute :attr_html src-block :collapsed)
                                    (plist-get info :collapsed))
                                '("y" "yes" "t" t "true" "all"))))
      (format
       "<details id='%s' class='code'%s><summary%s>%s</summary>
<div class='gutter'>
<a href='#%s'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>â˜</button>\
</div>
%s
</details>"
       ref
       (if collapsed-p "" " open")
       (if name " class='named'" "")
       (concat
        (when name (concat "<span class=\"name\">" name "</span>"))
        "<span class=\"lang\">" lang "</span>")
       ref
       (if name
           (replace-regexp-in-string (format "<pre\\( class=\"[^\"]+\"\\)? id=\"%s\">" ref) "<pre\\1>"
                                     (funcall orig-fn src-block contents info))
         (funcall orig-fn src-block contents info))))))

(defun mode-name-to-lang-name (mode)
  (or (cadr (assoc mode
                   '(("asymptote" "Asymptote")
                     ("awk" "Awk")
                     ("C" "C")
                     ("clojure" "Clojure")
                     ("css" "CSS")
                     ("D" "D")
                     ("ditaa" "ditaa")
                     ("dot" "Graphviz")
                     ("calc" "Emacs Calc")
                     ("emacs-lisp" "Emacs Lisp")
                     ("fortran" "Fortran")
                     ("gnuplot" "gnuplot")
                     ("haskell" "Haskell")
                     ("hledger" "hledger")
                     ("java" "Java")
                     ("js" "Javascript")
                     ("latex" "LaTeX")
                     ("ledger" "Ledger")
                     ("lisp" "Lisp")
                     ("lilypond" "Lilypond")
                     ("lua" "Lua")
                     ("matlab" "MATLAB")
                     ("mscgen" "Mscgen")
                     ("ocaml" "Objective Caml")
                     ("octave" "Octave")
                     ("org" "Org mode")
                     ("oz" "OZ")
                     ("plantuml" "Plantuml")
                     ("processing" "Processing.js")
                     ("python" "Python")
                     ("R" "R")
                     ("ruby" "Ruby")
                     ("sass" "Sass")
                     ("scheme" "Scheme")
                     ("screen" "Gnu Screen")
                     ("sed" "Sed")
                     ("sh" "shell")
                     ("sql" "SQL")
                     ("sqlite" "SQLite")
                     ("forth" "Forth")
                     ("io" "IO")
                     ("J" "J")
                     ("makefile" "Makefile")
                     ("maxima" "Maxima")
                     ("perl" "Perl")
                     ("picolisp" "Pico Lisp")
                     ("scala" "Scala")
                     ("shell" "Shell Script")
                     ("ebnf2ps" "ebfn2ps")
                     ("cpp" "C++")
                     ("abc" "ABC")
                     ("coq" "Coq")
                     ("groovy" "Groovy")
                     ("bash" "bash")
                     ("csh" "csh")
                     ("ash" "ash")
                     ("dash" "dash")
                     ("ksh" "ksh")
                     ("mksh" "mksh")
                     ("posh" "posh")
                     ("ada" "Ada")
                     ("asm" "Assembler")
                     ("caml" "Caml")
                     ("delphi" "Delphi")
                     ("html" "HTML")
                     ("idl" "IDL")
                     ("mercury" "Mercury")
                     ("metapost" "MetaPost")
                     ("modula-2" "Modula-2")
                     ("pascal" "Pascal")
                     ("ps" "PostScript")
                     ("prolog" "Prolog")
                     ("simula" "Simula")
                     ("tcl" "tcl")
                     ("tex" "LaTeX")
                     ("plain-tex" "TeX")
                     ("verilog" "Verilog")
                     ("vhdl" "VHDL")
                     ("xml" "XML")
                     ("nxml" "XML")
                     ("conf" "Configuration File"))))
      mode))
#+end_src

#+name: Example, fixed width, and property blocks
#+begin_src emacs-lisp
(defun org-html-block-collapsable (orig-fn block contents info)
  "Wrap the usual block in a <details>"
  (if (or (not org-fancy-html-export-mode) (bound-and-true-p org-msg-export-in-progress))
      (funcall orig-fn block contents info)
    (let ((ref (org-export-get-reference block info))
          (type (pcase (car block)
                  ('property-drawer "Properties")))
          (collapsed-default (pcase (car block)
                               ('property-drawer t)
                               (_ nil)))
          (collapsed-value (org-export-read-attribute :attr_html block :collapsed))
          (collapsed-p (or (member (org-export-read-attribute :attr_html block :collapsed)
                                   '("y" "yes" "t" t "true"))
                           (member (plist-get info :collapsed) '("all")))))
      (format
       "<details id='%s' class='code'%s>
<summary%s>%s</summary>
<div class='gutter'>\
<a href='#%s'>#</a>
<button title='Copy to clipboard' onclick='copyPreToClipbord(this)'>â˜</button>\
</div>
%s\n
</details>"
       ref
       (if (or collapsed-p collapsed-default) "" " open")
       (if type " class='named'" "")
       (if type (format "<span class='type'>%s</span>" type) "")
       ref
       (funcall orig-fn block contents info)))))

(advice-add 'org-html-example-block   :around #'org-html-block-collapsable)
(advice-add 'org-html-fixed-width     :around #'org-html-block-collapsable)
(advice-add 'org-html-property-drawer :around #'org-html-block-collapsable)
#+end_src

**** HTML åŒ–çš„å­—ä½“é”

Org ä½¿ç”¨ [[https://github.com/hniksic/emacs-htmlize][htmlize.el]] å¯¼å‡ºå¸¦æœ‰è¯­æ³•é«˜äº®çš„ç¼“å†²åŒºã€‚
åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹è¿™äº›æ ¼å¼éå¸¸æ£’ã€‚ä¸éœ€è¦åŠ è½½æä¾›å­—ä½“é”å®šçš„æ¬¡è¦æ¨¡å¼ï¼Œå› æ­¤ä¸ä¼šå½±å“ç»“æœã€‚
é€šè¿‡åœ¨ ~htmlize-before-hook~ ä¸­å¯ç”¨è¿™äº›æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥çº æ­£è¿™ç§è¡Œä¸ºã€‚

#+begin_src emacs-lisp
(require 'htmlize)
(add-hook! htmlize-before #'highlight-numbers--turn-on)
#+end_src

**** å¤„ç†è¡¨æº¢å‡º

ä¸ºäº†é€‚åº”å®½è¡¨ --- å°¤å…¶æ˜¯åœ¨ç§»åŠ¨è®¾å¤‡ä¸Š --- æˆ‘ä»¬æƒ³è¦è®¾ç½®æœ€å¤§å®½åº¦å’Œæ»šåŠ¨æº¢å‡ºã€‚ä¸å¹¸çš„æ˜¯ï¼Œ
è¿™ä¸èƒ½ç›´æ¥åº”ç”¨äº ~è¡¨æ ¼~ å…ƒç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»å°†å®ƒåŒ…è£…åœ¨ä¸€ä¸ª ~div~ ä¸­ã€‚

å½“æˆ‘ä»¬è¿™æ ·åšæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åƒæˆ‘ä»¬å¯¹ src å—æ‰€åšçš„é‚£æ ·ï¼Œè®¾ç½®ä¸€ä¸ªé“¾æ¥å—ï¼Œå¹¶æ˜¾ç¤º
~#+name~ (å¦‚æœæœ‰çš„è¯)ã€‚

#+begin_src emacs-lisp
(defadvice! org-html-table-wrapped (orig-fn table contents info)
  "Wrap the usual <table> in a <div>"
  :around #'org-html-table
  (if (or (not org-fancy-html-export-mode) (bound-and-true-p org-msg-export-in-progress))
      (funcall orig-fn table contents info)
    (let* ((name (plist-get (cadr table) :name))
           (ref (org-export-get-reference table info)))
      (format "<div id='%s' class='table'>
<div class='gutter'><a href='#%s'>#</a></div>
<div class='tabular'>
%s
</div>\
</div>"
              ref ref
              (if name
                  (replace-regexp-in-string (format "<table id=\"%s\"" ref) "<table"
                                            (funcall orig-fn table contents info))
                (funcall orig-fn table contents info))))))
#+end_src

**** å¯å±•å¼€çš„ç›®å½•æ ‘

TOC ä½œä¸ºå¯æŠ˜å æ ‘æ›´æ˜“äºå¯¼èˆªã€‚ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½å•ç‹¬ä½¿ç”¨ CSS æ¥å®ç°è¿™ä¸€ç‚¹ã€‚å€¼å¾—åº†å¹¸
çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒæ•´ TOC ç”Ÿæˆä»£ç æ¥ä¸ºæ¯ä¸ªé¡¹ç›®ä½¿ç”¨ä¸€ä¸ª ~æ ‡ç­¾~ ï¼Œä»¥åŠä¸€ä¸ªéšè—çš„
~å¤é€‰æ¡†~ æ¥è·Ÿè¸ªçŠ¶æ€ï¼Œä»è€Œé¿å…ä½¿ç”¨ JSã€‚

è¦æ·»åŠ å®ƒï¼Œæˆ‘ä»¬éœ€è¦åœ¨ ~org-html--format-toc-headline~ ä¸­æ›´æ”¹ä¸€è¡Œã€‚

å› ä¸ºæˆ‘ä»¬å®é™…ä¸Šå¯ä»¥é€šè¿‡åœ¨å‡½æ•°å‘¨å›´æ·»åŠ å»ºè®®æ¥å®ç°æ‰€éœ€çš„æ•ˆæœï¼Œè€Œæ— éœ€è¦†ç›–å®ƒ --- è®©æˆ‘ä»¬è¿™
æ ·åšæ¥å‡å°‘è¿™ä¸ªé…ç½®çš„é”™è¯¯è¡¨é¢ã€‚
#+begin_src emacs-lisp
(defadvice! org-html--format-toc-headline-colapseable (orig-fn headline info)
  "Add a label and checkbox to `org-html--format-toc-headline's usual output,
to allow the TOC to be a collapseable tree."
  :around #'org-html--format-toc-headline
  (if (or (not org-fancy-html-export-mode) (bound-and-true-p org-msg-export-in-progress))
      (funcall orig-fn headline info)
    (let ((id (or (org-element-property :CUSTOM_ID headline)
                  (org-export-get-reference headline info))))
      (format "<input type='checkbox' id='toc--%s'/><label for='toc--%s'>%s</label>"
              id id (funcall orig-fn headline info)))))
#+end_src

ç°åœ¨ï¼Œå¶å­ (æ²¡æœ‰å­æ ‡é¢˜çš„æ ‡é¢˜) ä¸åº”è¯¥æœ‰ ~æ ‡ç­¾é¡¹~ ã€‚å®ç°è¿™ä¸€ç‚¹çš„æ˜æ˜¾æ–¹æ³•æ˜¯åœ¨
~org-html--format-toc-headline-colapseable~ ä¸­åŒ…å«ä¸€äº› (å¦‚æœæ²¡æœ‰å­é¡¹) é€»è¾‘
ã€‚ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘çš„ elisp æ— æ³•ä» org æä¾›çš„å¤§é‡ä¿¡æ¯ä¸­æå–å­æ ‡é¢˜çš„æ•°é‡ã€‚
#+begin_src emacs-lisp
(defadvice! org-html--toc-text-stripped-leaves (orig-fn toc-entries)
  "Remove label"
  :around #'org-html--toc-text
  (if (or (not org-fancy-html-export-mode) (bound-and-true-p org-msg-export-in-progress))
      (funcall orig-fn toc-entries)
    (replace-regexp-in-string "<input [^>]+><label [^>]+>\\(.+?\\)</label></li>" "\\1</li>"
                              (funcall orig-fn toc-entries))))
#+end_src

**** ä½¿ verbatim ä¸ code ä¸åŒ (HTML)

è®©æˆ‘ä»¬ä¸º =varbatim= å’Œ ~code~ æ·»åŠ ä¸€äº›å·®å¼‚ã€‚

æˆ‘ä»¬å¯ä»¥å°† ~code~ ä¸“é—¨ç”¨äºä»£ç ç‰‡æ®µå’Œå‘½ä»¤ï¼Œä¾‹å¦‚ï¼šåœ¨ Emacs çš„æ‰¹å¤„ç†æ¨¡å¼ä¸­è°ƒç”¨
src_elisp{(message "Hello")} ä¼šåƒ ~echo~ ä¸€æ ·æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚ å¯ä»¥å¯¹
=verbatim= ä½¿ç”¨å„ç§ 'å…¶ä»–ç­‰å®½'ï¼Œä¾‹å¦‚é”®ç›˜å¿«æ·é”®ï¼š =C-c C-c= æˆ– =C-g= å¯èƒ½æ˜¯
Emacs ä¸­æœ€æœ‰ç”¨çš„å¿«æ·é”®ï¼Œæˆ–æ–‡ä»¶åï¼šæˆ‘å°†æˆ‘çš„é…ç½®ä¿å­˜åœ¨ =~/.config/doom/= ä¸­ï¼Œå…¶ä»–
æƒ…å†µåˆ™ä½¿ç”¨æ­£å¸¸æ ·å¼ã€‚

#+begin_src emacs-lisp
(setq org-html-text-markup-alist
      '((bold . "<b>%s</b>")
        (code . "<code>%s</code>")
        (italic . "<i>%s</i>")
        (strike-through . "<del>%s</del>")
        (underline . "<span class=\"underline\">%s</span>")
        (verbatim . "<kbd>%s</kbd>")))
#+end_src

**** æ”¹å˜å¤é€‰æ¡†ç±»å‹

æˆ‘ä»¬ä¹Ÿæƒ³ä½¿ç”¨ HTML å¤é€‰æ¡†ï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³æ¯”é»˜è®¤çš„æ›´æ¼‚äº®
#+begin_src emacs-lisp
(appendq! org-html-checkbox-types
          '((html-span
             (on . "<span class='checkbox'></span>")
             (off . "<span class='checkbox'></span>")
             (trans . "<span class='checkbox'></span>"))))
(setq! org-html-checkbox-type 'html-span)
#+end_src

- [ ] I'm yet to do this
- [-] Work in progress
- [X] This is done

**** é¢å¤–çš„ç‰¹æ®Šå­—ç¬¦ä¸²

~org-html-special-string-regexps~ å˜é‡å®šä¹‰äº†ä»¥ä¸‹å†…å®¹çš„æ›¿æ¢ï¼š
+ =\-=, shy è¿å­—ç¬¦
+ =---=, å¢å¼ºçš„ç ´æŠ˜å·
+ =--=, ç ´æŠ˜å·
+ =...=, (æ°´å¹³çš„) çœç•¥å·

ä½†æˆ‘è®¤ä¸ºå¦‚æœè¿˜å¯ä»¥æ›¿æ¢å·¦/å³ç®­å¤´ (=->= å’Œ =<-=) é‚£å°±æ›´å¥½äº†ã€‚ è¿™æ˜¯ä¸€ä¸ª
~defconst~ ï¼Œä½†æ­£å¦‚ä½ å¯ä»¥ä»è¿™ä¸ªé…ç½®ä¸­çš„å¤§é‡å»ºè®®ä¸­çœ‹å‡ºçš„é‚£æ ·ï¼Œæˆ‘å¹¶æ²¡æœ‰æ”¾å¼ƒæˆ‘ä¸ 'åº”
è¯¥' åšçš„äº‹æƒ…ã€‚

å”¯ä¸€çš„å°éº»çƒ¦æ˜¯åœ¨è¿™ä¸ªé˜¶æ®µçš„è¾“å‡ºå¤„ç†ä¹‹å‰ =<= å’Œ =>= è¢«è½¬æ¢ä¸º =&lt;= å’Œ =&gt;=â€‹ã€‚

#+begin_src emacs-lisp
(pushnew! org-html-special-string-regexps
          '("-&gt;" . "&#8594;")
          '("&lt;-" . "&#8592;"))
#+end_src

**** æ ‡é¢˜é”šç‚¹

ä¸€ä¸ª GitHub é£æ ¼çš„æ ‡é¢˜é“¾æ¥
#+begin_src emacs-lisp
(defun org-export-html-headline-anchor (text backend info)
  (when (and (org-export-derived-backend-p backend 'html)
             (not (org-export-derived-backend-p backend 're-reveal))
             org-fancy-html-export-mode)
    (unless (bound-and-true-p org-msg-export-in-progress)
      (replace-regexp-in-string
       "<h\\([0-9]\\) id=\"\\([a-z0-9-]+\\)\">\\(.*[^ ]\\)<\\/h[0-9]>" ; this is quite restrictive, but due to `org-reference-contraction' I can do this
       "<h\\1 id=\"\\2\">\\3<a aria-hidden=\"true\" href=\"#\\2\">#</a> </h\\1>"
       text))))
(add-to-list 'org-export-filter-headline-functions
             'org-export-html-headline-anchor)
#+end_src

**** LaTeX Rendering

å¦‚æœä½¿ç”¨ MathJaxï¼Œå°±ç”¨ 3 è€Œä¸æ˜¯ 2ã€‚é€šè¿‡[[https://www.intmath.com/cg5/katex-mathjax-comparison.php][å¯¹æ¯”]]æˆ‘ä»¬å‘ç°å®ƒä¼¼ä¹å¿«äº† 5 å€ï¼Œè€Œä¸”å®ƒä½¿ç”¨å•
ä¸ªæ–‡ä»¶è€Œä¸æ˜¯å¤šä¸ªæ–‡ä»¶ï¼Œå°±æ˜¯æœ‰ç‚¹å¤§è€Œå·²ã€‚å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œè¿™å¯ä»¥é€šè¿‡æ·»åŠ  ~async~ å±æ€§
æ¥å»¶è¿ŸåŠ è½½æ¥ç¼“è§£ã€‚

\(D(N) = D(i) + D(N - i - 1) + \frac{1}{N}.\)

\[D(N) = \frac{2}{N}[\sum_{j=0}^{N-1}{D(j)}] + N - 1.\]

#+begin_src emacs-lisp
(setcdr (assoc 'path org-html-mathjax-options)
        (list "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"))

(setq! org-html-mathjax-template
      "<script>
window.MathJax = {
  loader: {
    load: ['[tex]/ams', '[tex]/upgreek', '[tex]/mathtools'],
  },
  tex: {
    ams: {
      multlineWidth: '%MULTLINEWIDTH'
    },
    tags: '%TAGS',
    tagSide: '%TAGSIDE',
    tagIndent: '%TAGINDENT',
    packages: {'[+]': ['ams', 'upgreek', 'mathtools']},
    mathtools: {
      pairedDelimiters: {
        abs: ['\\\\lvert', '\\\\rvert'],
        norm: ['\\\\lVert', '\\\\rVert'],
        ceil: ['\\\\lceil', '\\\\rceil'],
        floor: ['\\\\lfloor', '\\\\rfloor'],
        round: ['\\\\lfloor', '\\\\rceil'],
      }
    }
  },
  chtml: {
    scale: %SCALE,
    displayAlign: '%ALIGN',
    displayIndent: '%INDENT'
  },
  svg: {
    scale: %SCALE,
    displayAlign: '%ALIGN',
    displayIndent: '%INDENT'
  },
  output: {
    font: '%FONT',
    displayOverflow: '%OVERFLOW'
  }
};
</script>
<script id=\"MathJax-script\" async
        src=\"%PATH\"></script>")
#+end_src

*** LaTeX å¯¼å‡º
:properties:
:CUSTOM_ID: org_export_latex
:header-args:emacs-lisp: :tangle no :noweb-ref ox-latex-conf
:end:

#+begin_src emacs-lisp :noweb no-export :noweb-ref org-export-conf :tangle no
(defvar org-latex-maths-preamble
  "
<<latex-maths-conveniences>>
"
  "Preamble that sets up a bunch of mathematical conveniences.")
(defvar org-latex-caption-preamble
  "
<<org-latex-caption-preamble>>
"
  "Preamble that improves captions.")
(defvar org-latex-checkbox-preamble
  "
<<org-latex-checkbox-preamble>>
"
  "Preamble that improves checkboxes.")
(defvar org-latex-box-preamble
  "
<<org-latex-box-preamble>>
"
  "Preamble that provides a macro for custom boxes.")
(defvar org-latex-use-microtype nil
  "Use the microtype pakage.")
(defvar org-latex-italic-quotes t
  "Make \"quote\" environments italic.")
(defvar org-latex-par-sep t
  "Vertically seperate paragraphs, and remove indentation.")
(defvar org-export-latex--preamble-info nil)
(defvar org-latex-conditional-features nil
  "Org feature tests and associated LaTeX feature flags.

Alist where the car is a test for the presense of the feature,
and the cdr is either a single feature symbol or list of feature symbols.

When a string, it is used as a regex search in the buffer.
The feature is registered as present when there is a match.

The car can also be a
- symbol, the value of which is fetched
- function, which is called with info as an argument
- list, which is `eval'uated

If the symbol, function, or list produces a string: that is used as a regex
search in the buffer. Otherwise any non-nil return value will indicate the
existance of the feature.")
(defvar org-latex-feature-implementations nil
  "LaTeX features and details required to implement them.

List where the car is the feature symbol, and the rest forms a plist with the
following keys:
- :snippet, which may be either
  - a string which should be included in the preamble
  - a symbol, the value of which is included in the preamble
  - a function, which is evaluated with the list of feature flags as its
    single argument. The result of which is included in the preamble
  - a list, which is passed to `eval', with a list of feature flags available
    as \"features\"

- :requires, a feature or list of features that must be available
- :when, a feature or list of features that when all available should cause this
    to be automatically enabled.
- :prevents, a feature or list of features that should be masked
- :order, for when ordering is important. Lower values appear first.
    The default is 0.
- :eager, when non-nil the feature will be eagerly loaded, i.e. without being detected.")

(after! ox-latex
  <<ox-latex-conf>>
  )
#+end_src

**** ç¼–è¯‘

é»˜è®¤æƒ…å†µä¸‹ï¼ŒOrg ä½¿ç”¨ =pdflatex= \times 3 + =bibtex=â€‹ã€‚ è¿™åœ¨ç°ä»£ä¸–ç•Œæ ¹æœ¬è¡Œä¸é€šã€‚
=latexmk= + =biber= (è‡ªåŠ¨ä¸ =latexmk= ä¸€èµ·ä½¿ç”¨) æ˜¯ä¸€ä¸ªç®€å•ä¸”ä¼˜è¶Šç»„åˆã€‚

#+begin_src emacs-lisp
;; org-latex-compilers = ("pdflatex" "xelatex" "lualatex"), which are the possible values for %latex
(setq! org-latex-pdf-process '("LC_ALL=en_US.UTF-8 latexmk -f -pdf -%latex --shell-escape --interaction=nonstopmode --output-directory=%o %f")
       org-latex-logfiles-extensions (append org-latex-logfiles-extensions
                                             '("acn" "acr" "alg" "bbl" "blg" "glg" "ist" "listing" "fdb_latexmk") nil))
#+end_src

è™½ç„¶ä¸Šé¢çš„ ~-%latex~ æœ‰ç‚¹ hacky (~-pdflatex~ æœŸæœ›è¢«èµ‹äºˆä¸€ä¸ªå€¼)ï¼Œä½†å®ƒå…è®¸æˆ‘ä»¬ä¿æŒ
~org-latex-compilers~ ä¸å˜ã€‚å¦‚æœæˆ‘æ‰“å¼€ä¸€ä¸ªä½¿ç”¨ =#+LATEX_COMPILER= çš„ org æ–‡ä»¶ï¼Œ
è¿™å¾ˆå¥½ï¼Œå®ƒåº”è¯¥ä»ç„¶å¯ä»¥å·¥ä½œã€‚

**** å¤é€‰æ¡†

æˆ‘ä»¬å¯ä»¥å‡è®¾åœ¨åºè¨€éƒ¨åˆ†ï¼Œå®šä¹‰äº†ä¸‹é¢çš„å„ç§è‡ªå®šä¹‰ =\checkbox...= å‘½ä»¤ã€‚

#+begin_src emacs-lisp
(defun +org-export-latex-fancy-item-checkboxes (text backend info)
  (when (org-export-derived-backend-p backend 'latex)
    (replace-regexp-in-string
     "\\\\item\\[{$\\\\\\(\\w+\\)$}\\]"
     (lambda (fullmatch)
       (concat "\\\\item[" (pcase (substring fullmatch 9 -3) ; content of capture group
                             ("square"   "\\\\checkboxUnchecked")
                             ("boxminus" "\\\\checkboxTransitive")
                             ("boxtimes" "\\\\checkboxChecked")
                             (_ (substring fullmatch 9 -3))) "]"))
     text)))
(add-to-list 'org-export-filter-item-functions
             '+org-export-latex-fancy-item-checkboxes)
#+end_src

**** ç±»æ¨¡æ¿

é¡µè¾¹ç©ºç™½å¤„çš„èŠ‚å·ï¼Œè¿™å¯ä»¥ç”¨ä¸‹é¢çš„ LaTeX æ¥å®Œæˆã€‚

#+name: latex-hanging-secnum
#+begin_src LaTeX
\\renewcommand\\sectionformat{\\llap{\\thesection\\autodot\\enskip}}
\\renewcommand\\subsectionformat{\\llap{\\thesubsection\\autodot\\enskip}}
\\renewcommand\\subsubsectionformat{\\llap{\\thesubsubsection\\autodot\\enskip}}
\\makeatletter
\\g@addto@macro\\tableofcontents{\\clearpage\\setcounter{page}{1}\\pagenumbering{arabic}}
\\makeatother
\\setcounter{page}{1}
\\pagenumbering{Roman}
#+end_src

è¶…å¤§çš„ ~\chapter~â€‹ã€‚

#+name: latex-big-chapter
#+begin_src LaTeX
\\RedeclareSectionCommand[afterindent=false, beforeskip=0pt, afterskip=0pt, innerskip=0pt]{chapter}
\\setkomafont{chapter}{\\normalfont\\Huge}
\\renewcommand*{\\chapterheadstartvskip}{\\vspace*{0\\baselineskip}}
\\renewcommand*{\\chapterheadendvskip}{\\vspace*{0\\baselineskip}}
\\renewcommand*{\\chapterformat}{%
  \\fontsize{60}{30}\\selectfont\\rlap{\\hspace{6pt}\\thechapter}}
\\renewcommand*\\chapterlinesformat[3]{%
  \\parbox[b]{\\dimexpr\\textwidth-0.5em\\relax}{%
    \\raggedleft{{\\large\\scshape\\bfseries\\chapapp}\\vspace{-0.5ex}\\par\\Huge#3}}%
    \\hfill\\makebox[0pt][l]{#2}}
#+end_src

ç°åœ¨åœ¨ Org LaTeX ç±»ä¸­æ·»åŠ ä¸€äº› =KOMA-Script=â€‹ã€‚

#+begin_src emacs-lisp :noweb-ref ox-latex-conf :noweb no-export
(let* ((article-sections '(("\\section{%s}" . "\\section*{%s}")
                           ("\\subsection{%s}" . "\\subsection*{%s}")
                           ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                           ("\\paragraph{%s}" . "\\paragraph*{%s}")
                           ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
       (book-sections (append '(("\\chapter{%s}" . "\\chapter*{%s}"))
                              article-sections))
       (hanging-secnum-preamble "
<<latex-hanging-secnum>>
")
       (big-chap-preamble "
<<latex-big-chapter>>
"))
  (setcdr (assoc "article" org-latex-classes)
          `(,(concat "\\documentclass{scrartcl}" hanging-secnum-preamble)
            ,@article-sections))
  (add-to-list 'org-latex-classes
               `("report" ,(concat "\\documentclass{scrartcl}" hanging-secnum-preamble)
                 ,@article-sections))
  (add-to-list 'org-latex-classes
               `("book" ,(concat "\\documentclass[twoside=false]{scrbook}"
                                 big-chap-preamble hanging-secnum-preamble)
                 ,@book-sections))
  (add-to-list 'org-latex-classes
               `("blank" "[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"
                 ,@article-sections))
  (add-to-list 'org-latex-classes
               `("bmc-article" "\\documentclass[article,code,maths]{bmc}\n[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"
                 ,@article-sections))
  (add-to-list 'org-latex-classes
               `("bmc" "\\documentclass[code,maths]{bmc}\n[NO-DEFAULT-PACKAGES]\n[NO-PACKAGES]\n[EXTRA]"
                 ,@book-sections)))

(setq! org-latex-tables-booktabs t
       org-latex-hyperref-template "
<<latex-fancy-hyperref>>
"
       org-latex-reference-command "\\cref{%s}")
#+end_src

ç„¶è€Œ =hyperref= è®¾ç½®éœ€è¦å•ç‹¬å¤„ç†ã€‚

#+name: latex-fancy-hyperref
#+begin_src LaTeX
\\providecolor{url}{HTML}{0077bb}
\\providecolor{link}{HTML}{882255}
\\providecolor{cite}{HTML}{999933}
\\hypersetup{
  pdfauthor={%a},
  pdftitle={%t},
  pdfkeywords={%k},
  pdfsubject={%d},
  pdfcreator={%c},
  pdflang={%L},
  breaklinks=true,
  colorlinks=true,
  linkcolor=link,
  urlcolor=url,
  citecolor=cite
}
\\urlstyle{same}
%% hide links styles in toc
\\NewCommandCopy{\\oldtoc}{\\tableofcontents}
\\renewcommand{\\tableofcontents}{\\begingroup\\hypersetup{hidelinks}\\oldtoc\\endgroup}
#+end_src

**** æ™ºèƒ½åºè¨€

***** åŠŸèƒ½ä¼˜åŒ–

Caption å¯ä»¥åšä¸€äº›è°ƒæ•´ï¼Œæ¯”å¦‚
+ å¯ä»¥è½»æ¾æ‹¥æœ‰å¤šä¸ª Caption
+ æŒ‡å‘å›¾çš„é“¾æ¥å¸¦åˆ°å›¾çš„é¡¶éƒ¨ (è€Œä¸æ˜¯åº•éƒ¨)
+ Caption æ ‡ç­¾å¯ä»¥ç¨å¾®åŠ ç²—ä¸€ç‚¹
+ åªæœ‰å½“è·¨è¶Šå¤šè¡Œæ—¶ï¼Œå¤šè¡Œ Caption åº”è¯¥å‘å³ä¸€ç‚¹

#+name: org-latex-caption-preamble
#+begin_src LaTeX
\\usepackage{subcaption}
\\usepackage[hypcap=true]{caption}
\\setkomafont{caption}{\\sffamily\\small}
\\setkomafont{captionlabel}{\\upshape\\bfseries}
\\captionsetup{justification=raggedright,singlelinecheck=true}
\\usepackage{capt-of} % required by Org
#+end_src

é»˜è®¤çš„å¤é€‰æ¡†å¤ªä¸‘äº†ï¼Œç”¨ä¸€äº›å¥½çœ‹çš„æ›¿ä»£å“å§ã€‚

#+name: org-latex-checkbox-preamble
#+begin_src LaTeX
\\newcommand{\\checkboxUnchecked}{$\\square$}
\\newcommand{\\checkboxTransitive}{\\rlap{\\raisebox{-0.1ex}{\\hspace{0.35ex}\\Large\\textbf -}}$\\square$}
\\newcommand{\\checkboxChecked}{\\rlap{\\raisebox{0.2ex}{\\hspace{0.35ex}\\scriptsize \\ding{52}}}$\\square$}
#+end_src

"æ¶ˆæ¯å—" æ˜¯ä¸€ä¸ªä¸é”™çš„æƒ³æ³•ï¼Œå°±åƒ info/warning/error/successã€‚LaTeX ä¸­çš„å®å¯
ä»¥åˆ›å»ºå®ƒä»¬ã€‚

#+name: org-latex-box-preamble
#+begin_src LaTeX
\\ExplSyntaxOn
\\NewCoffin\\SBXBaseline
\\NewCoffin\\SBXHeader
\\NewCoffin\\SBXContent
\\NewCoffin\\SBXSideRule
\\newbox\\SBXSplitBox
\\cs_new_protected:Nn \\simplebox_start:nnn {
  % #1 ding, #3 name, #4 label
  \\vcoffin_set:Nnn \\SBXHeader { \\linewidth - 1em } {
  \\noindent\\textcolor{#2}{#1}~\\textcolor{#2}{\\textbf{#3}}}
  \\vcoffin_set:Nnw \\SBXContent { \\linewidth - 1.5em }
}
\\cs_new_protected:Nn \\simplebox_split_content:n {
  % #1 name
  \\setbox\\SBXSplitBox = \\vbox:n { \\vbox_unpack_drop:N \\SBXContent }
  \\dim_set:Nn \\l_tmpa_dim { \\dim_eval:n { \\dim_min:nn { \\pagegoal } { \\textheight } - \\pagetotal - 2\\baselineskip } }
  \\setbox0 = \\vsplit\\SBXSplitBox to \\l_tmpa_dim
  \\vcoffin_set:Nnn \\SBXContent { \\CoffinWidth \\SBXContent } { \\box0 %
    \\vspace{-1.7\\baselineskip}
    \\noindent\\textcolor{#1}{\\textbf{\\ldots }}
    \\vspace*{-0.3\\baselineskip}}
}
\\cs_new_protected:Nn \\simplebox_split_refill:nnnn {
  % #1 ding, #2 ding offset, #3 name, #4 label
  \\simplebox_start:nnn {#1} {#3} {#4,\\space{}\\emph{continued}}
  \\vspace*{-0.2\\baselineskip}
  \\vbox_unpack_drop:N \\SBXSplitBox
  \\vcoffin_set_end:
}
\\cs_new_protected:Nn \\simplebox_typeset:nn {
    % #1 name, #2 ding offset
    \\vcoffin_set:Nnn \\SBXBaseline {0pt} {\\vbox{}}
    \\SetHorizontalCoffin\\SBXSideRule{\\color{#1}\\rule{1pt}{\\dim_eval:n { \\CoffinTotalHeight\\SBXContent + \\baselineskip }}}
    \\JoinCoffins*\\SBXContent[l,t]\\SBXSideRule[l,t](\\dim_eval:n {#2 - 1em}, \\dim_eval:n{\\baselineskip - 0.5em})
    \\JoinCoffins*\\SBXContent[l,t]\\SBXHeader[l,B](-1em, 0.5\\baselineskip)
    \\JoinCoffins*\\SBXBaseline[l,T]\\SBXContent[l,T]
    \\vspace{-0.5\\baselineskip}
    \\noindent\\TypesetCoffin\\SBXBaseline(\\dim_eval:n { 1em - #2 + 1pt }, 0pt)
    \\vspace*{\\CoffinTotalHeight\\SBXContent}
    \\vspace{-0.08em} % Why on earth is this needed for baseline alignment!?
}
\\cs_new_protected:Nn \\simplebox_typeset_breakable:nnnn {
    % #1 ding, #2 ding offset, #3 name, #4 label
    \\dim_set:Nn \\l_tmpa_dim {\\dim_eval:n { \\CoffinTotalHeight\\SBXContent + \\baselineskip }}
    \\dim_set:Nn \\l_tmpb_dim { \\dim_eval:n { \\dim_min:nn { \\pagegoal } { \\textheight } - \\pagetotal - \\baselineskip } }
    \\dim_compare:nNnTF {\\l_tmpa_dim} > {\\l_tmpb_dim} {
      \\simplebox_split_content:n {#3}
      \\simplebox_typeset:nn {#3} {#2}
      \\newpage
      \\simplebox_split_refill:nnnn {#1} {#2} {#3} {#4}
      \\simplebox_typeset_breakable:nnnn {#1} {#2} {#3} {#4}
    }{
      \\simplebox_typeset:nn {#3} {#2}
    }
}

\\NewDocumentCommand{\\defsimplebox}{O{\\ding{117}} O{0.35em} O{#1} O{#2} m m m}{%
  % #1 ding, #2 ding offset, #3 alt-ding, #4 alt-ding offset,
  % #5 name, #6 colour, #7 default label
  \\definecolor{#5}{HTML}{#6}
  \\NewDocumentEnvironment{#5}{ O{#7} }{
    \\simplebox_start:nnn {#1} {#5} {##1}
  }{
    \\vcoffin_set_end:
    \\simplebox_typeset_breakable:nnnn {#3} {#4} {#5} {##1}
  }
}
\\ExplSyntaxOff
#+end_src

***** å†…å®¹-ç‰¹å¾-åºè¨€å…³è”

æ¯ä¸ªæ£€æµ‹åˆ°çš„ç‰¹å¾éƒ½ä¼šç»™å‡ºä¸€ä¸ªæ‰€éœ€çš„ã€Œç‰¹å¾æ ‡å¿—ã€åˆ—è¡¨ã€‚åªéœ€åˆå¹¶åŠŸèƒ½æ ‡å¿—åˆ—è¡¨ï¼Œä¸å†éœ€
è¦é¿å… LaTeX çš„é‡å¤ã€‚ç„¶åé¢å¤–çš„å±‚åœ¨ç‰¹å¾æ ‡å¿—å’Œå¯ç”¨äºå®ç°è¯¥ç‰¹å¾çš„è§„èŒƒä¹‹é—´å½¢æˆåŒå°„ã€‚

#+begin_src dot :file misc/org-latex-clever-preamble.svg :exports none
digraph {
    graph [bgcolor="transparent"];
    node  [shape="underline" penwidth="2" width="1.3" style="rounded,filled" fillcolor="#efefef" color="#c9c9c9" fontcolor="#000000" fontname="overpass"];
    edge  [color="#aaaaaa" penwidth="1.2"]
    rankdir=LR

    node[group=a,color="#2ec27e"]
    "file:*.svg"
    "file:*.jpeg"
    "file:*.png"
    "#+caption"
    "xkcd:*"
    node[group=b,color="#f5c211"]
    "svg"
    "image"
    "caption"
    node[group=c,color="#813d9c"]
    "(TeX) svg"
    "(TeX) graphicx"
    "(TeX) caption"

    "file:*.svg" -> "svg" -> "(TeX) svg"
    "file:*.jpeg" -> "image" -> "(TeX) graphicx"
    "file:*.png" -> "image"
    "(TeX) svg":s -> "(TeX) graphicx":n [constraint=false]
    "#+caption" -> "caption" -> "(TeX) caption"
    "xkcd:*" -> "image"
    "xkcd:*" -> "caption"
}
#+end_src

# #+caption: Org åŠŸèƒ½ã€åŠŸèƒ½æ ‡å¿—å’Œ LaTeX ç‰‡æ®µä¹‹é—´çš„å…³è”
# #+attr_html: :class invertible :alt DAG showing how Org features flow through to LaTeX :style max-width:min(24em,100%)
# #+attr_latex: :width 0.6\linewidth
# [[file:misc/org-latex-clever-preamble.svg]]

é¦–å…ˆï¼Œæˆ‘ä»¬å°†å®ç°è¯¥æ¨¡å‹çš„ç‰¹å¾æ£€æµ‹ç»„ä»¶ã€‚æˆ‘å¸Œæœ›å®ƒèƒ½å¤Ÿä½¿ç”¨å°½å¯èƒ½å¤šçš„çŠ¶æ€ä¿¡æ¯ï¼Œå› æ­¤åŠŸ
èƒ½æµ‹è¯•åº”è¯¥éå¸¸é€šç”¨ã€‚

#+begin_src emacs-lisp
(setq! org-latex-conditional-features
       '(("\\[\\[\\(?:file\\|https?\\):\\(?:[^]]\\|\\\\\\]\\)+?\\.\\(?:eps\\|pdf\\|png\\|jpeg\\|jpg\\|jbig2\\)\\]\\]\\|\\\\includegraphics[\\[{]" . image)
         ("\\[\\[\\(?:file\\|https?\\):\\(?:[^]]+?\\|\\\\\\]\\)\\.svg\\]\\]\\|\\\\includesvg[\\[{]" . svg)
         ("\\\\(\\|\\\\\\[\\|\\\\begin{\\(?:math\\|displaymath\\|equation\\|align\\|flalign\\|multiline\\|gather\\)[a-z]*\\*?}" . maths)
         ("^[ \t]*|" . table)
         ("cref:\\|\\cref{" . cleveref)
         ("[;\\\\]?\\b[A-Z][A-Z]+s?[^A-Za-z]" . acronym)
         ("\\+[^ ].*[^ ]\\+\\|_[^ ].*[^ ]_\\|\\\\uu?line\\|\\\\uwave\\|\\\\sout\\|\\\\xout\\|\\\\dashuline\\|\\dotuline\\|\\markoverwith" . underline)
         (":float wrap" . float-wrap)
         (":float sideways" . rotate)
         (org-latex-use-microtype . microtype)
         ("[\u2500-\u259F]" . box-drawing)
         ("^[ \t]*#\\+caption:\\|\\\\caption" . caption)
         ((and org-latex-italic-quotes "^[ \t]*#\\+begin_quote\\|\\\\begin{quote}") . italic-quotes)
         (org-latex-par-sep . par-sep)
         ("^[ \t]*\\(?:[-+*]\\|[0-9]+[.)]\\|[A-Za-z]+[.)]\\) \\[[ -X]\\]" . checkbox)
         ("^[ \t]*#\\+begin_warning\\|\\\\begin{warning}" . box-warning)
         ("^[ \t]*#\\+begin_info\\|\\\\begin{info}"       . box-info)
         ("^[ \t]*#\\+begin_notes\\|\\\\begin{notes}"     . box-notes)
         ("^[ \t]*#\\+begin_success\\|\\\\begin{success}" . box-success)
         ("^[ \t]*#\\+begin_error\\|\\\\begin{error}"     . box-error)))
#+end_src

ç„¶åæˆ‘ä»¬æä¾›ä¸€ç§æ–¹æ³•æ¥ç”Ÿæˆæä¾›è¿™äº›åŠŸèƒ½çš„åºè¨€ã€‚é™¤äº†
~org-latex-conditional-features~ ä¸­å‘½åçš„ç‰¹æ€§ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å°†åˆ›å»ºå…ƒç‰¹æ€§ï¼Œè¿™äº›
ç‰¹æ€§å¯èƒ½æ˜¯å…¶ä»–ç‰¹æ€§æ‰€éœ€è¦çš„ (=:requires=)ï¼Œæˆ–è€…é»˜è®¤æƒ…å†µä¸‹æ˜¯å¯ç”¨çš„
(=:eager t=)ã€‚ä¸ºäº†è¿›ä¸€æ­¥æ§åˆ¶ï¼Œæˆ‘åªèƒ½åœ¨æŸäº›å…¶ä»–åŠŸèƒ½å¤„äºå¯ç”¨çŠ¶æ€ (=:when=) å¹¶è¢«
å…¶ä»–åŠŸèƒ½å±è”½ (=:prevents=) æ—¶ä½¿ç”¨æŸäº›åŠŸèƒ½ã€‚æˆ‘å°†ä½¿ç”¨ä»¥ =.= å¼€å¤´çš„å…ƒåŠŸèƒ½çš„çº¦å®š
ï¼Œä»¥åŠä»¥ =!= å¼€å¤´çš„ =:eager= åŠŸèƒ½ï¼Œä½¿å®ƒä»¬çš„æ€§è´¨æ›´æ˜æ˜¾ã€‚

LaTeX ä¸­çš„å¦ä¸€ä¸ªè€ƒè™‘å› ç´ æ˜¯åŠ è½½é¡ºåºï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹å¾ˆé‡è¦ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæœ‰æŸç§åˆç†çš„
æ’åºæ˜¯å¾ˆå¥½çš„ã€‚ä¸ºæ­¤æˆ‘å°†ä»‹ç»ä¸€ä¸ª =:order= å…³é”®å­—ã€‚ä½¿ç”¨å®ƒå°†æŒ‰å¦‚ä¸‹æ–¹å¼æ’åˆ—ç‰‡æ®µã€‚

+ =0= æ’ç‰ˆ
  - =0= å­—ä½“æœ¬èº«
  # - =0.1= æ’ç‰ˆè°ƒæ•´ (=microtype=)
  - =0.2= æ•°å­¦è®¾ç½®
  - =0.3= æ•°å­¦å­—ä½“
  - =0.4= é¢å¤–çš„æ–‡å­—æ•´å½¢ (~\acr~)
  - =0.5-0.9= å…¶ä»–æ–‡æœ¬ä¿®æ”¹ï¼Œå°è¯•å°†è¾ƒçŸ­çš„ç‰‡æ®µæ”¾åœ¨é¦–ä½
+ =1= (/default/)
+ =2= è¡¨å’Œå›¾
+ =3= å…¶ä»–çŸ­å†…å®¹
+ =4= å„ç§ boxes

#+begin_src emacs-lisp
(setq! org-latex-feature-implementations
       '((image         :snippet "\\usepackage{graphicx}" :order 2)
         (svg           :snippet "\\usepackage[inkscapelatex=false]{svg}" :order 2)
         (maths         :snippet org-latex-maths-preamble :order 0.2)
         (table         :snippet "\\usepackage{longtable}\n\\usepackage{booktabs}" :order 2)
         (cleveref      :snippet "\\usepackage{biber}\n\\usepackage[capitalize]{cleveref}
\\makeatletter
\\newcommand*{\\@setcpagerefrange}[3]{%
  \\@@setcpagerefrange{#1}{#2}{cref}{#3}}
\\newcommand*{\\@setCpagerefrange}[3]{%
  \\@@setcpagerefrange{#1}{#2}{Cref}{#3}}
\\newcommand*{\\@setlabelcpagerefrange}[3]{%
  \\@@setcpagerefrange{#1}{#2}{labelcref}{#3}}
\\makeatother"
                        :order 1) ; after bmc-maths
         (underline     :snippet "\\usepackage[normalem]{ulem}" :order 0.5)
         (float-wrap    :snippet "\\usepackage{wrapfig}" :order 2)
         (rotate        :snippet "\\usepackage{rotating}" :order 2)
         (caption       :snippet org-latex-caption-preamble :order 2.1)
         (microtype     :snippet "\\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=2000]{microtype}"
                        :order 0.1)
         (acronym       :snippet "\\newcommand{\\acr}[1]{\\protect\\textls*[110]{\\scshape #1}}\n\\newcommand{\\acrs}{\\protect\\scalebox{.91}[.84]{\\hspace{0.15ex}s}}"
                        :order 0.4)
         (box-drawing   :snippet "\\usepackage{pmboxdraw}" :order 0.05)
         (italic-quotes :snippet "\\renewcommand{\\quote}{\\list{}{\\rightmargin\\leftmargin}\\item\\relax\\em}\n"
                        :order 0.5)
         (par-sep       :snippet "\\setlength{\\parskip}{\\baselineskip}\n\\setlength{\\parindent}{0pt}"
                        :order 0.5)
         (.pifont       :snippet "\\usepackage{pifont}")
         (.xcoffins     :snippet "\\usepackage{xcoffins}")
         (checkbox      :requires .pifont
                        :order 3
                        :snippet (concat (unless (memq 'maths features)
                                           "\\usepackage{amssymb} % provides \\square")
                                         org-latex-checkbox-preamble))
         (.fancy-box    :requires (.pifont .xcoffins) :snippet org-latex-box-preamble :order 3.9)
         (box-warning   :requires .fancy-box
                        :snippet "\\defsimplebox{warning}{e66100}{Warning}"
                        :order 4)
         (box-info      :requires .fancy-box
                        :snippet "\\defsimplebox{info}{3584e4}{Information}"
                        :order 4)
         (box-notes     :requires .fancy-box
                        :snippet "\\defsimplebox{notes}{26a269}{Notes}"
                        :order 4)
         (box-success  :requires .fancy-box
                       :snippet "\\defsimplebox{success}{26a269}{\\vspace{-\\baselineskip}}"
                       :order 4)
         (box-error     :requires .fancy-box
                        :snippet "\\defsimplebox{error}{c01c28}{Important}"
                        :order 4)))
#+end_src

***** æ— æ¡ä»¶æ·»åŠ çš„åŒ…

#+begin_src emacs-lisp
(setq! org-latex-packages-alist
       '(("svgnames" "xcolor" t)
         ("" "tikz" t)))
#+end_src

***** ç‰¹å¾ç¡®å®š

ç°åœ¨æˆ‘ä»¬å·²ç»å®šä¹‰äº† ~org-latex-conditional-features~ ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å®ƒæ¥æå–
åœ¨ Org ç¼“å†²åŒºä¸­æ‰¾åˆ°çš„ç‰¹å¾åˆ—è¡¨ã€‚

#+begin_src emacs-lisp
(defun org-latex-detect-features (&optional buffer info)
  "List features from `org-latex-conditional-features' detected in BUFFER."
  (let ((case-fold-search nil))
    (with-current-buffer (or buffer (current-buffer))
      (delete-dups
       (mapcan (lambda (construct-feature)
                 (when (let ((out (pcase (car construct-feature)
                                    ((pred stringp) (car construct-feature))
                                    ((pred functionp) (funcall (car construct-feature) info))
                                    ((pred listp) (eval (car construct-feature)))
                                    ((pred symbolp) (symbol-value (car construct-feature)))
                                    (_ (user-error "org-latex-conditional-features key %s unable to be used" (car construct-feature))))))
                         (if (stringp out)
                             (save-excursion
                               (goto-char (point-min))
                               (re-search-forward out nil t))
                           out))
                   (if (listp (cdr construct-feature)) (cdr construct-feature) (list (cdr construct-feature)))))
               org-latex-conditional-features)))))
#+end_src

***** åºè¨€ç”Ÿæˆ

ä¸€æ—¦ç¡®å®šäº†æ‰€éœ€åŠŸèƒ½çš„åˆ—è¡¨ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ ~org-latex-feature-implementations~
æ¥ç”Ÿæˆ LaTeXï¼Œè¯¥ LaTeX åº”è¯¥æ’å…¥åˆ°åºè¨€ä¸­ä»¥æä¾›è¿™äº›åŠŸèƒ½ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è¦åœ¨ ~org-latex-feature-implementations~ ä¸­å¤„ç†æˆ‘ä»¬çš„å…³é”®å­—ï¼Œä»¥
ç”Ÿæˆæ‰©å±•çš„åŠŸèƒ½åˆ—è¡¨ã€‚æˆ‘ä»¬å°†é€šè¿‡æ‰§è¡Œä»¥ä¸‹æ­¥éª¤æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

+ æ¯ä¸ªåˆ—å‡ºçš„åŠŸèƒ½çš„ä¾èµ–é¡¹éƒ½æ·»åŠ åˆ°åŠŸèƒ½åˆ—è¡¨ (src_elisp{:requires}) ä¸­ã€‚
+ æ¯ä¸ªç‰¹æ€§çš„ src_elisp{:when} æ¡ä»¶ï¼Œä»¥åŠå¸¦æœ‰ src_elisp{:eager t} çš„å¯ç”¨ç‰¹
  æ€§ï¼Œéƒ½ä¼šè¢«è¯„ä¼°ï¼Œå¹¶ç›¸åº”åœ°æ·»åŠ  / åˆ é™¤
+ src_elisp{:prevents} å€¼ä¸­å­˜åœ¨çš„ä»»ä½•ç‰¹æ€§éƒ½å°†è¢«åˆ é™¤
+ åŠŸèƒ½åˆ—è¡¨æ¸…é™¤é‡å¤é¡¹
+ ç‰¹å¾åˆ—è¡¨æŒ‰ src_elisp{:order} (å‡åº) æ’åº


#+begin_src emacs-lisp
(defun org-latex-expand-features (features)
  "For each feature in FEATURES process :requires, :when, and :prevents keywords and sort according to :order."
  (dolist (feature features)
    (unless (assoc feature org-latex-feature-implementations)
      (message "Feature %s not provided in org-latex-feature-implementations, ignoring." feature)
      (setq features (remove feature features))))
  (setq current features)
  (while current
    (when-let ((requirements (plist-get (cdr (assq (car current) org-latex-feature-implementations)) :requires)))
      (setcdr current (if (listp requirements)
                          (append requirements (cdr current))
                        (cons requirements (cdr current)))))
    (setq current (cdr current)))
  (dolist (potential-feature
           (append features (delq nil (mapcar (lambda (feat)
                                                (when (plist-get (cdr feat) :eager)
                                                  (car feat)))
                                              org-latex-feature-implementations))))
    (when-let ((prerequisites (plist-get (cdr (assoc potential-feature org-latex-feature-implementations)) :when)))
      (setf features (if (if (listp prerequisites)
                             (cl-every (lambda (preq) (memq preq features)) prerequisites)
                           (memq prerequisites features))
                         (append (list potential-feature) features)
                       (delq potential-feature features)))))
  (dolist (feature features)
    (when-let ((prevents (plist-get (cdr (assoc feature org-latex-feature-implementations)) :prevents)))
      (setf features (cl-set-difference features (if (listp prevents) prevents (list prevents))))))
  (sort (delete-dups features)
        (lambda (feat1 feat2)
          (if (< (or (plist-get (cdr (assoc feat1 org-latex-feature-implementations)) :order) 1)
                 (or (plist-get (cdr (assoc feat2 org-latex-feature-implementations)) :order) 1))
              t nil))))
#+end_src

ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ˆå¥½çš„æœ€ç»ˆè¦ä½¿ç”¨çš„ç‰¹æ€§åˆ—è¡¨ï¼Œå¯ä»¥æå–å®ƒä»¬çš„ç‰‡æ®µå¹¶å°†ç»“æœè¿æ¥åœ¨ä¸€èµ·ã€‚

#+begin_src emacs-lisp
(defun org-latex-generate-features-preamble (features)
  "Generate the LaTeX preamble content required to provide FEATURES.
This is done according to `org-latex-feature-implementations'"
  (let ((expanded-features (org-latex-expand-features features)))
    (concat
     (format "\n%% features: %s\n" expanded-features)
     (mapconcat (lambda (feature)
                  (when-let ((snippet (plist-get (cdr (assoc feature org-latex-feature-implementations)) :snippet)))
                    (concat
                     (pcase snippet
                       ((pred stringp) snippet)
                       ((pred functionp) (funcall snippet features))
                       ((pred listp) (eval `(let ((features ',features)) (,@snippet))))
                       ((pred symbolp) (symbol-value snippet))
                       (_ (user-error "org-latex-feature-implementations :snippet value %s unable to be used" snippet)))
                     "\n")))
                expanded-features
                "")
     "% end features\n")))
#+end_src

ç„¶åéœ€è¦å»ºè®® Org å®é™…ä½¿ç”¨è¿™ä¸ªç”Ÿæˆçš„å‰å¯¼å†…å®¹ã€‚
#+begin_src emacs-lisp
(defadvice! org-latex-save-info (info &optional t_ s_)
  :before #'org-latex-make-preamble
  (setq org-export-latex--preamble-info info))

(defadvice! org-splice-latex-header-and-generated-preamble-a (orig-fn tpl def-pkg pkg snippets-p &optional extra)
  "Dynamically insert preamble content based on `org-latex-conditional-preambles'."
  :around #'org-splice-latex-header
  (let ((header (funcall orig-fn tpl def-pkg pkg snippets-p extra)))
    (if snippets-p header
      (concat header
              (org-latex-generate-features-preamble (org-latex-detect-features nil org-export-latex--preamble-info))
              "\n"))))
#+end_src

æˆ‘å¯¹ ~org-export-latex--preamble-info~ çš„ä½¿ç”¨æœ‰ç‚¹è€å¥—ã€‚ å½“æˆ‘å°è¯•å°†å…¶ä¸Šæ¸¸åŒ–æ—¶ï¼Œè¿™åº”
è¯¥ä¼šå˜å¾—æ›´åŠ æ¸…æ™°ï¼Œå› ä¸ºæˆ‘å¯ä»¥é€šè¿‡ç›´æ¥ä¿®æ”¹ ~org-latex-make-preamble~ æ¥ä¼ é€’ä¿¡æ¯ã€‚

**** æ•°å­¦å£°æ˜
:PROPERTIES:
:header-args:LaTeX: :noweb-ref latex-maths-conveniences :tangle no
:END:

æ•°å­¦æ€»æ˜¯å±‚å‡ºä¸ç©·ã€‚æˆ‘æƒ³è¿™æ—¢è¯´æ˜äº†æˆ‘å’Œè¿™é—¨å­¦ç§‘æœ¬èº«ã€‚è™½ç„¶ LaTeX çš„å‘½ä»¤é›†ç›¸å½“åˆç†ï¼Œ
ä½†æˆ‘ä»¬å¯ä»¥è®©ä¸€äº›å¸¸ç”¨çš„ç¬¦å·æ›´æ–¹ä¾¿ä¸€äº›ã€‚

***** å®åŒ…

é¦–å…ˆæˆ‘ä»¬éœ€è¦éå¸¸å¸¸ç”¨çš„åŒ…ã€‚

#+begin_src LaTeX
%% Maths-related packages
% More maths environments, commands, and symbols.
\\usepackage{amsmath, amssymb}
% Slanted fractions with \sfrac{a}{b}, in text and maths.
\\usepackage{xfrac}
% Visually cancel expressions with \cancel{value} and \cancelto{expression}{value}
\\usepackage[makeroom]{cancel}
% Improvements on amsmath and utilities for mathematical typesetting
\\usepackage{mathtools}
\\usepackage{upgreek,extarrows}
#+end_src

***** è‡ªå®šä¹‰åˆ†éš”ç¬¦

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å°†å„ç§ç±»å‹çš„å››èˆäº”å…¥å’Œç»å¯¹å€¼åˆ†éš”ç¬¦ä½œä¸ºå‘½ä»¤è®¿é—®ã€‚

#+begin_src LaTeX
% Deliminators
\\DeclarePairedDelimiter{\\abs}{\\lvert}{\\rvert}
\\DeclarePairedDelimiter{\\norm}{\\lVert}{\\rVert}

\\DeclarePairedDelimiter{\\ceil}{\\lceil}{\\rceil}
\\DeclarePairedDelimiter{\\floor}{\\lfloor}{\\rfloor}
\\DeclarePairedDelimiter{\\round}{\\lfloor}{\\rceil}
#+end_src

***** æ•°å­—é›†åˆ

ç„¶åï¼Œæˆ‘ä»¬æœ‰å„ç§å¸¸è§çš„æ•°å­—é›†ï¼Œå¦‚æœèƒ½æœ‰ä¸€ç§æ–¹ä¾¿çš„æ–¹æ³•æ¥é”®å…¥å®ƒä»¬å¹¶é€‰æ‹©æ€§åœ°èµ‹äºˆå®ƒä»¬
å¹‚ï¼Œé‚£å°±æ›´å¥½äº†ã€‚è¦åŒæ—¶æ”¯æŒ =\XX= å’Œ =\XX[n]= æ˜¯ç›¸å½“å®¹æ˜“çš„ã€‚

#+begin_src LaTeX
\\newcommand{\\RR}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{R}}{\\mathbb{R}^{#1}}}} % Real numbers
\\newcommand{\\NN}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{N}}{\\mathbb{N}^{#1}}}} % Natural numbers
\\newcommand{\\ZZ}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{Z}}{\\mathbb{Z}^{#1}}}} % Integer numbers
\\newcommand{\\QQ}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{Q}}{\\mathbb{Q}^{#1}}}} % Rational numbers
\\newcommand{\\CC}[1][]{\\ensuremath{\\ifstrempty{#1}{\\mathbb{C}}{\\mathbb{C}^{#1}}}} % Complex numbers
#+end_src

***** å¯¼æ•°

å¯¼æ•°çš„æ’ç‰ˆå…¶å®å¾ˆéº»çƒ¦ï¼Œå¦‚æœèƒ½æœ‰ä¸€ä¸ªæ”¯æŒ =\dv= çš„å‘½ä»¤å°±æ›´å¥½äº†ï¼š
+ =\dv{x}=: =x= çš„å¯¼æ•°
+ =\dv{f}{x}=: =f= ç›¸å¯¹äº =x= çš„å¯¼æ•°
+ =\dv[2]{f}{x}=: =f= å…³äº =x= çš„äºŒé˜¶å¯¼æ•°

åŒæ ·ï¼Œå¦‚æœèƒ½æœ‰ä¸€ä¸ªéƒ¨åˆ†æ´¾ç”Ÿçš„å¯¹åº” =\pdv= å°±æ›´å¥½äº†ï¼Œå®ƒçš„è¡Œä¸ºæ–¹å¼ç±»ä¼¼ï¼Œä½†å¯ä»¥æä¾›å¤š
ä¸ªé€—å·åˆ†éš”çš„å˜é‡ -- ä¾‹å¦‚ =\pdv{f}{x,y,z}=.

#+begin_src LaTeX
% Easy derivatives
\\ProvideDocumentCommand\\dv{o m g}{%
  \\IfNoValueTF{#3}{%
    \\dv[#1]{}{#2}}{%
    \\IfNoValueTF{#1}{%
      \\frac{\\dd #2}{\\dd #3}%
    }{\\frac{\\dd[#1] #2}{\\dd {#3}^{#1}}}}}
% Easy partial derivatives
\\ExplSyntaxOn
\\ProvideDocumentCommand\\pdv{o m g}{%
  \\IfNoValueTF{#3}{\\pdv[#1]{}{#2}}%
  {\\ifnum\\clist_count:n{#3}<2
    \\IfValueTF{#1}{\\frac{\\partial^{#1} #2}{\\partial {#3}^{#1}}}%
    {\\frac{\\partial #2}{\\partial #3}}
    \\else
    \\frac{\\IfValueTF{#1}{\\partial^{#1}}{\\partial^{\\clist_count:n{#3}}}#2}%
    {\\clist_map_inline:nn{#3}{\\partial ##1 \\,}\\!}
    \\fi}}
\\ExplSyntaxOff
#+end_src

***** å…¬å…±è¿ç®—ç¬¦

å…¬å…±è¿ç®—ç¬¦é›†å¯ä»¥è¿›è¡Œä¸€äº›æ‰©å±•ã€‚

#+begin_src LaTeX
% Laplacian
\\DeclareMathOperator{\\Lap}{\\mathcal{L}}

% Statistics
\\DeclareMathOperator{\\Var}{Var} % varience
\\DeclareMathOperator{\\Cov}{Cov} % covarience
\\newcommand{\\EE}{\\ensuremath{\\mathbb{E}}} % expected value
\\DeclareMathOperator{\\E}{E} % expected value
#+end_src

***** çŸ©é˜µåˆ—å¯¹é½

é»˜è®¤æƒ…å†µä¸‹ï¼ŒçŸ©é˜µä¸­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯å±…ä¸­æ’åˆ—çš„ï¼Œä½†æˆ‘å‘ç°è¿™å¾€å¾€å¹¶ä¸å¯å–ã€‚å¦‚æœèƒ½å°†å¯¹é½
æ–¹å¼ä½œä¸ºç¯å¢ƒçš„ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œå¹¶é»˜è®¤ä¸ºå³å¯¹é½ï¼Œé‚£å°±æ›´å¥½äº†ã€‚

#+begin_src LaTeX
% Redefine the matrix environment to allow for alignment
% via an optional argument, and use r as the default.
\\makeatletter
\\renewcommand*\\env@matrix[1][r]{\\hskip -\\arraycolsep%
    \\let\\@ifnextchar\\new@ifnextchar
    \\array{*\\c@MaxMatrixCols #1}}
\\makeatother
#+end_src

**** å°é¢

è¦åˆ¶ä½œæ¼‚äº®çš„å°é¢ï¼Œæƒ³åˆ°çš„ä¸€ä¸ªç®€å•æ–¹æ³•å°±æ˜¯é‡æ–°å®šä¹‰ =\maketitle= ã€‚ä¸ºäº†ç²¾ç¡®æ§åˆ¶å®šä½
ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ =tikz= åŒ…ï¼Œç„¶åæ·»åŠ  Tikz åº“ =calc= å’Œ =shape.geometric= æ¥ä¸ºèƒŒ
æ™¯åšä¸€äº›æ¼‚äº®çš„è£…é¥°ã€‚

é¦–å…ˆä¸ºåºè¨€è®¾ç½®å¿…è¦çš„è¡¥å……ã€‚ è¿™å°†å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š
+ åŠ è½½æ‰€éœ€çš„åŒ…
+ é‡æ–°å®šä¹‰ =\maketitle=
+ ç”¨ Tikz ç”»ä¸€ä¸ª =Org= å›¾æ ‡ï¼Œç”¨åœ¨å°é¢ä¸Š (è¿™æ˜¯ä¸€ä¸ªå°å½©è›‹)
+ é€šè¿‡é‡æ–°å®šä¹‰ =\tableofcontents= åœ¨ç›®å½•ä¹‹åå¼€å§‹ä¸€ä¸ªæ–°é¡µé¢

#+name: latex-cover-page
#+begin_src LaTeX
\\usepackage{tikz}
\\usetikzlibrary{shapes.geometric}
\\usetikzlibrary{calc}

\\newsavebox\\orgicon
\\begin{lrbox}{\\orgicon}
  \\begin{tikzpicture}[y=0.80pt, x=0.80pt, inner sep=0pt, outer sep=0pt]
    \\path[fill=black!6] (16.15,24.00) .. controls (15.58,24.00) and (13.99,20.69) .. (12.77,18.06)arc(215.55:180.20:2.19) .. controls (12.33,19.91) and (11.27,19.09) .. (11.43,18.05) .. controls (11.36,18.09) and (10.17,17.83) .. (10.17,17.82) .. controls (9.94,18.75) and (9.37,19.44) .. (9.02,18.39) .. controls (8.32,16.72) and (8.14,15.40) .. (9.13,13.80) .. controls (8.22,9.74) and (2.18,7.75) .. (2.81,4.47) .. controls (2.99,4.47) and (4.45,0.99) .. (9.15,2.41) .. controls (14.71,3.99) and (17.77,0.30) .. (18.13,0.04) .. controls (18.65,-0.49) and (16.78,4.61) .. (12.83,6.90) .. controls (10.49,8.18) and (11.96,10.38) .. (12.12,11.15) .. controls (12.12,11.15) and (14.00,9.84) .. (15.36,11.85) .. controls (16.58,11.53) and (17.40,12.07) .. (18.46,11.69) .. controls (19.10,11.41) and (21.79,11.58) .. (20.79,13.08) .. controls (20.79,13.08) and (21.71,13.90) .. (21.80,13.99) .. controls (21.97,14.75) and (21.59,14.91) .. (21.47,15.12) .. controls (21.44,15.60) and (21.04,15.79) .. (20.55,15.44) .. controls (19.45,15.64) and (18.36,15.55) .. (17.83,15.59) .. controls (16.65,15.76) and (15.67,16.38) .. (15.67,16.38) .. controls (15.40,17.19) and (14.82,17.01) .. (14.09,17.32) .. controls (14.70,18.69) and (14.76,19.32) .. (15.50,21.32) .. controls (15.76,22.37) and (16.54,24.00) .. (16.15,24.00) -- cycle(7.83,16.74) .. controls (6.83,15.71) and (5.72,15.70) .. (4.05,15.42) .. controls (2.75,15.19) and (0.39,12.97) .. (0.02,10.68) .. controls (-0.02,10.07) and (-0.06,8.50) .. (0.45,7.18) .. controls (0.94,6.05) and (1.27,5.45) .. (2.29,4.85) .. controls (1.41,8.02) and (7.59,10.18) .. (8.55,13.80) -- (8.55,13.80) .. controls (7.73,15.00) and (7.80,15.64) .. (7.83,16.74) -- cycle;
  \\end{tikzpicture}
\\end{lrbox}

\\makeatletter
\\g@addto@macro\\tableofcontents{\\clearpage}
\\renewcommand\\maketitle{
  \\thispagestyle{empty}
  \\hyphenpenalty=10000 % hyphens look bad in titles
  \\renewcommand{\\baselinestretch}{1.1}
  \\let\\oldtoday\\today
  \\renewcommand{\\today}{\\LARGE\\number\\year\\\\\\large%
    \\ifcase \\month \\or Jan\\or Feb\\or Mar\\or Apr\\or May \\or Jun\\or Jul\\or Aug\\or Sep\\or Oct\\or Nov\\or Dec\\fi
    ~\\number\\day}
  \\begin{tikzpicture}[remember picture,overlay]
    %% Background Polygons %%
    \\foreach \\i in {2.5,...,22} % bottom left
    {\\node[rounded corners,black!3.5,draw,regular polygon,regular polygon sides=6, minimum size=\\i cm,ultra thick] at ($(current page.west)+(2.5,-4.2)$) {} ;}
    \\foreach \\i in {0.5,...,22} % top left
    {\\node[rounded corners,black!5,draw,regular polygon,regular polygon sides=6, minimum size=\\i cm,ultra thick] at ($(current page.north west)+(2.5,2)$) {} ;}
    \\node[rounded corners,fill=black!4,regular polygon,regular polygon sides=6, minimum size=5.5 cm,ultra thick] at ($(current page.north west)+(2.5,2)$) {};
    \\foreach \\i in {0.5,...,24} % top right
    {\\node[rounded corners,black!2,draw,regular polygon,regular polygon sides=6, minimum size=\\i cm,ultra thick] at ($(current page.north east)+(0,-8.5)$) {} ;}
    \\node[fill=black!3,rounded corners,regular polygon,regular polygon sides=6, minimum size=2.5 cm,ultra thick] at ($(current page.north east)+(0,-8.5)$) {};
    \\foreach \\i in {21,...,3} % bottom right
    {\\node[black!3,rounded corners,draw,regular polygon,regular polygon sides=6, minimum size=\\i cm,ultra thick] at ($(current page.south east)+(-1.5,0.75)$) {} ;}
    \\node[fill=black!3,rounded corners,regular polygon,regular polygon sides=6, minimum size=2 cm,ultra thick] at ($(current page.south east)+(-1.5,0.75)$) {};
    \\node[align=center, scale=1.4] at ($(current page.south east)+(-1.5,0.75)$) {\\usebox\\orgicon};
    %% Text %%
    \\node[left, align=right, black, text width=0.8\\paperwidth, minimum height=3cm, rounded corners,font=\\Huge\\bfseries] at ($(current page.north east)+(-2,-8.5)$)
    {\\@title};
    \\node[left, align=right, black, text width=0.8\\paperwidth, minimum height=2cm, rounded corners, font=\\Large] at ($(current page.north east)+(-2,-11.8)$)
    {\\scshape \\@author};
    \\renewcommand{\\baselinestretch}{0.75}
    \\node[align=center,rounded corners,fill=black!3,text=black,regular polygon,regular polygon sides=6, minimum size=2.5 cm,inner sep=0, font=\\Large\\bfseries ] at ($(current page.west)+(2.5,-4.2)$)
    {\\@date};
  \\end{tikzpicture}
  \\let\\today\\oldtoday
  \\clearpage}
\\makeatother
#+end_src

ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªä¸é”™çš„å°é¢é¡µï¼Œæˆ‘ä»¬åªéœ€è¦ä¸æ—¶ä½¿ç”¨å®ƒã€‚å°†æ­¤æ·»åŠ åˆ° =#+options= æ„Ÿè§‰
æœ€åˆé€‚ã€‚è®©å°é¢é€‰é¡¹æ¥å— auto ä½œä¸ºå€¼ï¼Œç„¶åæ ¹æ®å­—æ•°å†³å®šæ˜¯å¦åº”ä½¿ç”¨å°é¢ã€‚ç„¶åæˆ‘ä»¬åªæƒ³
æ’å…¥ä¸€ä¸ª LaTeX ç‰‡æ®µåœ¨å°é¢ä¸­æ¥è°ƒæ•´æ ‡é¢˜æ ¼å¼ã€‚

#+begin_src emacs-lisp :noweb no-export :noweb-prefix no
(defvar org-latex-cover-page 'auto
  "When t, use a cover page by default.
When auto, use a cover page when the document's wordcount exceeds
`org-latex-cover-page-wordcount-threshold'.
Set with #+option: coverpage:{yes,auto,no} in org buffers.")
(defvar org-latex-cover-page-wordcount-threshold 5000
  "Document word count at which a cover page will be used automatically.
This condition is applied when cover page option is set to auto.")
(defvar org-latex-subtitle-coverpage-format "\\\\\\bigskip\n\\LARGE\\mdseries\\itshape\\color{black!80} %s\\par"
  "Variant of `org-latex-subtitle-format' to use with the cover page.")
(defvar org-latex-cover-page-maketitle "
<<latex-cover-page>>
"
  "LaTeX preamble snippet that sets \\maketitle to produce a cover page.")

(eval '(cl-pushnew '(:latex-cover-page nil "coverpage" org-latex-cover-page)
                   (org-export-backend-options (org-export-get-backend 'latex))))

(defun org-latex-cover-page-p ()
  "Whether a cover page should be used when exporting this Org file."
  (pcase (or (car
              (delq nil
                    (mapcar
                     (lambda (opt-line)
                       (plist-get (org-export--parse-option-keyword opt-line 'latex) :latex-cover-page))
                     (cdar (org-collect-keywords '("OPTIONS"))))))
             org-latex-cover-page)
    ((or 't 'yes) t)
    ('auto (when (> (count-words (point-min) (point-max)) org-latex-cover-page-wordcount-threshold) t))
    (_ nil)))

(defadvice! org-latex-set-coverpage-subtitle-format-a (contents info)
  "Set the subtitle format when a cover page is being used."
  :before #'org-latex-template
  (when (org-latex-cover-page-p)
    (setf info (plist-put info :latex-subtitle-format org-latex-subtitle-coverpage-format))))

(add-to-list 'org-latex-feature-implementations '(cover-page :snippet org-latex-cover-page-maketitle :order 9) t)
(add-to-list 'org-latex-conditional-features '((org-latex-cover-page-p) . cover-page) t)
#+end_src

æˆ–è®¸ä¹‹åå¯ä»¥å†åŠ ä¸€äº›ä¸åŒçš„å°é¢ã€‚

**** æ›´å¥½çœ‹çš„ä»£ç å—

æ¥ä¸ªåºè¨€åŒºæ¨¡æ¿ï¼Œä¸»è¦é‡‡ç”¨ ~tcblisting~ ç”Ÿæˆä¸»é¢˜ box

#+name: latex-tcblisting-code-preamble
#+begin_src LaTeX
\\usepackage{accsupp}
\\usepackage[most,breakable,minted]{tcolorbox}
\\definecolor{solarized-light-background}{HTML}{FDF6E3}
\\definecolor{solarized-light-frame}{HTML}{EEE8D6}
\\definecolor{solarized-light-title}{HTML}{979797}
\\definecolor{solarized-light-lineno}{HTML}{237D99}
\\newcommand{\\SetFancyVerbLine}{
  \\renewcommand{\\theFancyVerbLine}{
    \\protect\\BeginAccSupp{ActualText={}}\\sffamily\\textcolor{solarized-light-lineno}{\\scriptsize\\oldstylenums{\\arabic{FancyVerbLine}}}\\protect\\EndAccSupp{}
  }
}
\\newenvironment{orglisting}[2][]{
  \\SetFancyVerbLine
  \\tcblisting{
    frame empty,
    enhanced jigsaw,
    drop fuzzy shadow,
    breakable,
    center,
    width=\\linewidth,
    bottom=1mm, top=1mm, left=6mm,
    fonttitle=\\bfseries,
    listing only,
    listing engine=minted,
    colback=solarized-light-background,
    colframe=solarized-light-frame,
    coltitle=solarized-light-title,
    minted style=solarized-light,
    minted language=#2,
    minted options={
      breaklines=t,
      breakbefore=.,
      samepage=nil,
      encoding=utf8,
      fontsize=\\small,
      mathescape=t,
      escapeinside=,
      autogobble=t,
      breakautoindent=t,
      tabsize=4,
      numbersep=2mm,
      % numbers=left,
      numberblanklines=t,
      firstline=1,
      firstnumber=1,
      % lastline=,
      showspaces=nil,
      space=\\textvisiblespace, %% only showspaces=true
      obeytabs=nil,
      showtabs=nil,
      #1
    },
  }
}{
  \\endtcblisting
}
#+end_src

è®¾ç½®ä¸€ä¸‹è‡ªå·±çš„ä»£ç æ¸²æŸ“æ–¹å¼
#+begin_src emacs-lisp :noweb-ref ox-latex-conf :noweb no-export :tangle no
(setq! org-latex-listings 'tcblisting
       org-latex-tcblisting-code-preamble "
<<latex-tcblisting-code-preamble>>
")
#+end_src

ä¿®æ”¹ä¸€ä¸‹å¯¼å‡ºä»£ç å—çš„è¡Œä¸º

#+begin_src emacs-lisp
(defadvice! org-latex-src-block-tcblisting (orig-fn src-block contents info)
  "Like `org-latex-src-block', but supporting an tcblisting backend"
  :around #'org-latex-src-block
  (if (eq 'tcblisting org-latex-src-block-backend)
      (ginshio/org-latex-scr-block src-block contents info)
    (funcall orig-fn src-block contents info)))

(defun ginshio/org-latex-src-block-getlang (language minted-langs)
  (if (not (string-equal-ignore-case language "fundamental"))
      (or (cadr (assq (intern language) minted-langs))
          (downcase language))
    "text"))

(defun ginshio/org-latex-scr-block (src-block contents info)
  (let* ((lang (org-element-property :language src-block))
         (attributes (org-export-read-attribute :attr_latex src-block))
         (float (plist-get attributes :float))
         (num-start (org-export-get-loc src-block info))
         (retain-labels (org-element-property :retain-labels src-block))
         (caption (org-element-property :caption src-block))
         (caption-above-p (org-latex--caption-above-p src-block info))
         (caption-str (org-latex--caption/label-string src-block info))
         (placement (or (org-unbracket-string "[" "]" (plist-get attributes :placement))
                        (plist-get info :latex-default-figure-position)))
         (float-env
          (cond
           ((string= "multicolumn" float)
            (format "\\begin{listing*}[%s]\n%s%%s\n%s\\end{listing*}"
                    placement
                    (if caption-above-p caption-str "")
                    (if caption-above-p "" caption-str)))
           (caption
            (format "\\begin{listing}[%s]\n%s%%s\n%s\\end{listing}"
                    placement
                    (if caption-above-p caption-str "")
                    (if caption-above-p "" caption-str)))
           ((string= "t" float)
            (concat (format "\\begin{listing}[%s]\n" placement)
                    "%s\n\\end{listing}"))
           (t "%s")))
         (options (plist-get info :latex-minted-options))
         (body
          (format
           "\\begin{orglisting}[%s]{%s}\n%s\\end{orglisting}"
           ;; Options.
           (concat
            (org-latex--make-option-string
             (if (or (not num-start) (assoc "linenos" options))
                 options
               (append
                `(("linenos")
                  ("firstnumber" ,(number-to-string (1+ num-start))))
                options)))
            (let ((local-options (plist-get attributes :options)))
              (and local-options (concat "," local-options))))
           ;; Language.
           (ginshio/org-latex-src-block-getlang lang (plist-get info :latex-minted-langs))
           ;; Source code.
           (let* ((code-info (org-export-unravel-code src-block))
                  (max-width
                   (apply 'max
                          (mapcar 'length
                                  (org-split-string (car code-info)
                                                    "\n")))))
             (org-export-format-code
              (car code-info)
              (lambda (loc _num ref)
                (concat
                 loc
                 (when ref
                   ;; Ensure references are flushed to the right,
                   ;; separated with 6 spaces from the widest line
                   ;; of code.
                   (concat (make-string (+ (- max-width (length loc)) 6)
                                        ?\s)
                           (format "(%s)" ref)))))
              nil (and retain-labels (cdr code-info)))))))
    ;; Return value.
    (format float-env body)))
#+end_src

å†…è”ä»£ç å—çš„è¡Œä¸ºç›¸å¯¹æ›´å¥½ä¿®æ”¹
#+begin_src emacs-lisp
(defadvice! org-latex-inline-src-block-tcblisting (orig-fn inline-src-block contents info)
  "Like `org-latex-inline-src-block', but supporting an tcblisting backend"
  :around #'org-latex-inline-src-block
  (if (eq 'tcblisting org-latex-src-block-backend)
      ;; (funcall orig-fn inline-src-block contents (plist-put info :latex-listings 'minted))
      (ginshio/org-latex-inline-src-block inline-src-block contents info)
    (funcall orig-fn inline-src-block contents info)))

(defun ginshio/org-latex-inline-src-block (inline-src-block _contents info)
  (let* ((code (org-element-property :value inline-src-block))
         (separator (org-latex--find-verb-separator code))
         (org-lang (org-element-property :language inline-src-block))
         (mint-lang (ginshio/org-latex-src-block-getlang lang (plist-get info :latex-minted-langs)))
         (options (org-latex--make-option-string
                   (plist-get info :latex-minted-options))))
    (format "\\mintinline%s{%s}{%s}"
            (if (string= options "") "" (format "[%s]" options))
            mint-lang code)))
#+end_src

æœ€ç»ˆå°†å…¶æ·»åŠ åˆ°æ™ºèƒ½åºè¨€ä¸­
#+begin_src emacs-lisp
(add-to-list 'org-latex-conditional-features '("^[ \t]*#\\+begin_src\\|^[ \t]*#\\+BEGIN_SRC\\|src_[A-Za-z]" . tcblisting-code-preamble) t)
(add-to-list 'org-latex-feature-implementations '(tcblisting-code-preamble :snippet org-latex-tcblisting-code-preamble :order 99) t)
#+end_src

æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä»£ç ä¸­çš„æ‰€æœ‰å¼•å·æœ‰é—®é¢˜ã€‚

**** ä½¿ verbatim ä¸ code ä¸åŒ

åŒºåˆ† =verbatim= å’Œ ~verb~

#+begin_src emacs-lisp
(setq! org-latex-text-markup-alist
       '((bold . "\\textbf{%s}")
         (code . protectedtexttt)
         (italic . "\\emph{%s}")
         (strike-through . "\\sout{%s}")
         (underline . "\\uline{%s}")
         (verbatim . verb)))
#+end_src

*** Pandoc å¯¼å‡º
:properties:
:CUSTOM_ID: org_export_pandoc
:header-args:emacs-lisp: :tangle no :noweb-ref ox-pandoc-conf
:end:

é¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ä¸€ä¸ªè¯­è¨€çš„å·´åˆ«å¡”ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ org-mode ä¸­è¿è¡Œæ‰€æœ‰ç¼–ç¨‹è¯­è¨€ï¼å½“ç„¶ï¼Œæˆ‘
ä»¬éœ€è¦å®šåˆ¶ä¸€äº›ä¸œè¥¿ã€‚

#+begin_src emacs-lisp :noweb no-export :noweb-ref org-export-conf :tangle no
(after! ox-pandoc
  <<ox-pandoc-conf>>
  )
#+end_src

**** GitHub Flavored Markdown

åœ¨ä½¿ç”¨ Pandoc è¿›è¡Œå¯¼å‡º gfm æ—¶ï¼Œé“¾æ¥ headline æ—¶é“¾æ¥ä¼šè¢«å¯¼å‡ºä¸ºæ•°å­—ã€‚å…·ä½“å‚è§
[[https://github.com/kawabata/ox-pandoc/issues/58][Issue #58]]ã€‚

#+begin_src emacs-lisp
(advice-add 'org-pandoc-link
            :around #'(lambda (fun link contents info)
                        (let* ((dest (when (string= (org-element-property :type link) "fuzzy")
                                       (org-export-resolve-fuzzy-link link info)))
                               (dest-type (when dest (org-element-type dest)))
                               (path (org-element-property :path link)))
                          (if (eq dest-type 'headline)
                              (format "[[#%s][%s]]" path path)
                            (funcall fun link contents info)))))
#+end_src

** LaTeX
:properties:
:CUSTOM_ID: LaTeX
:header-args:emacs-lisp: :tangle no :noweb-ref tex-conf
:end:

#+begin_src emacs-lisp :noweb no-export :tangle yes :noweb-ref nil
(setq! LaTeX-biblatex-use-Biber t)
(custom-set-variables '(LaTeX-section-label '(("part" . "part:")
                                              ("chapter" . "chap:")
                                              ("section" . "sec:")
                                              ("subsection" . "subsec:")
                                              ("subsubsection" . "subsubsec:")))
                      '(TeX-auto-local "auto")
                      '(TeX-command-extra-options "--shell-escape --interaction=nonstopmode"))
(after! latex
  (add-hook! latex-mode #'TeX-latex-mode)
  <<tex-conf>>
  )
#+end_src

*** ç¼–è¯‘

#+begin_src emacs-lisp
(setq! TeX-save-query nil
       TeX-show-compilation t
       LaTeX-clean-intermediate-suffixes (append TeX-clean-default-intermediate-suffixes
                                                 '("\\.acn" "\\.acr" "\\.alg" "\\.glg"
                                                   "\\.ist" "\\.listing" "\\.fdb_latexmk")))
(add-to-list 'TeX-command-list '("LatexMk (LuaLaTeX)" "LC_ALL=en_US.UTF-8 latexmk -pdf -lualatex -8bit %S%(mode) %(file-line-error) %(extraopts) %t" TeX-run-latexmk nil
                                 (plain-tex-mode latex-mode doctex-mode)
                                 :help "Run LatexMk (LuaLaTeX)"))
#+end_src

*** å¼•ç”¨

å¦‚æœ ~bib~ ä¸­æœ‰ä½ ä¸æƒ³è¦çš„æŸäº›å­—æ®µï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸‹æ–¹æ³•å»é™¤ (å¯¼è¨€åŒº)
#+begin_src latex :tangle no :noweb-ref none
\AtEveryBibitem{
  \clearfield{note}
  \ifentrytype{book}{
    \clearfield{url}
    \clearfield{isbn}
  }{}
  \ifentrytype{article}{
    \clearfield{url}
  }{}
  \ifentrytype{thesis}{
    \clearfield{url}
  }{}
}
#+end_src

*** è§†è§‰

å¢å¼ºä¸€ç‚¹ç‚¹è§†è§‰æ•ˆæœ
#+begin_src emacs-lisp
(setq TeX-fold-math-spec-list
      `(;; missing/better symbols
        ("â‰¤" ("le"))
        ("â‰¥" ("ge"))
        ("â‰ " ("ne"))
        ;; convenience shorts -- these don't work nicely ATM
        ;; ("â€¹" ("left"))
        ;; ("â€º" ("right"))
        ;; private macros
        ("â„" ("RR"))
        ("â„•" ("NN"))
        ("â„¤" ("ZZ"))
        ("â„š" ("QQ"))
        ("â„‚" ("CC"))
        ("â„™" ("PP"))
        ("â„" ("HH"))
        ("ğ”¼" ("EE"))
        ("ğ‘‘" ("dd"))
        ;; known commands
        ("" ("phantom"))
        (,(lambda (num den) (if (and (TeX-string-single-token-p num) (TeX-string-single-token-p den))
                                (concat num "ï¼" den)
                              (concat "âª" num "ï¼" den "â«"))) ("frac"))
        (,(lambda (arg) (concat "âˆš" (TeX-fold-parenthesize-as-necessary arg))) ("sqrt"))
        (,(lambda (arg) (concat "â­¡" (TeX-fold-parenthesize-as-necessary arg))) ("vec"))
        ("â€˜{1}â€™" ("text"))
        ;; private commands
        ("|{1}|" ("abs"))
        ("â€–{1}â€–" ("norm"))
        ("âŒŠ{1}âŒ‹" ("floor"))
        ("âŒˆ{1}âŒ‰" ("ceil"))
        ("âŒŠ{1}âŒ‰" ("round"))
        ("ğ‘‘{1}/ğ‘‘{2}" ("dv"))
        ("âˆ‚{1}/âˆ‚{2}" ("pdv"))
        ;; fancification
        ("{1}" ("mathrm"))
        (,(lambda (word) (string-offset-roman-chars 119743 word)) ("mathbf"))
        (,(lambda (word) (string-offset-roman-chars 119951 word)) ("mathcal"))
        (,(lambda (word) (string-offset-roman-chars 120003 word)) ("mathfrak"))
        (,(lambda (word) (string-offset-roman-chars 120055 word)) ("mathbb"))
        (,(lambda (word) (string-offset-roman-chars 120159 word)) ("mathsf"))
        (,(lambda (word) (string-offset-roman-chars 120367 word)) ("mathtt"))
        )
      TeX-fold-macro-spec-list
      '(
        ;; as the defaults
        ("[f]" ("footnote" "marginpar"))
        ("[c]" ("cite"))
        ("[l]" ("label"))
        ("[r]" ("ref" "pageref" "eqref"))
        ("[i]" ("index" "glossary"))
        ("..." ("dots"))
        ("{1}" ("emph" "textit" "textsl" "textmd" "textrm" "textsf" "texttt"
                "textbf" "textsc" "textup"))
        ;; tweaked defaults
        ("Â©" ("copyright"))
        ("Â®" ("textregistered"))
        ("â„¢"  ("texttrademark"))
        ("[1]:||â–º" ("item"))
        ("â¡â¡â€†{1}" ("part" "part*"))
        ("â¡â€†{1}" ("chapter" "chapter*"))
        ("Â§â€†{1}" ("section" "section*"))
        ("Â§Â§â€†{1}" ("subsection" "subsection*"))
        ("Â§Â§Â§â€†{1}" ("subsubsection" "subsubsection*"))
        ("Â¶â€†{1}" ("paragraph" "paragraph*"))
        ("Â¶Â¶â€†{1}" ("subparagraph" "subparagraph*"))
        ;; extra
        ("â¬–â€†{1}" ("begin"))
        ("â¬—â€†{1}" ("end"))
        ))

(defun string-offset-roman-chars (offset word)
  "Shift the codepoint of each character in WORD by OFFSET with an extra -6 shift if the letter is lowercase"
  (apply 'string
         (mapcar (lambda (c)
                   (string-offset-apply-roman-char-exceptions
                    (+ (if (>= c 97) (- c 6) c) offset)))
                 word)))

(defvar string-offset-roman-char-exceptions
  '(;; lowercase serif
    (119892 .  8462) ; â„
    ;; lowercase caligraphic
    (119994 . 8495) ; â„¯
    (119996 . 8458) ; â„Š
    (120004 . 8500) ; â„´
    ;; caligraphic
    (119965 . 8492) ; â„¬
    (119968 . 8496) ; â„°
    (119969 . 8497) ; â„±
    (119971 . 8459) ; â„‹
    (119972 . 8464) ; â„
    (119975 . 8466) ; â„’
    (119976 . 8499) ; â„³
    (119981 . 8475) ; â„›
    ;; fraktur
    (120070 . 8493) ; â„­
    (120075 . 8460) ; â„Œ
    (120076 . 8465) ; â„‘
    (120085 . 8476) ; â„œ
    (120092 . 8488) ; â„¨
    ;; blackboard
    (120122 . 8450) ; â„‚
    (120127 . 8461) ; â„
    (120133 . 8469) ; â„•
    (120135 . 8473) ; â„™
    (120136 . 8474) ; â„š
    (120137 . 8477) ; â„
    (120145 . 8484) ; â„¤
    )
  "An alist of deceptive codepoints, and then where the glyph actually resides.")

(defun string-offset-apply-roman-char-exceptions (char)
  "Sometimes the codepoint doesn't contain the char you expect.
Such special cases should be remapped to another value, as given in `string-offset-roman-char-exceptions'."
  (if (assoc char string-offset-roman-char-exceptions)
      (cdr (assoc char string-offset-roman-char-exceptions))
    char))

(defun TeX-fold-parenthesize-as-necessary (tokens &optional suppress-left suppress-right)
  "Add âª â« parenthesis as if multiple LaTeX tokens appear to be present"
  (if (TeX-string-single-token-p tokens) tokens
    (concat (if suppress-left "" "âª")
            tokens
            (if suppress-right "" "â«"))))

(defun TeX-string-single-token-p (teststring)
  "Return t if TESTSTRING appears to be a single token, nil otherwise"
  (if (string-match-p "^\\\\?\\w+$" teststring) t nil))
#+end_src

ä¸€äº› local å¿«æ·é”®ä½¿ç”Ÿæ´»æ›´è½»æ¾
#+begin_src emacs-lisp
(map!
 :map LaTeX-mode-map
 :ei [C-return] #'LaTeX-insert-item)
(setq TeX-electric-math '("\\(" . ""))
#+end_src

å½“ç„¶æ•°å­¦ç•Œå®šç¬¦ä¸éœ€è¦å¼ºè°ƒ
#+begin_src emacs-lisp
;; Making \( \) less visible
(defface unimportant-latex-face
  '((t :inherit font-lock-comment-face :weight extra-light))
  "Face used to make \\(\\), \\[\\] less visible."
  :group 'LaTeX-math)

(font-lock-add-keywords
 'latex-mode
 `(("\\\\[]()[]" 0 'unimportant-latex-face prepend))
 'end)

;; (font-lock-add-keywords
;;  'latex-mode
;;  '(("\\\\[[:word:]]+" 0 'font-lock-keyword-face prepend))
;;  'end)
#+end_src

*** CDLaTeX

é»˜è®¤æƒ…å†µä¸‹ï¼Œç¬¦å·ä¿®æ”¹éå¸¸å¥½ç”¨ï¼Œä½†å¯ä»¥å……å®æ›´å¤šç¬¦å·ã€‚è®©æˆ‘ä»¬å°†å‰ç¼€æ›´æ”¹ä¸ºåŒæ ·å¾ˆå°‘ä½¿ç”¨ä½†æ›´æ–¹ä¾¿çš„é”®ï¼Œä¾‹å¦‚ =;=â€‹ã€‚
#+begin_src emacs-lisp
(after! cdlatex
  (setq cdlatex-env-alist
        '(("bmatrix" "\\begin{bmatrix}\n?\n\\end{bmatrix}" nil)
          ("equation*" "\\begin{equation*}\n?\n\\end{equation*}" nil)))
  (setq ;; cdlatex-math-symbol-prefix ?\; ;; doesn't work at the moment :(
   cdlatex-math-symbol-alist
   '( ;; adding missing functions to 3rd level symbols
     (?_    ("\\downarrow"  ""           "\\inf"))
     (?2    ("^2"           "\\sqrt{?}"     ""     ))
     (?3    ("^3"           "\\sqrt[3]{?}"  ""     ))
     (?^    ("\\uparrow"    ""           "\\sup"))
     (?k    ("\\kappa"      ""           "\\ker"))
     (?m    ("\\mu"         ""           "\\lim"))
     (?c    (""             "\\circ"     "\\cos"))
     (?d    ("\\delta"      "\\partial"  "\\dim"))
     (?D    ("\\Delta"      "\\nabla"    "\\deg"))
     ;; no idea why \Phi isnt on 'F' in first place, \phi is on 'f'.
     (?F    ("\\Phi"))
     ;; now just convenience
     (?.    ("\\cdot" "\\dots"))
     (?:    ("\\vdots" "\\ddots"))
     (?*    ("\\times" "\\star" "\\ast")))
   cdlatex-math-modify-alist
   '( ;; my own stuff
     (?B    "\\mathbb"        nil          t    nil  nil)
     (?a    "\\abs"           nil          t    nil  nil))))
#+end_src

*** SyncTeX

#+begin_src emacs-lisp
(setq!
 ;;; %o: TeX-output-extension; %n: TeX-current-line; %b: TeX-current-file-name-master-relative
 TeX-view-program-list '(("Okular" "okular --unique %o#src:%n%(dir)./%b"))
 TeX-view-program-selection '((output-pdf "Okular") (output-dvi "Okular")))
#+end_src

** Markdown

Doom é»˜è®¤çš„ Markdown æ˜¯ ~GFM~ (GitHub Flavored Markdown)ï¼Œä¸è¿‡æœ‰äº† =Emacs= å’Œ
=Org Mode= è°è¿˜ç”¨ =Markdown= ã€‚ä½†æ˜¯ ~toc-org-mode~ ä¾ç„¶å¯ä»¥ä½¿ç”¨ã€‚

å¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ–¹å¼æ”¯æŒ Markdownã€‚
#+begin_src fundamental
# TOC         <!-- :TOC: -->
#+end_src

** C/C++

tcc ä¹Ÿæ˜¯ C++
#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist '("\\.tcc\\'" . c++-mode))
#+end_src

å¦‚æœå¼€å¯äº† format é‚£å¯ä»¥ä½¿ç”¨ clang-format è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç 
#+begin_src emacs-lisp :tangle no
(set-formatter! 'clang-format
  '("clang-format" "--Wno-error=unknown" ("-assume-filename=%S" (or buffer-file-name mode-result "")))
  :modes '(c-mode c++-mode))
#+end_src

è®¾ç½® gud-gdb æ˜¾ç¤ºå½“å‰è¡Œ
#+begin_src emacs-lisp
(after! gud-gdb
  ;;; Keep the current line in sync with the point and in the center of the
  ;;; buffer. Otherwise the current line may disappear from the buffer as you step
  ;;; into the code. I don't know why this is not the default.
  (advice-add gud-display-line (after gud-display-line-centered activate)
    "Center the current line in the source code window"
    (when (and gud-overlay-arrow-position gdb-source-window)
      (with-selected-window gdb-source-window
        ; (marker-buffer gud-overlay-arrow-position)
        (save-restriction
          ;; Compiler-happy equivalent to (goto-line (ad-get-arg 1))
          (goto-char (point-min))
          (forward-line (1- (ad-get-arg 1)))
          (recenter))))))
#+end_src

** LLVM

å…ˆæŠŠéœ€è¦çš„åŒ…ä¸‹ä¸‹ä¾†ï¼Œè¿™äº›ä¸œè¥¿å°±åœ¨ llvm çš„ä»“åº“é‡Œã€‚

#+begin_src emacs-lisp :tangle packages.el
(package! llvm-mir-mode
  :recipe `(:local-repo ,doom-user-dir
            :files ("modules/llvm/llvm-mir-mode.el")))
(package! llvm-mode
  :recipe `(:local-repo ,doom-user-dir
            :files ("modules/llvm/llvm-mode.el")))
(package! tablegen-mode
  :recipe `(:local-repo ,doom-user-dir
            :files ("modules/llvm/tablegen-mode.el")))
#+end_src

åˆ«å¿˜äº†è®© emacs å¯ä»¥è®¤è¯† LLVM çš„æ–‡ä»¶ã€‚
#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist '("\\.ll\\'" . llvm-mode))
(add-to-list 'auto-mode-alist '("\\.lgc\\'" . llvm-mode))  ; https://github.com/GPUOpen-Drivers/llpc/tree/dev/lgc
(add-to-list 'auto-mode-alist '("\\.td\\'" . tablegen-mode))
#+end_src


** GLSL

ä¼¼ä¹è¿™ä»½é…ç½®å·²ç»æ”¯æŒ glsl äº†ï¼Œé‚£å°±æŠŠç›¸å…³æ–‡ä»¶éƒ½æ ‡è®°ä¸º glslï¼
#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist '("\\.tesc\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.tese\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.comp\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.mesh\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.task\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rgen\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rint\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rahit\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rchit\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rmiss\\'" . glsl-mode))
(add-to-list 'auto-mode-alist '("\\.rcall\\'" . glsl-mode))
#+end_src

** Workaround

With Emacs 29.4

#+begin_src emacs-lisp
(when (and (= emacs-major-version 29) (= emacs-minor-version 4))
  (after! auctex ; See <https://github.com/minad/vertico/discussions/475>
    (fmakunbound 'ConTeXt-mode)))
#+end_src



* å‚è€ƒé…ç½®

 + [[https://tecosaur.github.io/emacs-config/config.html][tecosaur - Doom Emacs Configuration]]
 + [[https://www.hugchange.life/posts/202401_core_emacs_config.html][metaescape - ä¸ªäºº Emacs æ ¸å¿ƒé…ç½®]]
